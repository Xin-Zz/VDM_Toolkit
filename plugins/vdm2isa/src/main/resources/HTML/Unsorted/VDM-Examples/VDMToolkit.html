<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>Theory VDMToolkit</title>
</head>


<body>
<div class="head">
<h1>Theory VDMToolkit</h1>
</div>

<pre class="source"><span class="comment1">(*
  Title : VDM mathematical toolkit, Sep 2021
  Author: Leo Freitas
*)</span>
<span class="keyword1"><span class="command">theory</span></span> VDMToolkit
  <span class="keyword2"><span class="keyword">imports</span></span> 
    <span class="comment1">‚Äï ‚Äπ Include real fields, list and option types ordering ‚Ä∫</span>
    <span class="quoted">"<a href="../../HOL/HOL/Complex_Main.html">Complex_Main</a>"</span>
<span class="comment1">(*    VDMEisbach*)</span>
    <span class="quoted">"<a href="../../HOL/HOL-Library/List_Lexorder.html">HOL-Library.List_Lexorder</a>"</span>
    <span class="quoted">"<a href="../../HOL/HOL-Library/Option_ord.html">HOL-Library.Option_ord</a>"</span>
    <span class="quoted">"<a href="../../HOL/HOL-Library/LaTeXsugar.html">HOL-Library.LaTeXsugar</a>"</span>
    <span class="quoted">"<a href="../../HOL/HOL-Library/While_Combinator.html">HOL-Library.While_Combinator</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(*****************************************************************)</span>      
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‚Äπ Basic types ‚Ä∫</span></span>  

<span class="keyword1"><span class="command">type_notation</span></span> bool <span class="main">(</span><span class="quoted">"<span class="keyword1">ùîπ</span>"</span><span class="main">)</span>
<span class="keyword1"><span class="command">type_notation</span></span> nat <span class="main">(</span><span class="quoted">"<span class="keyword1">‚Ñï</span>"</span><span class="main">)</span>
<span class="keyword1"><span class="command">type_notation</span></span> int <span class="main">(</span><span class="quoted">"<span class="keyword1">‚Ñ§</span>"</span><span class="main">)</span>
<span class="keyword1"><span class="command">type_notation</span></span> rat <span class="main">(</span><span class="quoted">"<span class="keyword1">‚Ñö</span>"</span><span class="main">)</span>
<span class="keyword1"><span class="command">type_notation</span></span> real <span class="main">(</span><span class="quoted">"<span class="keyword1">‚Ñù</span>"</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπVDM numeric expressions have a series of implicit type widening rules. For 
      example, <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="main"><span class="main">(</span></span><span class="numeral"><span class="numeral">4</span></span><span class="main"><span class="main">::</span></span><span class="main"><span class="main">‚Ñï</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">-</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">x</span></span><span class="main"><span class="main">::</span></span><span class="main"><span class="main">‚Ñï</span></span><span class="main"><span class="main">)</span></span>‚Ä∫</span></span></span></span> could lead to an integer <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="main"><span class="main">-</span></span><span class="free"><span class="free">y</span></span>‚Ä∫</span></span></span></span> result, despite 
      all parameters involved being <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="main"><span class="main">‚Ñï</span></span>‚Ä∫</span></span></span></span>, whereas in HOL, the result is always a <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="main"><span class="main">‚Ñï</span></span>‚Ä∫</span></span></span></span> 
      ultimately equal to<span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="main"><span class="main">0</span></span>‚Ä∫</span></span></span></span>.

      Therefore, we take the view of the widest (compatible) type to use in the translation,
      where type widening to <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="main"><span class="main">‚Ñö</span></span>‚Ä∫</span></span></span></span> or <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="main"><span class="main">‚Ñù</span></span>‚Ä∫</span></span></span></span> is dealt with through Isabelle's type coercions.‚Ä∫</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> VDMNat  <span class="main">=</span> <span class="quoted"><span class="main">‚Ñ§</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> VDMNat1 <span class="main">=</span> <span class="quoted"><span class="main">‚Ñ§</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> VDMInt  <span class="main">=</span> <span class="quoted"><span class="main">‚Ñ§</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> VDMRat  <span class="main">=</span> <span class="quoted"><span class="main">‚Ñö</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> VDMReal <span class="main">=</span> <span class="quoted"><span class="main">‚Ñù</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> VDMChar <span class="main">=</span> <span class="quoted">char</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπMoreover, VDM type invariant checks have to be made explicit in VDM. That is possible either 
     through subtyping, which will require substantial proof-engineering machinery; or through explicit
     type invariant predicates. We choose the later for all VDM types.‚Ä∫</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">inv_VDMNat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">‚Ñ§</span> <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="comment1">(*&lt;*)</span> <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="comment1">(*&gt;*)</span> 
  <span class="quoted"><span class="quoted">"<span class="free">inv_VDMNat</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">‚â°</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">‚â•</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">inv_VDMNat1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">‚Ñ§</span> <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="comment1">(*&lt;*)</span><span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="comment1">(*&gt;*)</span> 
  <span class="quoted"><span class="quoted">"<span class="free">inv_VDMNat1</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">‚â°</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπBottom invariant check is that value is not undefined.‚Ä∫</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">inv_True</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">inv_True</span> <span class="main">‚â°</span> <span class="main">Œª</span> <span class="bound">x</span> <span class="main">.</span> True"</span></span>
  <span class="comment1">(* Œª x . x ‚â† undefined *)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted">"<span class="entity">inv_bool</span>"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">ùîπ</span> <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="comment1">(*&lt;*)</span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="comment1">(*&gt;*)</span> 
  <span class="quoted"><span class="quoted">"<span class="free">inv_bool</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">‚â°</span> inv_True <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">inv_VDMChar</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"VDMChar <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="comment1">(*&lt;*)</span> <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="comment1">(*&gt;*)</span> 
  <span class="quoted"><span class="quoted">"<span class="free">inv_VDMChar</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">‚â°</span> inv_True <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">inv_VDMInt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">‚Ñ§</span> <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="comment1">(*&lt;*)</span> <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="comment1">(*&gt;*)</span> 
  <span class="quoted"><span class="quoted">"<span class="free">inv_VDMInt</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">‚â°</span> inv_True <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">inv_VDMReal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">‚Ñù</span> <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="comment1">(*&lt;*)</span> <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="comment1">(*&gt;*)</span> 
  <span class="quoted"><span class="quoted">"<span class="free">inv_VDMReal</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">‚â°</span> inv_True <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">inv_VDMRat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">‚Ñö</span> <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="comment1">(*&lt;*)</span> <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="comment1">(*&gt;*)</span> 
  <span class="quoted"><span class="quoted">"<span class="free">inv_VDMRat</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">‚â°</span> inv_True <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="comment1">(*
lemma l_inv_True_undefined[simp]: "¬¨ inv_True undefined" unfolding inv_True_def by simp
lemma l_inv_bool_undefined[simp]: "¬¨ inv_bool undefined" unfolding inv_bool_def by simp

lemma l_inv_True_True[simp]: "r ‚â† undefined ‚üπ inv_True r" 
  by (simp add: inv_True_def)  
*)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_inv_True_True<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inv_True <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inv_True_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπIn general, VDM narrow expressions are tricky, given they can downcast types according 
  to the user-specified type of interest. In particular, at least for <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="main"><span class="main">‚Ñù</span></span>‚Ä∫</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="main"><span class="main">‚Ñö</span></span>‚Ä∫</span></span></span></span> 
  (<span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="free"><span class="free">floor_ceiling</span></span>‚Ä∫</span></span></span></span> type class), type narrowing to <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚ÄπVDMInt‚Ä∫</span></span></span></span> is fine‚Ä∫</span></span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">vdm_narrow_real</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>floor_ceiling<span class="main">)</span> <span class="main">‚áí</span> VDMInt"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">vdm_narrow_real</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">‚â°</span> <span class="main">‚åä</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">‚åã</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">vdm_div</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"VDMInt <span class="main">‚áí</span> VDMInt <span class="main">‚áí</span> VDMInt"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">vdmdiv</span>"</span> 70<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span> <span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1"><span class="free">vdmdiv</span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">‚â°</span> 
    <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">/</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">then</span>
       <span class="main">-</span><span class="main">‚åä</span><span class="main">¬¶</span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">/</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">¬¶</span><span class="main">‚åã</span>
    <span class="keyword1">else</span>  
       <span class="main">‚åä</span><span class="main">¬¶</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">/</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">¬¶</span><span class="main">‚åã</span><span class="main">)</span>"</span></span>  

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">pre_vdm_div</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"VDMInt <span class="main">‚áí</span> VDMInt <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pre_vdm_div</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">‚â°</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">‚â†</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">post_vdm_div</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"VDMInt <span class="main">‚áí</span> VDMInt <span class="main">‚áí</span> VDMInt <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">post_vdm_div</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">RESULT</span></span></span> <span class="main">‚â°</span> 
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">‚â•</span> <span class="main">0</span> <span class="main">‚àß</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">‚â•</span> <span class="main">0</span> <span class="main">‚ü∂</span> <span class="free"><span class="bound"><span class="entity">RESULT</span></span></span> <span class="main">‚â•</span> <span class="main">0</span><span class="main">)</span> <span class="main">‚àß</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">‚àß</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">‚ü∂</span> <span class="free"><span class="bound"><span class="entity">RESULT</span></span></span> <span class="main">‚â•</span> <span class="main">0</span><span class="main">)</span> <span class="main">‚àß</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">‚àß</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">‚ü∂</span> <span class="free"><span class="bound"><span class="entity">RESULT</span></span></span> <span class="main">‚â§</span> <span class="main">0</span><span class="main">)</span> <span class="main">‚àß</span>
    <span class="main">(</span><span class="main">0</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">‚àß</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">‚ü∂</span> <span class="free"><span class="bound"><span class="entity">RESULT</span></span></span> <span class="main">‚â§</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="comment1">(* Could perhaps strengthen the &lt; 0 case for when 1 &lt; x? *)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπVDM has div and mod but also rem for remainder. This is treated 
differently depending on whether the values involved have different sign.
For now, we add these equivalences below, but might have to pay price in proof
later. To illustrate this difference consider the result of 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">lemma</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main"><span class="main">-</span></span><span class="numeral"><span class="numeral">7</span></span> <span class="keyword1"><span class="keyword1">div</span></span> <span class="main"><span class="main">(</span></span><span class="numeral"><span class="numeral">3</span></span><span class="main"><span class="main">::</span></span><span class="main"><span class="main">‚Ñ§</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">-</span></span><span class="numeral"><span class="numeral">3</span></span>‚Ä∫</span></span> <span class="keyword1"><span class="keyword"><span class="keyword1"><span class="keyword">by</span></span></span></span> <span class="operator"><span class="operator">simp</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> versus 
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">lemma</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main"><span class="main">-</span></span><span class="numeral"><span class="numeral">7</span></span> <span class="keyword1"><span class="keyword1">vdmdiv</span></span> <span class="main"><span class="main">(</span></span><span class="numeral"><span class="numeral">3</span></span><span class="main"><span class="main">::</span></span><span class="main"><span class="main">‚Ñ§</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">-</span></span><span class="numeral"><span class="numeral">2</span></span>‚Ä∫</span></span> <span class="keyword1"><span class="keyword"><span class="keyword1"><span class="keyword">by</span></span></span></span> <span class="main"><span class="main">(</span></span><span class="operator"><span class="operator">simp</span></span> <span class="quasi_keyword"><span class="quasi_keyword">add</span></span><span class="main"><span class="main">:</span></span> vdm_div_def<span class="main"><span class="main">)</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">vdm_mod</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"VDMInt <span class="main">‚áí</span> VDMInt <span class="main">‚áí</span> VDMInt"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">vdmmod</span>"</span> 70<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span> <span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1"><span class="free">vdmmod</span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">‚â°</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">*</span> <span class="main">‚åä</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">/</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">‚åã</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">pre_vdm_mod</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"VDMInt <span class="main">‚áí</span> VDMInt <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pre_vdm_mod</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">‚â°</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">‚â†</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">post_vdm_mod</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"VDMInt <span class="main">‚áí</span> VDMInt <span class="main">‚áí</span> VDMInt <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">post_vdm_mod</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">RESULT</span></span></span> <span class="main">‚â°</span> 
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">‚â•</span> <span class="main">0</span> <span class="main">‚ü∂</span> <span class="free"><span class="bound"><span class="entity">RESULT</span></span></span> <span class="main">‚â•</span> <span class="main">0</span><span class="main">)</span> <span class="main">‚àß</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">‚ü∂</span> <span class="free"><span class="bound"><span class="entity">RESULT</span></span></span> <span class="main">‚â§</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">vdm_rem</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"VDMInt <span class="main">‚áí</span> VDMInt <span class="main">‚áí</span> VDMInt"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">vdmrem</span>"</span> 70<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span> <span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1"><span class="free">vdmrem</span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">‚â°</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">*</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">vdmdiv</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">pre_vdm_rem</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"VDMInt <span class="main">‚áí</span> VDMInt <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pre_vdm_rem</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">‚â°</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">‚â†</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">post_vdm_rem</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"VDMInt <span class="main">‚áí</span> VDMInt <span class="main">‚áí</span> VDMInt <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">post_vdm_rem</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">RESULT</span></span></span> <span class="main">‚â°</span> 
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">‚â•</span> <span class="main">0</span> <span class="main">‚ü∂</span> <span class="free"><span class="bound"><span class="entity">RESULT</span></span></span> <span class="main">‚â•</span> <span class="main">0</span><span class="main">)</span> <span class="main">‚àß</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">‚ü∂</span> <span class="free"><span class="bound"><span class="entity">RESULT</span></span></span> <span class="main">‚â§</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπVDM has the power (\verb'**') operator for numbers, which is <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚ÄπTranscendental.powr‚Ä∫</span></span></span></span> in Issable. 
   Like in VDM, it accepts non-integer exponents. Isabelle have <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="free"><span class="free">x</span></span><span class="main"><span class="main">^</span></span><span class="free"><span class="free">y</span></span>‚Ä∫</span></span></span></span> for exponent <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="free"><span class="free">y</span></span>‚Ä∫</span></span></span></span> of type <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="main"><span class="main">‚Ñï</span></span>‚Ä∫</span></span></span></span>, 
   and <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="free"><span class="free">x</span></span> <span class="keyword1"><span class="keyword1">powr</span></span> <span class="free"><span class="free">y</span></span>‚Ä∫</span></span></span></span> for exponent <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="free"><span class="free">y</span></span>‚Ä∫</span></span></span></span> that is a subset of the <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="main"><span class="main">‚Ñù</span></span>‚Ä∫</span></span></span></span> (i.e. real normed algebra natural logarithms; 
  or natural logarithm exponentiation). We take the latter for translation.‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">vdm_pow</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>ln <span class="main">‚áí</span> <span class="tfree">'a</span><span class="main">::</span>ln <span class="main">‚áí</span> <span class="tfree">'a</span><span class="main">::</span>ln"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">vdmpow</span>"</span> 80<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>                     
  <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1"><span class="free">vdmpow</span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">‚â°</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">powr</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">pre_vdm_pow</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>ln <span class="main">‚áí</span> <span class="tfree">'a</span><span class="main">::</span>ln <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pre_vdm_pow</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">‚â°</span> True"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">post_vdm_pow</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>ln <span class="main">‚áí</span> <span class="tfree">'a</span><span class="main">::</span>ln <span class="main">‚áí</span> <span class="tfree">'a</span><span class="main">::</span>ln <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">post_vdm_pow</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">RESULT</span></span></span> <span class="main">‚â°</span> True"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπFor VDM floor and abs, we use Isabelle's. Note that in VDM abs of <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="main"><span class="main">‚Ñ§</span></span>‚Ä∫</span></span></span></span>  
will return <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚ÄπVDMNat‚Ä∫</span></span></span></span>, as the underlying type invariant might require further filtering 
on the function's results. ‚Ä∫</span></span>

<span class="keyword1"><span class="command">find_theorems</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">(</span><span class="main">_</span><span class="main">::</span><span class="tfree">'a</span> list list<span class="main">)</span>"</span></span> name<span class="main">:</span>concat
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">vdm_floor</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"VDMReal <span class="main">‚áí</span> VDMNat"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">vdm_floor</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">‚â°</span> <span class="main">‚åä</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">‚åã</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπThe postcondition for flooring, takes the axiom defined in the archimedian field type class‚Ä∫</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">post_vdm_floor</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"VDMReal <span class="main">‚áí</span> VDMNat <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">post_vdm_floor</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">RESULT</span></span></span> <span class="main">‚â°</span> 
    of_int <span class="free"><span class="bound"><span class="entity">RESULT</span></span></span> <span class="main">‚â§</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">‚àß</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> of_int <span class="main">(</span><span class="free"><span class="bound"><span class="entity">RESULT</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>    

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">vdm_abs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>zero<span class="main">,</span>abs<span class="main">,</span>ord<span class="main">}</span><span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>zero<span class="main">,</span>abs<span class="main">,</span>ord<span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">vdm_abs</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">‚â°</span> <span class="main">¬¶</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">¬¶</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπAbsolute postcondition does not use <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπinv_VDMNat‚Ä∫</span></span></span></span> because the result could also be of type <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="main"><span class="main">‚Ñù</span></span>‚Ä∫</span></span></span></span>.‚Ä∫</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">post_vdm_abs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>zero<span class="main">,</span>abs<span class="main">,</span>ord<span class="main">}</span><span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>zero<span class="main">,</span>abs<span class="main">,</span>ord<span class="main">}</span><span class="main">)</span> <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">post_vdm_abs</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">RESULT</span></span></span> <span class="main">‚â°</span> <span class="free"><span class="bound"><span class="entity">RESULT</span></span></span> <span class="main">‚â•</span> <span class="main">0</span>"</span></span> <span class="comment1">(*inv_VDMNat RESULT"*)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπFor equally signed  operands of VDM's div/mod, we can get back to Isabelle's version of the operators, 
  which will give access to various lemmas useful in proofs. So, if possible, automatically jump to the Isabelle versions.‚Ä∫</span></span>
<span class="keyword1"><span class="command">lemma</span></span> vdmdiv_div_ge0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">‚â§</span> <span class="free">x</span> <span class="main">‚üπ</span> <span class="main">0</span> <span class="main">‚â§</span> <span class="free">y</span> <span class="main">‚üπ</span> <span class="free">x</span> <span class="keyword1">vdmdiv</span> <span class="free">y</span> <span class="main">=</span> <span class="free">x</span> <span class="keyword1">div</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> vdm_div_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">y</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> divide_less_0_iff floor_divide_of_int_eq floor_less_zero floor_of_int floor_of_nat le_less_trans less_irrefl of_int_of_nat_eq of_nat_less_0_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> vdmdiv_div_le0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">‚â§</span> <span class="main">0</span> <span class="main">‚üπ</span> <span class="free">y</span> <span class="main">‚â§</span> <span class="main">0</span> <span class="main">‚üπ</span> <span class="free">x</span> <span class="keyword1">vdmdiv</span> <span class="free">y</span> <span class="main">=</span> <span class="free">x</span> <span class="keyword1">div</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> vdm_div_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">y</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> divide_less_0_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> floor_divide_of_int_eq minus_add_distrib minus_divide_right of_int_1 of_int_add of_int_minus of_int_of_nat_eq uminus_add_conv_diff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> vdmmod_mod<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">vdmmod</span> <span class="free">y</span> <span class="main">=</span> <span class="free">x</span> <span class="keyword1">mod</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> vdm_mod_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">y</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> floor_divide_of_int_eq minus_mult_div_eq_mod of_int_of_nat_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> ccfv_threshold<span class="main"><span class="main">)</span></span> floor_divide_of_int_eq minus_div_mult_eq_mod mult.commute of_int_diff of_int_eq_1_iff of_int_minus of_int_of_nat_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_vdm_div_fsb<span class="main">:</span> <span class="quoted"><span class="quoted">"pre_vdm_div <span class="free">x</span> <span class="free">y</span> <span class="main">‚üπ</span> post_vdm_div <span class="free">x</span> <span class="free">y</span> <span class="main">(</span><span class="free">x</span> <span class="keyword1">vdmdiv</span> <span class="free">y</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> pre_vdm_div_def post_vdm_div_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">safe</span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> div_int_pos_iff vdmdiv_div_ge0 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">using</span></span> vdm_div_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">)</span></span> divide_neg_neg floor_less_iff of_int_0_less_iff of_int_minus<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> vdm_div_def <span class="keyword1"><span class="command">using</span></span> divide_less_0_iff <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command">using</span></span> vdm_div_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
<span class="keyword1"><span class="command">lemma</span></span> l_vdm_mod_fsb<span class="main">:</span> <span class="quoted"><span class="quoted">"pre_vdm_mod <span class="free">x</span> <span class="free">y</span> <span class="main">‚üπ</span> post_vdm_mod <span class="free">x</span> <span class="free">y</span> <span class="main">(</span><span class="free">x</span> <span class="keyword1">vdmmod</span> <span class="free">y</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> pre_vdm_mod_def post_vdm_mod_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vdm_mod_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> l_vdm_rem_fsb<span class="main">:</span> <span class="quoted"><span class="quoted">"pre_vdm_rem <span class="free">x</span> <span class="free">y</span> <span class="main">‚üπ</span> post_vdm_rem <span class="free">x</span> <span class="free">y</span> <span class="main">(</span><span class="free">x</span> <span class="keyword1">vdmrem</span> <span class="free">y</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> pre_vdm_rem_def post_vdm_rem_def vdm_rem_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">‚â•</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Euclidean_Division.pos_mod_sign add.commute add.left_neutral add_mono_thms_linordered_semiring<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> div_mult_mod_eq le_less mult.commute<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">‚â§</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> div_mod_decomp_int group_cancel.rule0 le_add_same_cancel1 le_less mult.commute neg_mod_sign not_le<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> vdm_div_def
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">,</span></span> ccfv_SIG<span class="main"><span class="main">)</span></span> divide_minus_left floor_divide_lower floor_less_iff floor_uminus_of_int mult.commute of_int_mult<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> divide_neg_pos<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">)</span></span> ceiling_def ceiling_divide_eq_div minus_mod_eq_mult_div neg_mod_sign<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> divide_pos_neg <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚ÄπVDM tokens‚Ä∫</span></span>

<span class="keyword1"><span class="command">text</span></span> 
<span class="quoted"><span class="plain_text">‚ÄπVDM tokens are like a record with a parametric type (i.e. you can 
have anything inside a \verb'mk_token(x)' expression, akin to a VDM record
 \verb'Token :: token : ?', where \verb'?' refers to \verb'vdmj' wildcard type. 
Isabelle does not allow parametric records, hence we use datatypes instead. 

This will impose the restriction on token variables during translation: they will always 
have to be of the same inner type; whereas for token constants, then any type is acceptable. ‚Ä∫</span></span>
<span class="comment1">(* types T = token; values x: T = mk_token("ABC"); y: T = mk_token(10); --wrong type inference for 'a
   values z: token = mk_token("ABC"); w: token = mk_token(10); -- okay given no specific type synonym for 'a *)</span>
<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> VDMToken <span class="main">=</span> Token <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">inv_VDMToken</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> VDMToken <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inv_VDMToken</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">‚â°</span> inv_True <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">inv_VDMToken'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áí</span> <span class="main">ùîπ</span><span class="main">)</span> <span class="main">‚áí</span> <span class="tfree">'a</span> VDMToken <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inv_VDMToken'</span> <span class="free"><span class="bound"><span class="entity">inv_T</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">‚â°</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span> Token <span class="bound">a</span> <span class="main">‚áí</span> <span class="free"><span class="bound"><span class="entity">inv_T</span></span></span> <span class="bound">a</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπIsabelle lemmas definitions are issues for all the inner calls and related definitions used
      within given definitions. This allows for a laywered unfolding and simplification of VDM terms 
      during proofs. ‚Ä∫</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> inv_VDMToken'_defs <span class="main">=</span> inv_VDMToken'_def inv_True_def

<span class="keyword1"><span class="command">lemma</span></span> l_inv_VDMTokenI<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">inv_T</span> <span class="free">a</span> <span class="main">‚üπ</span> <span class="free">t</span> <span class="main">=</span> <span class="main">(</span>Token <span class="free">a</span><span class="main">)</span> <span class="main">‚üπ</span> inv_VDMToken' <span class="free">inv_T</span> <span class="free">t</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inv_VDMToken'_def<span class="main">)</span>

<span class="comment1">(*****************************************************************)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‚Äπ Sets ‚Ä∫</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπAll VDM structured types (e.g. sets, sequences, maps, etc.) must check the
     type invariant of its constituent parts, beyond any user-defined invariant. 

      Moreover, all VDM sets are finite. Therefore, we define VDM set invariant checks as
      combination of finiteness checks with invariant checks of its elements type. ‚Ä∫</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> VDMSet <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> VDMSet1 <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">inv_VDMSet</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> VDMSet <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
   <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">inv_VDMSet</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">‚â°</span> finite <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">inv_VDMSet1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> VDMSet1 <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
   <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">inv_VDMSet1</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">‚â°</span> inv_VDMSet <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">‚àß</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">‚â†</span> <span class="main">{}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">inv_SetElems</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áí</span> <span class="main">ùîπ</span><span class="main">)</span> <span class="main">‚áí</span> <span class="tfree">'a</span> VDMSet <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inv_SetElems</span> <span class="free"><span class="bound"><span class="entity">einv</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">‚â°</span> <span class="main">‚àÄ</span> <span class="bound">e</span> <span class="main">‚àà</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">.</span> <span class="free"><span class="bound"><span class="entity">einv</span></span></span> <span class="bound">e</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚Äπ Added wrapped version of the definition so that we can translate 
complex structured types (e.g. \verb'seq of seq of T', etc.). Parameter order matter
for partial instantiation (e.g. <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‚Äπ<span class="free"><span class="free">inv_VDMSet'</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">inv_VDMSet'</span></span> inv_VDMNat<span class="main"><span class="main">)</span></span> <span class="free"><span class="free">s</span></span>‚Ä∫</span></span></span></span>).‚Ä∫</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">inv_VDMSet'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áí</span> <span class="main">ùîπ</span><span class="main">)</span> <span class="main">‚áí</span> <span class="tfree">'a</span> VDMSet <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
   <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">inv_VDMSet'</span> <span class="free"><span class="bound"><span class="entity">einv</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">‚â°</span> inv_VDMSet <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">‚àß</span> inv_SetElems <span class="free"><span class="bound"><span class="entity">einv</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
    
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">inv_VDMSet1'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áí</span> <span class="main">ùîπ</span><span class="main">)</span> <span class="main">‚áí</span> <span class="tfree">'a</span> VDMSet1 <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
   <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">inv_VDMSet1'</span> <span class="free"><span class="bound"><span class="entity">einv</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">‚â°</span> inv_VDMSet1 <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">‚àß</span> inv_SetElems <span class="free"><span class="bound"><span class="entity">einv</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">vdm_card</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> VDMSet <span class="main">‚áí</span> VDMNat"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">vdm_card</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">‚â°</span> <span class="main">(</span><span class="keyword1">if</span> inv_VDMSet <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span> int <span class="main">(</span>card <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="keyword1">else</span> undefined<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">pre_vdm_card</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> VDMSet <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">pre_vdm_card</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">‚â°</span> inv_VDMSet <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">post_vdm_card</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> VDMSet <span class="main">‚áí</span> VDMNat <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">post_vdm_card</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">RESULT</span></span></span> <span class="main">‚â°</span> pre_vdm_card <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">‚ü∂</span> inv_VDMNat <span class="free"><span class="bound"><span class="entity">RESULT</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> inv_VDMSet_defs   <span class="main">=</span> inv_VDMSet_def
<span class="keyword1"><span class="command">lemmas</span></span> inv_VDMSet1_defs  <span class="main">=</span> inv_VDMSet1_def inv_VDMSet_def   
<span class="keyword1"><span class="command">lemmas</span></span> inv_VDMSet'_defs  <span class="main">=</span> inv_VDMSet'_def  inv_VDMSet_def inv_SetElems_def
<span class="keyword1"><span class="command">lemmas</span></span> inv_VDMSet1'_defs <span class="main">=</span> inv_VDMSet1'_def inv_VDMSet1_defs inv_SetElems_def
<span class="keyword1"><span class="command">lemmas</span></span> vdm_card_defs     <span class="main">=</span> vdm_card_def inv_VDMSet_defs

<span class="keyword1"><span class="command">lemma</span></span> l_invVDMSet_finite_f<span class="main">:</span> <span class="quoted"><span class="quoted">"inv_VDMSet <span class="free">s</span> <span class="main">‚üπ</span> finite <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> inv_VDMSet_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
<span class="keyword1"><span class="command">lemma</span></span> l_inv_SetElems_Cons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>inv_SetElems <span class="free">f</span> <span class="main">(</span>insert <span class="free">a</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="free">a</span> <span class="main">‚àß</span> <span class="main">(</span>inv_SetElems <span class="free">f</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> inv_SetElems_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> l_inv_SetElems_Un<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>inv_SetElems <span class="free">f</span> <span class="main">(</span><span class="free">S</span> <span class="main">‚à™</span> <span class="free">T</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>inv_SetElems <span class="free">f</span> <span class="free">S</span> <span class="main">‚àß</span> inv_SetElems <span class="free">f</span> <span class="free">T</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> inv_SetElems_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> l_inv_SetElems_Int<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>inv_SetElems <span class="free">f</span> <span class="main">(</span><span class="free">S</span> <span class="main">‚à©</span> <span class="free">T</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>inv_SetElems <span class="free">f</span> <span class="main">(</span><span class="free">S</span> <span class="main">‚à©</span> <span class="free">T</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> inv_SetElems_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> l_inv_SetElems_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inv_SetElems <span class="free">f</span> <span class="main">{}</span>"</span></span> 
<span class="keyword1"><span class="command">unfolding</span></span> inv_SetElems_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> l_invSetElems_inv_True_True<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"undefined <span class="main">‚àâ</span> <span class="free">r</span> <span class="main">‚üπ</span> inv_SetElems inv_True <span class="free">r</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> inv_SetElems_def l_inv_True_True<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> l_vdm_card_finite<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">s</span> <span class="main">‚üπ</span> vdm_card <span class="free">s</span> <span class="main">=</span> int <span class="main">(</span>card <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> vdm_card_defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> l_vdm_card_range<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">‚â§</span> <span class="free">y</span> <span class="main">‚üπ</span> vdm_card <span class="main">{</span><span class="free">x</span> <span class="main">..</span> <span class="free">y</span><span class="main">}</span> <span class="main">=</span> <span class="free">y</span> <span class="main">-</span> <span class="free">x</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> vdm_card_defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 

<span class="keyword1"><span class="command">lemma</span></span> l_vdm_card_positive<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"finite <span class="free">s</span> <span class="main">‚üπ</span> <span class="main">0</span> <span class="main">‚â§</span> vdm_card <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> l_vdm_card_VDMNat<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"finite <span class="free">s</span> <span class="main">‚üπ</span> inv_VDMNat <span class="main">(</span>vdm_card <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inv_VDMSet_def inv_VDMNat_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_vdm_card_non_negative<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="free">s</span> <span class="main">‚üπ</span> <span class="free">s</span> <span class="main">‚â†</span> <span class="main">{}</span> <span class="main">‚üπ</span> <span class="main">0</span> <span class="main">&lt;</span> vdm_card <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_gt_0_iff<span class="main">)</span>
    
<span class="keyword1"><span class="command">lemma</span></span> l_vdm_card_isa_card<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="free">s</span> <span class="main">‚üπ</span> card <span class="free">s</span> <span class="main">‚â§</span> <span class="free">i</span> <span class="main">‚üπ</span> vdm_card <span class="free">s</span> <span class="main">‚â§</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> l_isa_card_inter_bound<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"finite <span class="free">T</span> <span class="main">‚üπ</span> card <span class="free">T</span> <span class="main">‚â§</span> <span class="free">i</span> <span class="main">‚üπ</span> card <span class="main">(</span><span class="free">S</span> <span class="main">‚à©</span> <span class="free">T</span><span class="main">)</span> <span class="main">‚â§</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">thm</span></span> card_mono inf_le2 le_trans card_seteq Int_commute nat_le_linear
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> card_mono inf_le2 le_trans<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_vdm_card_inter_bound<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"finite <span class="free">T</span> <span class="main">‚üπ</span> vdm_card <span class="free">T</span> <span class="main">‚â§</span> <span class="free">i</span> <span class="main">‚üπ</span> vdm_card <span class="main">(</span><span class="free">S</span> <span class="main">‚à©</span> <span class="free">T</span><span class="main">)</span> <span class="main">‚â§</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"vdm_card <span class="free">T</span> <span class="main">‚â§</span> <span class="free">i</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> a2<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> f3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">‚àÄ</span><span class="bound">A</span> <span class="bound">Aa</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span>card <span class="main">(</span><span class="bound">A</span><span class="main">::</span><span class="tfree">'a</span> set<span class="main">)</span> <span class="main">‚â§</span> card <span class="main">(</span><span class="bound">Aa</span><span class="main">::</span><span class="tfree">'a</span> set<span class="main">)</span> <span class="main">‚à®</span> <span class="main">¬¨</span> vdm_card <span class="bound">A</span> <span class="main">‚â§</span> vdm_card <span class="bound">Aa</span><span class="main">)</span> <span class="main">‚à®</span> infinite <span class="bound">A</span><span class="main">)</span> <span class="main">‚à®</span> infinite <span class="bound">Aa</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> l_vdm_card_finite of_nat_le_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">‚à©</span> <span class="free">S</span> <span class="main">‚â†</span> <span class="free">T</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vdm_card <span class="main">(</span><span class="free">T</span> <span class="main">‚à©</span> <span class="free">S</span><span class="main">)</span> <span class="main">‚â†</span> vdm_card <span class="free">T</span> <span class="main">‚àß</span> <span class="free">T</span> <span class="main">‚à©</span> <span class="free">S</span> <span class="main">‚â†</span> <span class="free">T</span> <span class="main">‚à®</span> vdm_card <span class="main">(</span><span class="free">T</span> <span class="main">‚à©</span> <span class="free">S</span><span class="main">)</span> <span class="main">‚â§</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vdm_card <span class="main">(</span><span class="free">T</span> <span class="main">‚à©</span> <span class="free">S</span><span class="main">)</span> <span class="main">‚â§</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> f3 a2 a1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> card_seteq dual_order.trans inf_le1 infinite_super verit_la_generic<span class="main">)</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> a1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Int_commute<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> l_vdm_card_fsb<span class="main">:</span>
  <span class="quoted"><span class="quoted">"pre_vdm_card <span class="free">s</span> <span class="main">‚üπ</span> post_vdm_card <span class="free">s</span> <span class="main">(</span>vdm_card <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inv_VDMNat_def inv_VDMSet_def post_vdm_card_def pre_vdm_card_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚Äπ @TODO power set ‚Ä∫</span></span>
    
<span class="comment1">(*****************************************************************)</span>      
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‚Äπ Sequences ‚Ä∫</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> VDMSeq  <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> VDMSeq1 <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">inv_VDMSeq1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> VDMSeq1 <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">inv_VDMSeq1</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">‚â°</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">‚â†</span> <span class="main">[]</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‚Äπ Sequences may have invariants within their inner type. ‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">inv_SeqElems</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áí</span> <span class="main">ùîπ</span><span class="main">)</span> <span class="main">‚áí</span> <span class="tfree">'a</span> VDMSeq <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">inv_SeqElems</span> <span class="free"><span class="bound"><span class="entity">einv</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">‚â°</span> list_all <span class="free"><span class="bound"><span class="entity">einv</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">inv_SeqElems0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áí</span> <span class="main">ùîπ</span><span class="main">)</span> <span class="main">‚áí</span> <span class="tfree">'a</span> VDMSeq <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inv_SeqElems0</span> <span class="free"><span class="bound"><span class="entity">einv</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">‚â°</span> <span class="main">‚àÄ</span> <span class="bound">e</span> <span class="main">‚àà</span> <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">.</span> <span class="free"><span class="bound"><span class="entity">einv</span></span></span> <span class="bound">e</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚Äπ  Isabelle's list <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">hd</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">tl</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> functions have the
same name as VDM. Nevertheless, their results is defined for empty lists.
We need to rule them out.
‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">inv_VDMSeq'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áí</span> <span class="main">ùîπ</span><span class="main">)</span> <span class="main">‚áí</span> <span class="tfree">'a</span> VDMSeq <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
   <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">inv_VDMSeq'</span> <span class="free"><span class="bound"><span class="entity">einv</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">‚â°</span> inv_SeqElems <span class="free"><span class="bound"><span class="entity">einv</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
    
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">inv_VDMSeq1'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áí</span> <span class="main">ùîπ</span><span class="main">)</span> <span class="main">‚áí</span> <span class="tfree">'a</span> VDMSeq1 <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
   <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">inv_VDMSeq1'</span> <span class="free"><span class="bound"><span class="entity">einv</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">‚â°</span> inv_VDMSeq' <span class="free"><span class="bound"><span class="entity">einv</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">‚àß</span> inv_VDMSeq1 <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> inv_VDMSeq'_defs  <span class="main">=</span> inv_VDMSeq'_def  inv_SeqElems_def
<span class="keyword1"><span class="command">lemmas</span></span> inv_VDMSeq1'_defs <span class="main">=</span> inv_VDMSeq1'_def inv_VDMSeq'_defs inv_VDMSeq1_def 

<span class="comment1">(*****************************************************************)</span>
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚Äπ Sequence operators specification ‚Ä∫</span></span>  

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">len</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> VDMSeq <span class="main">‚áí</span> VDMNat"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">len</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">‚â°</span> int <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">post_len</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> VDMSeq <span class="main">‚áí</span> VDMNat <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">post_len</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">‚â°</span> inv_VDMNat <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">‚àß</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">‚â†</span> <span class="main">[]</span> <span class="main">‚ü∂</span> inv_VDMNat1 <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">elems</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> VDMSeq <span class="main">‚áí</span> <span class="tfree">'a</span> VDMSet"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">elems</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">‚â°</span> set <span class="free"><span class="bound"><span class="entity">l</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">post_elems</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> VDMSeq <span class="main">‚áí</span> <span class="tfree">'a</span> VDMSet <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">post_elems</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">‚â°</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">‚äÜ</span> set <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚Äπ Be careful with representation differences 
   VDM lists are 1-based, whereas Isabelle list 
   are 0-based. This function returns {0,1,2}
   for sequence [A, B, C] instead of {1,2,3} ‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span>
   <span class="entity">inds0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> VDMSeq <span class="main">‚áí</span> VDMNat VDMSet"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inds0</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">‚â°</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> len <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
   <span class="entity">inds</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> VDMSeq <span class="main">‚áí</span> VDMNat1 VDMSet"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">inds</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">‚â°</span> <span class="main">{</span><span class="main">1</span> <span class="main">..</span> len <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">post_inds</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> VDMSeq <span class="main">‚áí</span> VDMNat1 VDMSet <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">post_inds</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">‚â°</span> finite <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">‚àß</span> <span class="main">(</span>len <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>card <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
   <span class="entity">inds_as_nat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> VDMSeq <span class="main">‚áí</span> <span class="main">‚Ñï</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inds_as_nat</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">‚â°</span> <span class="main">{</span><span class="main">1</span> <span class="main">..</span> nat <span class="main">(</span>len <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚Äπ <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">applyList</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> plays with <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'a</span></span> option"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> type instead of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">undefined</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. ‚Ä∫</span></span>  

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">applyList</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> VDMSeq <span class="main">‚áí</span> <span class="main">‚Ñï</span> <span class="main">‚áí</span> <span class="tfree">'a</span> option"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">applyList</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">‚â°</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">‚àß</span> int <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">‚â§</span> len <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="keyword1">then</span> 
                      Some<span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">!</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">-</span> <span class="main">(</span><span class="main">1</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span><span class="main">)</span> 
                   <span class="keyword1">else</span> 
                      None<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚Äπ <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">applyVDMSeq</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> sticks with <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">undefined</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. ‚Ä∫</span></span>  
 
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">applyVDMSeq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> VDMSeq <span class="main">‚áí</span> VDMNat1 <span class="main">‚áí</span> <span class="tfree">'a</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">$</span>"</span> 100<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main"><span class="free">$</span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">‚â°</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span>inv_VDMNat1 <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">‚àß</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">‚â§</span> len <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="keyword1">then</span> 
                      <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">!</span> nat <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> 
                   <span class="keyword1">else</span> 
                      undefined<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">applyVDMSubseq'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> VDMSeq <span class="main">‚áí</span> VDMNat1 <span class="main">‚áí</span> VDMNat1 <span class="main">‚áí</span> <span class="tfree">'a</span> VDMSeq"</span></span>        <span class="main">(</span><span class="quoted">"_ <span class="keyword1">$$$</span> <span class="keyword3">(1</span><span class="keyword1">{</span>_<span class="keyword1">..</span>_<span class="keyword1">}</span><span class="keyword3">)</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main"><span class="free">$$$</span></span> <span class="main"><span class="free">{</span></span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main"><span class="free">..</span></span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main"><span class="free">}</span></span> <span class="main">‚â°</span> <span class="keyword1">if</span> inv_VDMNat1 <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">‚àß</span> inv_VDMNat1 <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">‚àß</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">‚â§</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span> <span class="keyword1">then</span> 
                  nths <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">{</span><span class="main">(</span>nat <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">-</span><span class="main">1</span><span class="main">..</span><span class="main">(</span>nat <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">)</span><span class="main">-</span><span class="main">1</span><span class="main">}</span>
                <span class="keyword1">else</span>
                  <span class="main">[]</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπThanks to Tom Hayle for suggesting a generalised version, which is similar to the one below‚Ä∫</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">applyVDMSubseq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> VDMSeq <span class="main">‚áí</span> VDMInt VDMSet <span class="main">‚áí</span> <span class="tfree">'a</span> VDMSeq"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">$$</span>"</span> 105<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main"><span class="free">$$</span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">‚â°</span> nths <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">{</span><span class="bound">x</span><span class="main">::</span>nat <span class="main">|</span> <span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span><span class="main">+</span><span class="main">1</span> <span class="main">‚àà</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> l_vdm_len_fsb<span class="main">:</span> <span class="quoted"><span class="quoted">"post_len <span class="free">s</span> <span class="main">(</span>len <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> post_len_def len_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> len_def post_len_def inv_VDMNat1_def inv_VDMNat_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_vdm_elems_fsb<span class="main">:</span> <span class="quoted"><span class="quoted">"post_elems <span class="free">s</span> <span class="main">(</span>elems <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> elems_def post_elems_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_vdm_inds_fsb<span class="main">:</span> <span class="quoted"><span class="quoted">"post_inds <span class="free">s</span> <span class="main">(</span>inds <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> post_inds_def inds_def len_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inds_def len_def post_inds_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_vdmsubseq_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">$$</span> <span class="main">{</span><span class="free">l</span><span class="main">..</span><span class="free">u</span><span class="main">}</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> applyVDMSubseq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> l_vdmsubseq_beyond<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">&gt;</span> <span class="free">u</span> <span class="main">‚üπ</span> <span class="free">s</span> <span class="main">$$</span> <span class="main">{</span><span class="free">l</span><span class="main">..</span><span class="free">u</span><span class="main">}</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> applyVDMSubseq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">(*
s(i,...,j) = 

          1.........(len s)
            i.......j       = j - i + 1  
          i....j            = j - i + 1
      -1..0..1
       i............j       = j - 1 + 1
       i.......j            = j - 1 + 1
       i...............j    = len s - 1 + 1

       i..j                 = j - i + 1 = 0

                     = (min j (len s) - max 1 i) + 1
  "len (s $$ {l..u}) = (min 0 (max 1 ((min u (len s)) - (min l 1) + 1)))"
*)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"len <span class="main">(</span><span class="free">s</span> <span class="main">$$</span> <span class="main">{</span><span class="free">i</span><span class="main">..</span><span class="free">j</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>min <span class="free">j</span> <span class="main">(</span><span class="main">(</span>len <span class="free">s</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span>max <span class="main">1</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> applyVDMSubseq_def len_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_nths<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> min_def max_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span> <span class="main">)</span>
  <span class="keyword1"><span class="command">oops</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> l_vdmsubseq_ext_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"inv_VDMNat1 <span class="free">l</span> <span class="main">‚üπ</span> inv_VDMNat1 <span class="free">u</span> <span class="main">‚üπ</span> <span class="free">s</span> <span class="main">$$$</span> <span class="main">{</span><span class="free">l</span><span class="main">..</span><span class="free">u</span><span class="main">}</span> <span class="main">=</span> <span class="free">s</span> <span class="main">$$</span> <span class="main">{</span><span class="free">l</span><span class="main">..</span><span class="free">u</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> applyVDMSubseq_def applyVDMSubseq'_def inv_VDMNat1_def 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span><span class="operator">safe</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>nat <span class="free">l</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">..</span>nat <span class="free">u</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">l</span> <span class="main">‚â§</span> int <span class="bound">x</span> <span class="main">+</span> <span class="main">1</span> <span class="main">‚àß</span> int <span class="bound">x</span> <span class="main">+</span> <span class="main">1</span> <span class="main">‚â§</span> <span class="free">u</span><span class="main">}</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> HOL.subst<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">safe</span><span class="main"><span class="keyword3">;</span></span><span class="operator">simp</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">linarith</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">l</span> <span class="main">‚â§</span> int <span class="bound">x</span> <span class="main">+</span> <span class="main">1</span> <span class="main">‚àß</span> int <span class="bound">x</span> <span class="main">+</span> <span class="main">1</span> <span class="main">‚â§</span> <span class="free">u</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> ssubst<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> applyVDMSeq_defs <span class="main">=</span> applyVDMSeq_def inv_VDMNat1_def len_def

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">pre_applyVDMSeq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> VDMSeq <span class="main">‚áí</span> VDMNat1 <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pre_applyVDMSeq</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">‚â°</span> inv_VDMNat1 <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">‚àß</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">‚â§</span> len <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span> <span class="comment1">(*‚àß i ‚àà inds xs?*)</span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">post_applyVDMSeq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> VDMSeq <span class="main">‚áí</span> VDMNat1 <span class="main">‚áí</span> <span class="tfree">'a</span> <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">post_applyVDMSeq</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">‚â°</span> pre_applyVDMSeq <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">‚ü∂</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">$</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> PO_applyVDMSeq_fsb<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">‚àÄ</span> <span class="bound">xs</span> <span class="bound">i</span> <span class="main">.</span> pre_applyVDMSeq <span class="bound">xs</span> <span class="bound">i</span> <span class="main">‚ü∂</span> post_applyVDMSeq <span class="bound">xs</span> <span class="bound">i</span> <span class="main">(</span><span class="bound">xs</span><span class="main">$</span><span class="bound">i</span><span class="main">)</span>"</span></span>  
  <span class="keyword1"><span class="command">unfolding</span></span> post_applyVDMSeq_def pre_applyVDMSeq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">pre_applyVDMSubseq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> VDMSeq <span class="main">‚áí</span> VDMNat1 <span class="main">‚áí</span> VDMNat1 <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pre_applyVDMSubseq</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">‚â°</span> inv_VDMNat1 <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">‚àß</span> inv_VDMNat1 <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">‚àß</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">‚â§</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">post_applyVDMSubseq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> VDMSeq <span class="main">‚áí</span> VDMNat1 <span class="main">‚áí</span> VDMNat1 <span class="main">‚áí</span> <span class="tfree">'a</span> VDMSeq <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">post_applyVDMSubseq</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">‚â°</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> pre_applyVDMSubseq <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">$$</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">..</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">}</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">[]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> PO_applyVDMSubseq_fsb<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">‚àÄ</span> <span class="bound">xs</span> <span class="bound">i</span> <span class="main">.</span> pre_applyVDMSubseq <span class="bound">xs</span> <span class="free">l</span> <span class="free">u</span> <span class="main">‚ü∂</span> post_applyVDMSubseq <span class="bound">xs</span> <span class="free">l</span> <span class="free">u</span> <span class="main">(</span><span class="bound">xs</span><span class="main">$$</span><span class="main">{</span><span class="free">l</span><span class="main">..</span><span class="free">u</span><span class="main">}</span><span class="main">)</span>"</span></span>  
  <span class="keyword1"><span class="command">unfolding</span></span> post_applyVDMSubseq_def pre_applyVDMSubseq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">post_append</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> VDMSeq <span class="main">‚áí</span> <span class="tfree">'a</span> VDMSeq <span class="main">‚áí</span> <span class="tfree">'a</span> VDMSeq <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">post_append</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">‚â°</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> VDMSeq_defs <span class="main">=</span> elems_def inds_def applyVDMSeq_defs

<span class="keyword1"><span class="command">lemma</span></span> l_applyVDMSeq_inds<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"pre_applyVDMSeq <span class="free">xs</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="free">i</span> <span class="main">‚àà</span> inds <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pre_applyVDMSeq_def inv_VDMNat1_def len_def inds_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚Äπ Isabelle <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">hd</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">tl</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the same as VDM ‚Ä∫</span></span> 
  
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">pre_hd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> VDMSeq <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pre_hd</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">‚â°</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">‚â†</span> <span class="main">[]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">post_hd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> VDMSeq <span class="main">‚áí</span> <span class="tfree">'a</span> <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">post_hd</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">RESULT</span></span></span> <span class="main">‚â°</span> pre_hd <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">‚ü∂</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">RESULT</span></span></span> <span class="main">‚àà</span> elems <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">‚à®</span> <span class="free"><span class="bound"><span class="entity">RESULT</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">$</span><span class="main">1</span><span class="main">)</span>"</span></span>
  
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">pre_tl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> VDMSeq <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pre_tl</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">‚â°</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">‚â†</span> <span class="main">[]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">post_tl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> VDMSeq <span class="main">‚áí</span> <span class="tfree">'a</span> VDMSeq <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">post_tl</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">RESULT</span></span></span> <span class="main">‚â°</span> pre_tl <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">‚ü∂</span> elems <span class="free"><span class="bound"><span class="entity">RESULT</span></span></span> <span class="main">‚äÜ</span> elems <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">vdm_reverse</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> VDMSeq <span class="main">‚áí</span> <span class="tfree">'a</span> VDMSeq"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">vdm_reverse</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">‚â°</span> rev <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">post_vdm_reverse</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> VDMSeq <span class="main">‚áí</span> <span class="tfree">'a</span> VDMSeq <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">post_vdm_reverse</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">‚â°</span> elems <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> elems <span class="free"><span class="bound"><span class="entity">R</span></span></span>"</span></span>
  
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">conc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> VDMSeq VDMSeq <span class="main">‚áí</span> <span class="tfree">'a</span> VDMSeq"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">conc</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">‚â°</span> concat <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">vdmtake</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"VDMNat <span class="main">‚áí</span> <span class="tfree">'a</span> VDMSeq <span class="main">‚áí</span> <span class="tfree">'a</span> VDMSeq"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">vdmtake</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">‚â°</span> <span class="main">(</span><span class="keyword1">if</span> inv_VDMNat <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">then</span> take <span class="main">(</span>nat <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">else</span> <span class="main">[]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">post_vdmtake</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"VDMNat <span class="main">‚áí</span> <span class="tfree">'a</span> VDMSeq <span class="main">‚áí</span> <span class="tfree">'a</span> VDMSeq <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">post_vdmtake</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">RESULT</span></span></span> <span class="main">‚â°</span> 
    len <span class="free"><span class="bound"><span class="entity">RESULT</span></span></span> <span class="main">=</span> min <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>len <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>
  <span class="main">‚àß</span> elems <span class="free"><span class="bound"><span class="entity">RESULT</span></span></span> <span class="main">‚äÜ</span> elems <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">seq_prefix</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> VDMSeq <span class="main">‚áí</span> <span class="tfree">'a</span> VDMSeq <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span>_<span class="keyword3">/ </span><span class="keyword1">‚äë</span> _<span class="keyword3">)</span>"</span> <span class="main">[</span>51<span class="main">,</span> 51<span class="main">]</span> 50<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main"><span class="free">‚äë</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">‚â°</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">‚à®</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span> <span class="main">‚à®</span> <span class="main">(</span>len <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">‚â§</span> len <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">‚àß</span> <span class="main">(</span><span class="main">‚àÉ</span> <span class="bound">i</span> <span class="main">‚àà</span> inds <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">.</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> vdmtake <span class="bound">i</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">post_seq_prefix</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> VDMSeq <span class="main">‚áí</span> <span class="tfree">'a</span> VDMSeq <span class="main">‚áí</span> <span class="main">ùîπ</span> <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">post_seq_prefix</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">RESULT</span></span></span> <span class="main">‚â°</span>
    <span class="free"><span class="bound"><span class="entity">RESULT</span></span></span> <span class="main">‚ü∂</span> <span class="main">(</span>elems <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">‚äÜ</span> elems <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">‚àß</span> len <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">‚â§</span> len <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(*****************************************************************)</span>      
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚Äπ Sequence operators lemmas ‚Ä∫</span></span>  

<span class="keyword1"><span class="command">lemma</span></span> l_inv_VDMSet_finite<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"finite <span class="free">xs</span> <span class="main">‚üπ</span> inv_VDMSet <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> inv_VDMSet_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>  

<span class="keyword1"><span class="command">lemma</span></span> l_inv_SeqElems_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"inv_SeqElems <span class="free">einv</span> <span class="free">s</span> <span class="main">=</span> inv_SeqElems0 <span class="free">einv</span> <span class="free">s</span>"</span></span>  
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> elems_def inv_SeqElems0_def inv_SeqElems_def list_all_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_inv_SeqElems_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inv_SeqElems <span class="free">f</span> <span class="main">[]</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inv_SeqElems_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_inv_SeqElems_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>inv_SeqElems <span class="free">f</span> <span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="free">a</span> <span class="main">‚àß</span> <span class="main">(</span>inv_SeqElems <span class="free">f</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> inv_SeqElems_def elems_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> l_inv_SeqElems_Cons'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">a</span> <span class="main">‚üπ</span> inv_SeqElems <span class="free">f</span> <span class="free">s</span> <span class="main">‚üπ</span> inv_SeqElems <span class="free">f</span> <span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l_inv_SeqElems_Cons<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_inv_SeqElems_append<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>inv_SeqElems <span class="free">f</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span> <span class="main">‚àß</span> <span class="main">(</span>inv_SeqElems <span class="free">f</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> inv_SeqElems_def elems_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> l_inv_SeqElems_append'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">‚üπ</span> inv_SeqElems <span class="free">f</span> <span class="free">xs</span> <span class="main">‚üπ</span> inv_SeqElems <span class="free">f</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l_inv_SeqElems_append<span class="main">)</span>

<span class="comment1">(*
lemma l_invSeqElems_inv_True_True[simp]: "undefined ‚àâ elems r ‚üπ inv_SeqElems inv_True r" 
  by (metis elems_def inv_SeqElems0_def l_inv_SeqElems_alt l_inv_True_True)
*)</span>
<span class="keyword1"><span class="command">lemma</span></span> l_invSeqElems_inv_True_True<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inv_SeqElems inv_True <span class="free">r</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> inv_SeqElems0_def l_inv_SeqElems_alt l_inv_True_True<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_len_nat1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">‚â†</span> <span class="main">[]</span> <span class="main">‚üπ</span> <span class="main">0</span> <span class="main">&lt;</span> len <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> len_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> l_len_append_single<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"len<span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> len <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">unfolding</span></span> len_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> l_len_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"len <span class="main">[]</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> len_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> l_len_cons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"len<span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> len <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">unfolding</span></span> len_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> l_elems_append<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"elems <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> insert <span class="free">x</span> <span class="main">(</span>elems <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> elems_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> l_elems_cons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"elems <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> insert <span class="free">x</span> <span class="main">(</span>elems <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> elems_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> l_elems_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"elems <span class="main">[]</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> elems_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> l_inj_seq<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">s</span> <span class="main">‚üπ</span> nat <span class="main">(</span>len <span class="free">s</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>elems <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> elems_def len_def<span class="main">)</span> <span class="comment1">(* add: l_elems_cons *)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_elems_finite<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>elems <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> elems_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_inds_append<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inds <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span>len <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>inds <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> inds_def  
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> atLeastAtMostPlus1_int_conv len_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_inds_cons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inds <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">1</span> <span class="main">..</span> <span class="main">(</span>len <span class="free">xs</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> inds_def len_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> l_len_within_inds<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">‚â†</span> <span class="main">[]</span> <span class="main">‚üπ</span> len <span class="free">s</span> <span class="main">‚àà</span> inds <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> len_def inds_def
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> l_inds_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inds <span class="main">[]</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> inds_def len_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> l_inds_as_nat_append<span class="main">:</span> <span class="quoted"><span class="quoted">"inds_as_nat <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span>length <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>inds_as_nat <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> inds_as_nat_def len_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

<span class="keyword1"><span class="command">lemma</span></span> l_applyVDM_len1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">$</span> <span class="main">(</span>len <span class="free">s</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> undefined"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> applyVDMSeq_def len_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
<span class="keyword1"><span class="command">lemma</span></span> l_applyVDM_zero<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">$</span> <span class="main">0</span> <span class="main">=</span> undefined"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> applyVDMSeq_defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">(* this goal is too specific; they are useful in specific situations *)</span>
<span class="keyword1"><span class="command">lemma</span></span> l_applyVDM1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">$</span> <span class="main">1</span> <span class="main">=</span> <span class="free">x</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> applyVDMSeq_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_applyVDM2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">$</span> <span class="numeral">2</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">$</span> <span class="main">1</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> applyVDMSeq_defs<span class="main">)</span>

<span class="comment1">(* generalise previous failure for a better matching goal: trade $ for ! *)</span>
<span class="keyword1"><span class="command">lemma</span></span> l_applyVDM1_gen<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">‚â†</span> <span class="main">[]</span> <span class="main">‚üπ</span> <span class="free">s</span> <span class="main">$</span> <span class="main">1</span> <span class="main">=</span> <span class="free">s</span> <span class="main">!</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> applyVDMSeq_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_applyVDMSeq_i<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">‚àà</span> inds <span class="free">s</span> <span class="main">‚üπ</span> <span class="free">s</span> <span class="main">$</span> <span class="free">i</span> <span class="main">=</span> <span class="free">s</span> <span class="main">!</span> nat<span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> applyVDMSeq_defs inds_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> l_applyVDM_cons_gt1empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">‚üπ</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="main">[]</span><span class="main">)</span> <span class="main">$</span> <span class="free">i</span> <span class="main">=</span> undefined"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> applyVDMSeq_defs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_applyVDM_cons_gt1<span class="main">:</span> <span class="quoted"><span class="quoted">"len <span class="free">xs</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">‚üπ</span> <span class="free">i</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">‚üπ</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">$</span> <span class="free">i</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">$</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> applyVDMSeq_defs<span class="main">)</span> <span class="comment1">(* again too complex; try avoiding the trade $ for ! again *)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> impI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> length_induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> nat_1 nat_diff_distrib<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_applyVDMSeq_defined<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">‚â†</span> <span class="main">[]</span> <span class="main">‚üπ</span> inv_SeqElems <span class="main">(</span><span class="main">Œª</span> <span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">‚â†</span> undefined<span class="main">)</span> <span class="free">s</span> <span class="main">‚üπ</span>  <span class="free">s</span> <span class="main">$</span> <span class="main">(</span>len <span class="free">s</span><span class="main">)</span> <span class="main">‚â†</span> undefined"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> applyVDMSeq_defs  
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span> <span class="comment1">(* add: l_len_nat1)*)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"nat <span class="main">(</span>int <span class="main">(</span>length <span class="free">s</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span> 
  <span class="keyword1"><span class="command">unfolding</span></span> inv_SeqElems_def 
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_length<span class="main">)</span>
  <span class="comment1">(*thm ssubst[OF l_inv_SeqElems_alt]
  apply (subst ssubst[OF l_inv_SeqElems_alt])*)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_applyVDMSeq_append_last<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ms</span> <span class="main">@</span> <span class="main">[</span><span class="free">m</span><span class="main">]</span><span class="main">)</span> <span class="main">$</span> <span class="main">(</span>len <span class="main">(</span><span class="free">ms</span> <span class="main">@</span> <span class="main">[</span><span class="free">m</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> applyVDMSeq_defs 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_applyVDMSeq_cons_last<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">m</span> <span class="main">#</span> <span class="free">ms</span><span class="main">)</span> <span class="main">$</span> <span class="main">(</span>len <span class="main">(</span><span class="free">m</span> <span class="main">#</span> <span class="free">ms</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">ms</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> <span class="free">m</span> <span class="keyword1">else</span> <span class="free">ms</span> <span class="main">$</span> <span class="main">(</span>len <span class="free">ms</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> applyVDMSeq_defs
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nat_diff_distrib'<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_inds_in_set<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">‚àà</span> inds <span class="free">s</span> <span class="main">‚üπ</span> <span class="free">s</span><span class="main">$</span><span class="free">i</span> <span class="main">‚àà</span> set <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> inds_def applyVDMSeq_def inv_VDMNat1_def len_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">safe</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_inv_SeqElems_inds_inv_T<span class="main">:</span>
  <span class="quoted"><span class="quoted">"inv_SeqElems <span class="free">inv_T</span> <span class="free">s</span> <span class="main">‚üπ</span> <span class="free">i</span> <span class="main">‚àà</span> inds <span class="free">s</span> <span class="main">‚üπ</span> <span class="free">inv_T</span> <span class="main">(</span><span class="free">s</span><span class="main">$</span><span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l_inv_SeqElems_alt<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> inv_SeqElems0_def 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">$</span><span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> ballE<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">using</span></span> l_inds_in_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> l_inv_SeqElems_all<span class="main">:</span>
  <span class="quoted"><span class="quoted">"inv_SeqElems <span class="free">inv_T</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="main">‚àÄ</span> <span class="bound">i</span> <span class="main">‚àà</span> inds <span class="free">s</span> <span class="main">.</span> <span class="free">inv_T</span> <span class="main">(</span><span class="free">s</span><span class="main">$</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> inv_SeqElems_def 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all_length<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> inds_def len_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"nat<span class="main">(</span><span class="improper">i</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"int <span class="improper">n</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> ballE<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> l_inds_upto<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span> <span class="main">‚àà</span> inds <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">i</span> <span class="main">‚àà</span> <span class="main">{</span><span class="main">1</span><span class="main">..</span>len <span class="free">s</span><span class="main">}</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inds_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_vdmtake_take<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"vdmtake <span class="free">n</span> <span class="free">s</span> <span class="main">=</span> take <span class="free">n</span> <span class="free">s</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> vdmtake_def inv_VDMNat_def 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> l_seq_prefix_append_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">‚äë</span> <span class="free">s</span> <span class="main">@</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> seq_prefix_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> l_seq_prefix_id<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">‚äë</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> seq_prefix_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> l_len_append<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"len <span class="free">s</span> <span class="main">‚â§</span> len <span class="main">(</span><span class="free">s</span> <span class="main">@</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> len_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_vdmtake_len<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"vdmtake <span class="main">(</span>len <span class="free">s</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> vdmtake_def len_def inv_VDMNat_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> l_vdmtake_len_append<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"vdmtake <span class="main">(</span>len <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="free">s</span> <span class="main">@</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> vdmtake_def len_def inv_VDMNat_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> l_vdmtake_append<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"vdmtake <span class="main">(</span>len <span class="free">s</span> <span class="main">+</span> len <span class="free">t</span><span class="main">)</span> <span class="main">(</span><span class="free">s</span> <span class="main">@</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">s</span> <span class="main">@</span> <span class="free">t</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span> 
  <span class="keyword1"><span class="command">unfolding</span></span> vdmtake_def len_def inv_VDMNat_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"vdmtake <span class="main">(</span><span class="main">1</span> <span class="main">+</span> len <span class="main">[</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">,</span><span class="free">c</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">,</span><span class="free">c</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> l_seq_prefix_append<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">‚äë</span> <span class="free">s</span> <span class="main">@</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> seq_prefix_def  
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> disjI2<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> disjI2<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"len <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> bexI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> l_vdmtake_len_append<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> l_len_within_inds <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> atLeastAtMost_iff inds_def l_len_append l_len_within_inds l_vdmtake_len_append<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_elems_of_inds_of_nth<span class="main">:</span>  
  <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">‚üπ</span> <span class="free">j</span> <span class="main">&lt;</span> int <span class="main">(</span>length <span class="free">s</span><span class="main">)</span> <span class="main">‚üπ</span> <span class="free">s</span> <span class="main">!</span> nat <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">‚àà</span> set <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    
<span class="keyword1"><span class="command">lemma</span></span> l_elems_inds_found<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">‚àà</span> set <span class="free">s</span> <span class="main">‚üπ</span> <span class="main">(</span><span class="main">‚àÉ</span> <span class="bound">i</span> <span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">s</span> <span class="main">‚àß</span> <span class="free">s</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="comment1">(*apply (simp only: ListMem_iff[symmetric])*)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
<span class="keyword1"><span class="command">lemma</span></span> l_elems_of_inds<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">‚àà</span> elems <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">‚àÉ</span> <span class="bound">j</span> <span class="main">.</span> <span class="bound">j</span> <span class="main">‚àà</span> inds <span class="free">s</span> <span class="main">‚àß</span> <span class="main">(</span><span class="free">s</span><span class="main">$</span><span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> elems_def inds_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> applyVDMSeq_def len_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> l_elems_inds_found<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"int<span class="main">(</span><span class="improper">i</span><span class="main">)</span><span class="main">+</span><span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inv_VDMNat1_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> inv_VDMNat1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="comment1">(*****************************************************************)</span>      
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‚Äπ Optional inner type invariant check ‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">inv_Option</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áí</span> <span class="main">ùîπ</span><span class="main">)</span> <span class="main">‚áí</span> <span class="tfree">'a</span> option <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">inv_Option</span> <span class="free"><span class="bound"><span class="entity">inv_type</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">‚â°</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">‚â†</span> None <span class="main">‚ü∂</span> <span class="free"><span class="bound"><span class="entity">inv_type</span></span></span> <span class="main">(</span>the <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> l_inv_option_Some<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"inv_Option <span class="free">inv_type</span> <span class="main">(</span>Some <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">inv_type</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> inv_Option_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> l_inv_option_None<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"inv_Option <span class="free">inv_type</span> None"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> inv_Option_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">(*****************************************************************)</span>      
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‚Äπ Maps ‚Ä∫</span></span>
  
<span class="comment1">(*type_synonym ('a, 'b) "VDMMap" = "'a ‚áÄ 'b" (infixr "‚áÄ" 0)*)</span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚Äπ
   In Isabelle, VDM maps can be declared by the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"‚áÄ"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> operator (not <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"‚áí"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>) 
   (i.e. type 'right' and you will see the arrow on dropdown menu).

   It represents a function to an optional result as follows:

   VDM     : map X to Y
   Isabelle: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"X ‚áÄ Y"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>

   which is the same as 

   Isabelle: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"X ‚áí Y option"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
   
   where an optional type is like using nil in VDM (map X to [Y]).
   That is, Isabele makes the map total by mapping everything outside
   the domain to None (or nil). In Isabelle

   <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"datatype 'a option = None | Some 'a"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>

 Some VDM functions for map domain/range restriction and filtering. You use some like &lt;: and :&gt;.
 The use of some of these functions is one reason that makes the use of maps a bit more demanding,
 but it works fine. Given these are new definitions, "apply auto" won't finish proofs as Isabelle
 needs to know more (lemmas) about the new operators. ‚Ä∫</span></span>
  
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">inv_Map</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áí</span> <span class="main">ùîπ</span><span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">‚áí</span> <span class="main">ùîπ</span><span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áÄ</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">‚áí</span><span class="main">ùîπ</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">inv_Map</span> <span class="free"><span class="bound"><span class="entity">inv_Dom</span></span></span> <span class="free"><span class="bound"><span class="entity">inv_Rng</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">‚â°</span> 
      inv_VDMSet' <span class="free"><span class="bound"><span class="entity">inv_Dom</span></span></span> <span class="main">(</span>dom <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">‚àß</span> 
      inv_VDMSet' <span class="free"><span class="bound"><span class="entity">inv_Rng</span></span></span> <span class="main">(</span>ran <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>"</span></span>
  
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">inv_Map1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áí</span> <span class="main">ùîπ</span><span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">‚áí</span> <span class="main">ùîπ</span><span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áÄ</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">inv_Map1</span> <span class="free"><span class="bound"><span class="entity">inv_Dom</span></span></span> <span class="free"><span class="bound"><span class="entity">inv_Ran</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">‚â°</span> 
    inv_Map <span class="free"><span class="bound"><span class="entity">inv_Dom</span></span></span> <span class="free"><span class="bound"><span class="entity">inv_Ran</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">‚àß</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">‚â†</span> Map.empty"</span></span>
  <span class="comment1">(*vdm_card (dom m) &gt; 0 ‚àß is worst more complicated for nothing*)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">inv_Inmap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áí</span> <span class="main">ùîπ</span><span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">‚áí</span> <span class="main">ùîπ</span><span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áÄ</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">inv_Inmap</span> <span class="free"><span class="bound"><span class="entity">inv_Dom</span></span></span> <span class="free"><span class="bound"><span class="entity">inv_Ran</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">‚â°</span> 
    inv_Map <span class="free"><span class="bound"><span class="entity">inv_Dom</span></span></span> <span class="free"><span class="bound"><span class="entity">inv_Ran</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">‚àß</span> inj <span class="free"><span class="bound"><span class="entity">m</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> inv_Map_defs <span class="main">=</span> inv_Map_def inv_VDMSet'_defs
<span class="keyword1"><span class="command">lemmas</span></span> inv_Map1_defs <span class="main">=</span> inv_Map1_def inv_Map_defs
<span class="keyword1"><span class="command">lemmas</span></span> inv_Inmap_defs <span class="main">=</span> inv_Inmap_def inv_Map_defs inj_def

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">rng</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áÄ</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">‚áí</span> <span class="tfree">'b</span> VDMSet"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rng</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">‚â°</span> ran <span class="free"><span class="bound"><span class="entity">m</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> rng_defs <span class="main">=</span> rng_def ran_def
  
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">dagger</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áÄ</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áÄ</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áÄ</span> <span class="tfree">'b</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">‚Ä†</span>"</span> 100<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main"><span class="free">‚Ä†</span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">‚â°</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">++</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">munion</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áÄ</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áÄ</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áÄ</span> <span class="tfree">'b</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">‚à™m</span>"</span> 90<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="keyword1"><span class="free">‚à™m</span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">‚â°</span> <span class="main">(</span><span class="keyword1">if</span> dom <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">‚à©</span> dom <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">‚Ä†</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="keyword1">else</span> undefined<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">dom_restr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áÄ</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áÄ</span> <span class="tfree">'b</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">‚óÉ</span>"</span> 110<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main"><span class="free">‚óÉ</span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">‚â°</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">|`</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
   <span class="comment1">(* same as VDM  s &lt;: m *)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">dom_antirestr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áÄ</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áÄ</span> <span class="tfree">'b</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">-‚óÉ</span>"</span> 110<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main"><span class="free">-‚óÉ</span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">‚â°</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">:</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">then</span> None <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="bound">x</span><span class="main">)</span>"</span></span>
   <span class="comment1">(* same as VDM   s &lt;-: m *)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">rng_restr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áÄ</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">‚áí</span> <span class="tfree">'b</span> set <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áÄ</span> <span class="tfree">'b</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">‚ñπ</span>"</span> 105<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main"><span class="free">‚ñπ</span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">‚â°</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">x</span> <span class="main">.</span> <span class="keyword1">if</span> <span class="main">(</span><span class="main">‚àÉ</span> <span class="bound">y</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">y</span> <span class="main">‚àß</span> <span class="bound">y</span> <span class="main">‚àà</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="bound">x</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
   <span class="comment1">(* same as VDM   m :&gt; s *)</span>
 
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">rng_antirestr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áÄ</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">‚áí</span> <span class="tfree">'b</span> set <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áÄ</span> <span class="tfree">'b</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">‚ñπ-</span>"</span> 105<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main"><span class="free">‚ñπ-</span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">‚â°</span> <span class="main">(</span><span class="main">Œª</span><span class="bound">x</span> <span class="main">.</span> <span class="keyword1">if</span> <span class="main">(</span><span class="main">‚àÉ</span> <span class="bound">y</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="bound">x</span> <span class="main">=</span> Some <span class="bound">y</span> <span class="main">‚àß</span> <span class="bound">y</span> <span class="main">‚àà</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="keyword1">then</span> None <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="bound">x</span><span class="main">)</span>"</span></span>
   <span class="comment1">(* same as VDM   m :-&gt; s *)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">vdm_merge</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áÄ</span> <span class="tfree">'b</span><span class="main">)</span> VDMSet <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áÄ</span> <span class="tfree">'b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">vdm_merge</span> <span class="free"><span class="bound"><span class="entity">mm</span></span></span> <span class="main">‚â°</span> undefined"</span></span> <span class="comment1">(*TODO: (Œª x . x ‚àà ‚ãÉ { dom mmi | mmi ‚àà mm )} )"*)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">vdm_inverse</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áÄ</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">‚áÄ</span> <span class="tfree">'a</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">vdm_inverse</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">‚â°</span> undefined"</span></span> <span class="comment1">(*(Œª x . if (x ‚àà rng m) then (m x) else None)"*)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">map_subset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áÄ</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áÄ</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">‚áí</span> <span class="tfree">'b</span> <span class="main">‚áí</span> <span class="main">ùîπ</span><span class="main">)</span> <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span>  <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span><span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword3">/ </span><span class="keyword1">‚äÜ<span class="hidden">‚á©</span><sub>s</sub></span> <span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword3">/</span><span class="keyword1">,</span> <span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword3">)</span>"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 50<span class="main">]</span> 50<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">m<span class="hidden">‚á©</span><sub>1</sub></span></span></span> <span class="keyword1"><span class="free">‚äÜ<span class="hidden">‚á©</span><sub>s</sub></span></span> <span class="free"><span class="bound"><span class="entity">m<span class="hidden">‚á©</span><sub>2</sub></span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">subset_of</span></span></span><span class="main">)</span> <span class="main">‚ü∑</span> <span class="main">(</span>dom <span class="free"><span class="bound"><span class="entity">m<span class="hidden">‚á©</span><sub>1</sub></span></span></span> <span class="main">‚äÜ</span> dom <span class="free"><span class="bound"><span class="entity">m<span class="hidden">‚á©</span><sub>2</sub></span></span></span> <span class="main">‚àß</span> <span class="main">(</span><span class="main">‚àÄ</span><span class="bound">a</span> <span class="main">‚àà</span> dom <span class="free"><span class="bound"><span class="entity">m<span class="hidden">‚á©</span><sub>1</sub></span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">subset_of</span></span></span> <span class="main">(</span>the<span class="main">(</span><span class="free"><span class="bound"><span class="entity">m<span class="hidden">‚á©</span><sub>1</sub></span></span></span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>the<span class="main">(</span><span class="free"><span class="bound"><span class="entity">m<span class="hidden">‚á©</span><sub>2</sub></span></span></span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚Äπ Map application is just function application, but the result is an optional type, 
  so it is up to the user to unpick the optional type with the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">the</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> operator. 
  It means we shouldn't get to undefined,
        rather than we are handling undefinedness. That's because the value
        is comparable (see next lemma). In effect, if we ever reach undefined
        it means we have some partial function application outside its domain
        somewhere within any rewriting chain. As one cannot reason about this
        value, it can be seen as a flag for an error to be avoided.‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">map_comp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span> <span class="main">‚áÄ</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áÄ</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áÄ</span> <span class="tfree">'c</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">‚àòm</span>"</span> 55<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="keyword1"><span class="free">‚àòm</span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">‚â°</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">x</span> <span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">‚àà</span> dom <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">map_compatible</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áÄ</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áÄ</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">map_compatible</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="main">‚â°</span> <span class="main">(</span><span class="main">‚àÄ</span> <span class="bound">a</span> <span class="main">‚àà</span> dom <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="main">‚à©</span> dom <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="main">.</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="bound">a</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="bound">a</span><span class="main">)</span>"</span></span>

<span class="comment1">(*****************************************************************)</span>      
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚ÄπMap comprehension‚Ä∫</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπIsabelle maps are similar to VDMs, but with some significant differences worth observing. 
 
      If the filtering is not unique (i.e. result is not a function), then the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">THE</span></span> <span class="bound"><span class="bound">x</span></span> <span class="main"><span class="main">.</span></span> <span class="free"><span class="free">P</span></span> <span class="bound"><span class="bound">x</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> expression
      might lead to (undefined) unexpected results. In Isabelle maps, repetitions is equivalent to overriding,
      so that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">[</span></span><span class="main"><span class="main">1</span></span><span class="main"><span class="main">::</span></span>nat <span class="main"><span class="main">‚Ü¶</span></span> <span class="numeral"><span class="numeral">2</span></span><span class="main"><span class="main">,</span></span> <span class="main"><span class="main">1</span></span> <span class="main"><span class="main">‚Ü¶</span></span> <span class="numeral"><span class="numeral">3</span></span><span class="main"><span class="main">]</span></span> <span class="main"><span class="main">1</span></span> <span class="main"><span class="main">=</span></span> Some <span class="numeral"><span class="numeral">3</span></span>"</span></span> <span class="keyword1"><span class="keyword"><span class="keyword1"><span class="keyword">by</span></span></span></span> <span class="operator"><span class="operator">simp</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. 

      In various VDMToolkit definitions, we default to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">undefined</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in case where the situation is out of hand,
      hence, proofs will fail, and users will know that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">undefined</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> being reached means some earlier problem has
      occurred.  
    ‚Ä∫</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπType bound map comprehension cannot filter for type invariants, hence won't have <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">undefined</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> results.
      This corresponds to the VDMSL expression
      %
      \begin{verbatim}
        { domexpr(d) |-&gt; rngexpr(d, r) | d:S, r: T &amp; P(d, r) }
      \end{verbatim}
      % 
      where the maplet expression can be just variables or functions over the domain/range input(s). 

      VDM also issues a proof obligation for type bound maps (i.e. avoid it please!) to ensure the resulting map is finite.
      Concretely, the example below generates the corresponding proof obligation:
      %
      \begin{verbatim}
      	ex: () -&gt; map nat to nat
	      ex() == { x+y |-&gt; 10 | x: nat, y in set {4,5,6} \&amp; x &lt; 10 };

        exists finmap1: map nat to (map (nat1) to (nat1)) &amp; 
            forall x:nat, y in set {4, 5, 6} &amp; (x &lt; 10) =&gt; 
              exists findex2 in set dom finmap1 &amp; 
                finmap1(findex2) = {(x + y) |-&gt; 10}
      \end{verbatim}
     ‚Ä∫</span></span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">mapCompTypeBound</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áí</span> <span class="main">ùîπ</span><span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">‚áí</span> <span class="main">ùîπ</span><span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áí</span> <span class="tfree">'b</span> <span class="main">‚áí</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áí</span> <span class="tfree">'b</span> <span class="main">‚áí</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áí</span> <span class="tfree">'b</span> <span class="main">‚áí</span> <span class="main">ùîπ</span><span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áÄ</span> <span class="tfree">'b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mapCompTypeBound</span> <span class="free"><span class="bound"><span class="entity">inv_S</span></span></span> <span class="free"><span class="bound"><span class="entity">inv_T</span></span></span> <span class="free"><span class="bound"><span class="entity">domexpr</span></span></span> <span class="free"><span class="bound"><span class="entity">rngexpr</span></span></span> <span class="free"><span class="bound"><span class="entity">pred</span></span></span> <span class="main">‚â°</span> 
        <span class="main">(</span><span class="main">Œª</span> <span class="bound">dummy</span><span class="main">::</span><span class="tfree">'a</span> <span class="main">.</span> 
            <span class="keyword1">if</span> <span class="main">(</span><span class="main">‚àÉ</span> <span class="bound">d</span> <span class="bound">r</span> <span class="main">.</span> <span class="free"><span class="bound"><span class="entity">inv_S</span></span></span> <span class="bound">d</span> <span class="main">‚àß</span> <span class="free"><span class="bound"><span class="entity">inv_T</span></span></span> <span class="bound">r</span> <span class="main">‚àß</span> <span class="bound">dummy</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">domexpr</span></span></span> <span class="bound">d</span> <span class="bound">r</span> <span class="main">‚àß</span> <span class="bound">r</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">rngexpr</span></span></span> <span class="bound">d</span> <span class="bound">r</span> <span class="main">‚àß</span> <span class="free"><span class="bound"><span class="entity">pred</span></span></span> <span class="bound">d</span> <span class="bound">r</span><span class="main">)</span> <span class="keyword1">then</span>
                Some <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">r</span> <span class="main">.</span> <span class="free"><span class="bound"><span class="entity">inv_T</span></span></span> <span class="bound">r</span> <span class="main">‚àß</span> <span class="main">(</span><span class="main">‚àÉ</span> <span class="bound">d</span> <span class="main">.</span> <span class="bound">dummy</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">domexpr</span></span></span> <span class="bound">d</span> <span class="bound">r</span> <span class="main">‚àß</span> <span class="bound">r</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">rngexpr</span></span></span> <span class="bound">d</span> <span class="bound">r</span> <span class="main">‚àß</span> <span class="free"><span class="bound"><span class="entity">pred</span></span></span> <span class="bound">d</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> 
              <span class="keyword1">else</span> 
                None
        <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">1</span><span class="main">::</span>nat <span class="main">‚Ü¶</span> <span class="numeral">2</span><span class="main">::</span>nat<span class="main">,</span> <span class="numeral">3</span> <span class="main">‚Ü¶</span> <span class="numeral">3</span><span class="main">]</span> <span class="numeral">10</span>"</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπSet bound map comprehension can filter bound set for their elements invariants.
      This corresponds to the VDMSL expression
      %
      \begin{verbatim}
        { domexpr(d, r) |-&gt; rngexpr(d, r) | d in set S, r in set T &amp; pred(d, r) } 
        { domexpr(d, r) | d in set S , r in set T &amp; pred(d, r) }  
        { rngexpr(d, r) | d in set S , r in set T &amp; pred(d, r) } 
        domexpr: S * T -&gt; S 
        rngexpr: S * T -&gt; T 
        pred   : S * T -&gt; bool 
      \end{verbatim}
      % 
      If the types of \verb'domexpr' or \verb'rngexpr' are different from \verb'S' or \verb'T' then this will not work! 
      If the filtering is not unique (i.e. result is not a function), then the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">THE</span></span> <span class="bound"><span class="bound">x</span></span> <span class="main"><span class="main">.</span></span> <span class="free"><span class="free">P</span></span> <span class="bound"><span class="bound">x</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> expression
      might lead to (undefined) unexpected results. In Isabelle maps, repetitions is equivalent to overriding,
      so that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">[</span></span><span class="main"><span class="main">1</span></span><span class="main"><span class="main">::</span></span>nat <span class="main"><span class="main">‚Ü¶</span></span> <span class="numeral"><span class="numeral">2</span></span><span class="main"><span class="main">::</span></span>nat<span class="main"><span class="main">,</span></span> <span class="main"><span class="main">1</span></span> <span class="main"><span class="main">‚Ü¶</span></span> <span class="numeral"><span class="numeral">3</span></span><span class="main"><span class="main">]</span></span> <span class="main"><span class="main">1</span></span> <span class="main"><span class="main">=</span></span> Some <span class="numeral"><span class="numeral">3</span></span>"</span></span> <span class="keyword1"><span class="keyword"><span class="keyword1"><span class="keyword">by</span></span></span></span> <span class="operator"><span class="operator">simp</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. 
     ‚Ä∫</span></span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">mapCompSetBound</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">‚áí</span> <span class="tfree">'b</span> set <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áí</span> <span class="main">ùîπ</span><span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">‚áí</span> <span class="main">ùîπ</span><span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áí</span> <span class="tfree">'b</span> <span class="main">‚áí</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áí</span> <span class="tfree">'b</span> <span class="main">‚áí</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áí</span> <span class="tfree">'b</span> <span class="main">‚áí</span> <span class="main">ùîπ</span><span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áÄ</span> <span class="tfree">'b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mapCompSetBound</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="free"><span class="bound"><span class="entity">inv_S</span></span></span> <span class="free"><span class="bound"><span class="entity">inv_T</span></span></span> <span class="free"><span class="bound"><span class="entity">domexpr</span></span></span> <span class="free"><span class="bound"><span class="entity">rngexpr</span></span></span> <span class="free"><span class="bound"><span class="entity">pred</span></span></span> <span class="main">‚â°</span> 
        <span class="main">(</span><span class="main">Œª</span> <span class="bound">dummy</span><span class="main">::</span><span class="tfree">'a</span> <span class="main">.</span> 
            <span class="comment1">‚Äï ‚ÄπIn fact you have to check the <span class="antiquoted"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span><span class="quoted">‚Äπ<span class="free">inv_Type</span>‚Ä∫</span></span> of domexpr and rngexpr!!!‚Ä∫</span>
            <span class="keyword1">if</span> inv_VDMSet' <span class="free"><span class="bound"><span class="entity">inv_S</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">‚àß</span> inv_VDMSet' <span class="free"><span class="bound"><span class="entity">inv_T</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="keyword1">then</span>
              <span class="keyword1">if</span> <span class="main">(</span><span class="main">‚àÉ</span> <span class="bound">r</span> <span class="main">‚àà</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">.</span> <span class="main">‚àÉ</span> <span class="bound">d</span> <span class="main">‚àà</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">.</span> <span class="bound">dummy</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">domexpr</span></span></span> <span class="bound">d</span> <span class="bound">r</span> <span class="main">‚àß</span> <span class="bound">r</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">rngexpr</span></span></span> <span class="bound">d</span> <span class="bound">r</span> <span class="main">‚àß</span> <span class="free"><span class="bound"><span class="entity">pred</span></span></span> <span class="bound">d</span> <span class="bound">r</span><span class="main">)</span> <span class="keyword1">then</span>
                Some <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">r</span> <span class="main">.</span> <span class="bound">r</span> <span class="main">‚àà</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">‚àß</span> <span class="free"><span class="bound"><span class="entity">inv_T</span></span></span> <span class="bound">r</span> <span class="main">‚àß</span> <span class="main">(</span><span class="main">‚àÉ</span> <span class="bound">d</span> <span class="main">‚àà</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">.</span> <span class="bound">dummy</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">domexpr</span></span></span> <span class="bound">d</span> <span class="bound">r</span> <span class="main">‚àß</span> <span class="bound">r</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">rngexpr</span></span></span> <span class="bound">d</span> <span class="bound">r</span> <span class="main">‚àß</span> <span class="free"><span class="bound"><span class="entity">pred</span></span></span> <span class="bound">d</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span> 
              <span class="keyword1">else</span> 
                <span class="comment1">‚Äï ‚ÄπThis is for map application outside its domain error, VDMJ 4061 ‚Ä∫</span>
                None
            <span class="keyword1">else</span>
              <span class="comment1">‚Äï ‚ÄπThis is for type invariant violation errors, VDMJ ????‚Ä∫</span>
              undefined
        <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπIdentity functions to be used for the dom/rng expression functions for the case they are variables.‚Ä∫</span></span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">domid</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">‚áí</span> <span class="tfree">'b</span> <span class="main">‚áí</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">domid</span> <span class="main">‚â°</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">d</span> <span class="main">.</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">r</span> <span class="main">.</span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">rngid</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">‚áí</span> <span class="tfree">'b</span> <span class="main">‚áí</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rngid</span> <span class="main">‚â°</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">d</span> <span class="main">.</span> id<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπConstant function to be used for the dom expression function for the case they are constants.‚Ä∫</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">domcnst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">‚áí</span> <span class="tfree">'a</span> <span class="main">‚áí</span> <span class="tfree">'b</span> <span class="main">‚áí</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">domcnst</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">‚â°</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">d</span> <span class="main">.</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">r</span> <span class="main">.</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπConstant function to be used for the rng expression function for the case they are constants.‚Ä∫</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">rngcnst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">‚áí</span> <span class="tfree">'a</span> <span class="main">‚áí</span> <span class="tfree">'b</span> <span class="main">‚áí</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rngcnst</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">‚â°</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">d</span> <span class="main">.</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">r</span> <span class="main">.</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">truecnst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">‚áí</span> <span class="tfree">'b</span> <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">truecnst</span> <span class="main">‚â°</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">d</span> <span class="main">.</span> inv_True<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">predcnst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">ùîπ</span> <span class="main">‚áí</span> <span class="tfree">'a</span> <span class="main">‚áí</span> <span class="tfree">'b</span> <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">predcnst</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">‚â°</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">d</span> <span class="main">.</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">r</span> <span class="main">.</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> domidI<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"domid <span class="free">d</span> <span class="free">r</span> <span class="main">=</span> <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> domid_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rngidI<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rngid <span class="free">d</span> <span class="free">r</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rngid_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> domcnstI<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"domcnst <span class="free">v</span> <span class="free">d</span> <span class="free">r</span> <span class="main">=</span> <span class="free">v</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> domcnst_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rngcnstI<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rngcnst <span class="free">v</span> <span class="free">d</span> <span class="free">r</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rngcnst_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> predcnstI<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"predcnst <span class="free">v</span> <span class="free">d</span> <span class="free">r</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> predcnst_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> truecnstI<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">‚â†</span> undefined <span class="main">‚üπ</span> truecnst <span class="free">d</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> truecnst_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> maplet_defs <span class="main">=</span> domid_def rngid_def rngcnst_def id_def truecnst_def inv_True_def
<span class="keyword1"><span class="command">lemmas</span></span> mapCompSetBound_defs <span class="main">=</span> mapCompSetBound_def inv_VDMSet'_def inv_VDMSet_def maplet_defs rng_defs
<span class="keyword1"><span class="command">lemmas</span></span> mapCompTypeBound_defs <span class="main">=</span> mapCompTypeBound_def maplet_defs rng_defs

<span class="comment1">(*========================================================================*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‚Äπ Lambda types ‚Ä∫</span></span>
<span class="comment1">(*========================================================================*)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπLambda definitions entail an implicit satisfiability proof obligation check
      as part of its type invariant checks. 

      Because Isabelle lambdas are always curried, we need to also take this into
      account. For example, \verb'lambda x: nat, y: nat1 &amp; x+y' will effectively become
      <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="main"><span class="main">Œª</span></span> <span class="bound"><span class="bound">x</span></span> <span class="main"><span class="main">.</span></span> <span class="main"><span class="main">Œª</span></span> <span class="bound"><span class="bound">y</span></span> <span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">x</span></span> <span class="main"><span class="main">+</span></span> <span class="bound"><span class="bound">y</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Thus callers to this invariant check must 
      account for such currying when using more than one parameter in lambdas. 
      (i.e. call this as <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">inv_Lambda</span></span> <span class="free"><span class="free">inv_Dom</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">inv_Lambda</span></span> <span class="free"><span class="free">inv_Dom'</span></span> <span class="free"><span class="free">inv_Ran</span></span><span class="main"><span class="main">)</span></span> <span class="free"><span class="free">l</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> 
       assuming the right invariant checks for the type of x and y and the result 
       are used.
     ‚Ä∫</span></span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">inv_Lambda</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áí</span> <span class="main">ùîπ</span><span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">‚áí</span> <span class="main">ùîπ</span><span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áí</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inv_Lambda</span> <span class="free"><span class="bound"><span class="entity">inv_Dom</span></span></span> <span class="free"><span class="bound"><span class="entity">inv_Ran</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">‚â°</span> <span class="main">(</span><span class="main">‚àÄ</span> <span class="bound">d</span> <span class="main">.</span> <span class="free"><span class="bound"><span class="entity">inv_Dom</span></span></span> <span class="bound">d</span> <span class="main">‚ü∂</span> <span class="free"><span class="bound"><span class="entity">inv_Ran</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="bound">d</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">inv_Lambda'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áí</span> <span class="main">ùîπ</span><span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">‚áí</span> <span class="main">ùîπ</span><span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áí</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">‚áí</span> <span class="tfree">'a</span>  <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inv_Lambda'</span> <span class="free"><span class="bound"><span class="entity">inv_Dom</span></span></span> <span class="free"><span class="bound"><span class="entity">inv_Ran</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">‚â°</span> <span class="free"><span class="bound"><span class="entity">inv_Dom</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">‚ü∂</span> <span class="free"><span class="bound"><span class="entity">inv_Ran</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span>"</span></span>

<span class="comment1">(*========================================================================*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‚Äπ Is test and type coercions ‚Ä∫</span></span>
<span class="comment1">(*========================================================================*)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚Äπ Basic type coercions ‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">is_VDMRealWhole</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"VDMReal <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">is_VDMRealWhole</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">‚â°</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">‚â•</span> <span class="main">1</span> <span class="main">‚àß</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">-</span> real_of_int <span class="main">(</span>vdm_narrow_real <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">vdmint_of_real</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"VDMReal <span class="main">‚áÄ</span> VDMInt"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">vdmint_of_real</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">‚â°</span> <span class="keyword1">if</span> is_VDMRealWhole <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">then</span> Some <span class="main">(</span>vdm_narrow_real <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="keyword1">else</span> None"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">is_VDMRatWhole</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"VDMRat <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">is_VDMRatWhole</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">‚â°</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">‚â•</span> <span class="main">1</span> <span class="main">‚àß</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">-</span> rat_of_int <span class="main">(</span>vdm_narrow_real <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">vdmint_of_rat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"VDMRat <span class="main">‚áÄ</span> VDMInt"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">vdmint_of_rat</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">‚â°</span> <span class="keyword1">if</span> is_VDMRatWhole <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">then</span> Some <span class="main">(</span>vdm_narrow_real <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="keyword1">else</span> None"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚Äπ Structured type coercions ‚Ä∫</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> VDMTypeCoercion <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">‚áÄ</span> <span class="tfree">'b</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπA total VDM type coercion is one where every element in the type space of
      interest is convertible under the given type coercion 
      (e.g., set of real = {1,2,3} into set of nat is total; whereas 
             set of real = {0.5,2,3} into set of nat is not total given 0.5 is not nat).  
     ‚Ä∫</span></span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">total_coercion</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> VDMSet <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> VDMTypeCoercion <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">total_coercion</span> <span class="free"><span class="bound"><span class="entity">space</span></span></span> <span class="free"><span class="bound"><span class="entity">conv</span></span></span> <span class="main">‚â°</span> <span class="main">(</span><span class="main">‚àÄ</span> <span class="bound">i</span> <span class="main">‚àà</span> <span class="free"><span class="bound"><span class="entity">space</span></span></span> <span class="main">.</span> <span class="free"><span class="bound"><span class="entity">conv</span></span></span> <span class="bound">i</span> <span class="main">‚â†</span> None<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπTo convert a VDM set s of type 'a into type 'b (e.g., set of real into set of nat),
      it must be possible to convert every element of s under given type coercion
     ‚Ä∫</span></span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">vdmset_of_t</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> VDMTypeCoercion <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span> VDMSet<span class="main">,</span> <span class="tfree">'b</span> VDMSet<span class="main">)</span> VDMTypeCoercion"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">vdmset_of_t</span> <span class="free"><span class="bound"><span class="entity">conv</span></span></span> <span class="main">‚â°</span> 
      <span class="main">(</span><span class="main">Œª</span> <span class="bound">x</span> <span class="main">.</span> <span class="keyword1">if</span> total_coercion <span class="bound">x</span> <span class="free"><span class="bound"><span class="entity">conv</span></span></span> <span class="keyword1">then</span>
                Some <span class="main">{</span> the<span class="main">(</span><span class="free"><span class="bound"><span class="entity">conv</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="main">|</span> <span class="bound">i</span> <span class="main">.</span> <span class="bound">i</span> <span class="main">‚àà</span> <span class="bound">x</span> <span class="main">‚àß</span> <span class="free"><span class="bound"><span class="entity">conv</span></span></span> <span class="bound">i</span> <span class="main">‚â†</span> None <span class="main">}</span>
             <span class="keyword1">else</span>
                None<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπTo convert a VDM seq s of type 'a into type 'b (e.g., seq of real into seq of nat),
      it must be possible to convert every element of s under given type coercion
     ‚Ä∫</span></span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">vdmseq_of_t</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> VDMTypeCoercion <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span> VDMSeq<span class="main">,</span> <span class="tfree">'b</span> VDMSeq<span class="main">)</span> VDMTypeCoercion"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">vdmseq_of_t</span> <span class="free"><span class="bound"><span class="entity">conv</span></span></span> <span class="main">‚â°</span> 
      <span class="main">(</span><span class="main">Œª</span> <span class="bound">x</span> <span class="main">.</span> <span class="keyword1">if</span> total_coercion <span class="main">(</span>elems <span class="bound">x</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">conv</span></span></span> <span class="keyword1">then</span>
                Some <span class="main">[</span> the<span class="main">(</span><span class="free"><span class="bound"><span class="entity">conv</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="main">.</span> i <span class="main">‚Üê</span> <span class="bound">x</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">conv</span></span></span> <span class="bound">i</span> <span class="main">‚â†</span> None <span class="main">]</span>
             <span class="keyword1">else</span>
                None<span class="main">)</span>"</span></span>

<span class="comment1">(* map coercion will be tricky because result d2 depends on dconv call, which needs x's d1!
definition 
  vdmmap_of_dr :: "('d1, 'd2) VDMTypeCoercion ‚áí ('r1, 'r2) VDMTypeCoercion ‚áí ('d1 ‚áÄ 'r1, 'd2 ‚áÄ 'r2) VDMTypeCoercion" 
  where
  "vdmmap_of_dr dconv rconv ‚â° 
      ‚Äï ‚Äπx is a 'd1 ‚áÄ 'r1, d is a 'd2 ‚áí 'r2; where dconv/rconv is applied throughout and succeeded‚Ä∫
      (Œª x . if total_coercion (dom x) dconv ‚àß total_coercion (rng x) rconv then 
                Some (Œª d . if (‚àÉ xd . d = dconv xd) then None else None)
             else
                None)"
*)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚Äπ Is tests ‚Ä∫</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚Äπ"Successful" is expr test is simply a call to the test expression invariant‚Ä∫</span></span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">isTest</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áí</span> <span class="main">ùîπ</span><span class="main">)</span> <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">isTest</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">inv_X</span></span></span> <span class="main">‚â°</span> <span class="free"><span class="bound"><span class="entity">inv_X</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> l_isTestI<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"isTest <span class="free">x</span> <span class="free">inv_X</span> <span class="main">=</span> <span class="free">inv_X</span> <span class="free">x</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> isTest_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπPossibly failing is expr tests up to given type coercion ‚Ä∫</span></span>
<span class="keyword1"><span class="command">definition</span></span> 
  <span class="entity">isTest'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> VDMTypeCoercion <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">‚áí</span> <span class="main">ùîπ</span><span class="main">)</span> <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">isTest'</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">conv</span></span></span> <span class="free"><span class="bound"><span class="entity">inv_X</span></span></span> <span class="main">‚â°</span> 
    <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">conv</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span>
        None <span class="main">‚áí</span> False 
      <span class="main">|</span> Some <span class="bound">x</span> <span class="main">‚áí</span> <span class="free"><span class="bound"><span class="entity">inv_X</span></span></span> <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="comment1">(*========================================================================*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‚Äπ Well founded relation useful for sets in recursive functions ‚Ä∫</span></span>
<span class="comment1">(*========================================================================*)</span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">gen_set_term</span> <span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> VDMSet <span class="main">√ó</span> <span class="tfree">'a</span> VDMSet<span class="main">)</span> VDMSet <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span> VDMSet <span class="main">√ó</span> <span class="tfree">'a</span> VDMSet<span class="main">)</span> VDMSet"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">gen_set_term</span> <span class="free"><span class="bound"><span class="entity">rel</span></span></span> <span class="main">‚â°</span> finite_psubset <span class="main">‚à©</span> <span class="free"><span class="bound"><span class="entity">rel</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">gen_VDMInt_term</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚ÄπVDMInt <span class="main">‚áí</span> <span class="main">(</span>VDMInt <span class="main">√ó</span> VDMInt<span class="main">)</span> set <span class="main">‚áí</span> <span class="main">(</span>VDMInt <span class="main">√ó</span> VDMInt<span class="main">)</span> set‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">gen_VDMInt_term</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">rel</span></span></span> <span class="main">‚â°</span> <span class="main">(</span>int_ge_less_than <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">‚à©</span> <span class="free"><span class="bound"><span class="entity">rel</span></span></span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">gen_VDMNat_term</span> <span class="main">::</span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span>VDMNat <span class="main">√ó</span> VDMNat<span class="main">)</span> set <span class="main">‚áí</span> <span class="main">(</span>VDMNat <span class="main">√ó</span> VDMNat<span class="main">)</span> set‚Ä∫</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">‚Äπ<span class="free">gen_VDMNat_term</span> <span class="free"><span class="bound"><span class="entity">rel</span></span></span> <span class="main">‚â°</span> gen_VDMInt_term <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">rel</span></span></span>‚Ä∫</span></span>

<span class="keyword1"><span class="command">lemma</span></span> l_gen_set_term_wf<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="main">(</span>gen_set_term <span class="free">rel</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_Int1<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_gen_VDMInt_term_wf<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="main">(</span>gen_VDMInt_term <span class="free">d</span> <span class="free">rel</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_Int1 wf_int_ge_less_than<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_gen_VDMNat_term_wf<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="main">(</span>gen_VDMNat_term <span class="free">rel</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_Int1 wf_int_ge_less_than<span class="main">)</span>

<span class="comment1">(*========================================================================*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‚Äπ Set operators lemmas ‚Ä∫</span></span>
<span class="comment1">(*========================================================================*)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_psubset_insert<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">‚àâ</span> <span class="free">S</span> <span class="main">‚üπ</span> <span class="free">S</span> <span class="main">‚äÇ</span> insert <span class="free">x</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> l_right_diff_left_dist<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">-</span> <span class="main">(</span><span class="free">T</span> <span class="main">-</span> <span class="free">U</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span> <span class="main">‚à™</span> <span class="main">(</span><span class="free">S</span> <span class="main">‚à©</span> <span class="free">U</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_Compl Diff_Int diff_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">thm</span></span> Diff_Compl
      Diff_Int
      diff_eq

<span class="keyword1"><span class="command">lemma</span></span> l_diff_un_not_equal<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">‚äÇ</span> <span class="free">T</span> <span class="main">‚üπ</span> <span class="free">T</span> <span class="main">‚äÜ</span> <span class="free">S</span>  <span class="main">‚üπ</span> <span class="free">S</span> <span class="main">-</span> <span class="free">T</span> <span class="main">‚à™</span> <span class="free">R</span> <span class="main">‚â†</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="comment1">(*========================================================================*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‚Äπ Map operators lemmas ‚Ä∫</span></span>
<span class="comment1">(*========================================================================*)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_map_non_empty_has_elem_conv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">‚â†</span> Map.empty <span class="main">‚ü∑</span> <span class="main">(</span><span class="main">‚àÉ</span> <span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">‚àà</span> dom <span class="free">g</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domIff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_map_non_empty_dom_conv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">‚â†</span> Map.empty <span class="main">‚ü∑</span> dom <span class="free">g</span> <span class="main">‚â†</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dom_eq_empty_conv<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_map_non_empty_ran_conv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">‚â†</span> Map.empty <span class="main">‚ü∑</span> ran <span class="free">g</span> <span class="main">‚â†</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> empty_iff equals0I 
          fun_upd_triv option.exhaust 
          ranI ran_restrictD restrict_complement_singleton_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_finite_rng<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="free">m</span><span class="main">)</span> <span class="main">‚üπ</span> finite <span class="main">(</span>rng <span class="free">m</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_ran rng_def<span class="main">)</span>
<span class="comment1">(* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ *)</span>
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‚Äπ Domain restriction weakening lemmas [EXPERT] ‚Ä∫</span></span>
<span class="comment1">(* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ *)</span>

<span class="comment1">(* Lemma: dom restriction set inter equiv [ZEVES-LEMMA] *)</span>
<span class="keyword1"><span class="command">lemma</span></span> l_dom_r_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"dom<span class="main">(</span><span class="free">S</span> <span class="main">‚óÉ</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="free">S</span> <span class="main">‚à©</span> dom <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Int_commute dom_restr_def dom_restrict<span class="main">)</span>

<span class="comment1">(* Lemma: dom restriction set inter equiv [ZEVES-LEMMA] *)</span>
<span class="keyword1"><span class="command">lemma</span></span> l_dom_r_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">S</span> <span class="main">‚óÉ</span> <span class="free">g</span><span class="main">)</span> <span class="keyword1">‚äÜ<span class="hidden">‚á©</span><sub>m</sub></span> <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Int_iff dom_restr_def l_dom_r_iff map_le_def restrict_in<span class="main">)</span>

<span class="comment1">(* Lemma: dom restriction set inter equiv [ZEVES-LEMMA] *)</span>
<span class="keyword1"><span class="command">lemma</span></span> l_dom_r_accum<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">‚óÉ</span> <span class="main">(</span><span class="free">T</span> <span class="main">‚óÉ</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">S</span> <span class="main">‚à©</span> <span class="free">T</span><span class="main">)</span> <span class="main">‚óÉ</span> <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Int_commute dom_restr_def restrict_restrict<span class="main">)</span>

<span class="comment1">(* Lemma: dom restriction set inter equiv [ZEVES-LEMMA] *)</span>
<span class="keyword1"><span class="command">lemma</span></span> l_dom_r_nothing<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">‚óÉ</span> <span class="free">f</span> <span class="main">=</span> Map.empty"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dom_restr_def restrict_map_to_empty<span class="main">)</span>

<span class="comment1">(* Lemma: dom restriction set inter equiv [ZEVES-LEMMA] *)</span>
<span class="keyword1"><span class="command">lemma</span></span> l_dom_r_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">‚óÉ</span> Map.empty <span class="main">=</span> Map.empty"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dom_restr_def restrict_map_empty<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_dres_absorb<span class="main">:</span> <span class="quoted"><span class="quoted">"UNIV <span class="main">‚óÉ</span> <span class="free">m</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dom_restr_def map_le_antisym map_le_def<span class="main">)</span>  
  
<span class="keyword1"><span class="command">lemma</span></span> l_dom_r_nothing_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">‚üπ</span> <span class="free">S</span> <span class="main">‚óÉ</span> <span class="free">f</span> <span class="main">=</span> Map.empty"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> l_dom_r_nothing<span class="main">)</span>
<span class="comment1">(* FD: in specific dom subsumes application (over Some+None) [ZEVES-LEMMA] *)</span>
<span class="comment1">(*
lemmX f_in_dom_r_apply_elem: 
  "l ‚àà dom f ‚àß l ‚àà S ‚üπ ((S ‚óÉ f) l) = (f l)"
unfolding dom_restr_def
by (cases "l‚ààS", auto)
*)</span>
<span class="comment1">(* Simplified as doesn't need the l:dom f case *)</span>
<span class="keyword1"><span class="command">lemma</span></span>  f_in_dom_r_apply_elem<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="free">x</span> <span class="main">‚àà</span> <span class="free">S</span> <span class="main">‚üπ</span> <span class="main">(</span><span class="main">(</span><span class="free">S</span> <span class="main">‚óÉ</span> <span class="free">f</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dom_restr_def restrict_in<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span>  f_in_dom_r_apply_the_elem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">‚àà</span> dom <span class="free">f</span> <span class="main">‚üπ</span> <span class="free">x</span> <span class="main">‚àà</span> <span class="free">S</span> <span class="main">‚üπ</span> <span class="main">(</span><span class="main">(</span><span class="free">S</span> <span class="main">‚óÉ</span> <span class="free">f</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> Some<span class="main">(</span>the<span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domIff f_in_dom_r_apply_elem option.collapse<span class="main">)</span>

<span class="comment1">(* TODO: classify; rename. *)</span> 
<span class="keyword1"><span class="command">lemma</span></span> l_dom_r_disjoint_weakening<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">‚à©</span> <span class="free">B</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">‚üπ</span> dom<span class="main">(</span><span class="free">A</span> <span class="main">‚óÉ</span> <span class="free">f</span><span class="main">)</span> <span class="main">‚à©</span> dom<span class="main">(</span><span class="free">B</span> <span class="main">‚óÉ</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dom_restr_def dom_restrict inf_bot_right inf_left_commute restrict_restrict<span class="main">)</span>

<span class="comment1">(* TODO: classify; rename - refactor out for l_dom_r_iff? *)</span>
<span class="keyword1"><span class="command">lemma</span></span> l_dom_r_subseteq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">‚äÜ</span> dom <span class="free">f</span> <span class="main">‚üπ</span> dom <span class="main">(</span><span class="free">S</span> <span class="main">‚óÉ</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dom_restr_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Int_absorb1 dom_restrict<span class="main">)</span>

<span class="comment1">(* TODO: classift; rename  - refactor out for l_dom_r_subset? *)</span>
<span class="keyword1"><span class="command">lemma</span></span> l_dom_r_dom_subseteq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>dom <span class="main">(</span> <span class="free">S</span> <span class="main">‚óÉ</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="main">‚äÜ</span> dom <span class="free">f</span>"</span></span> 
<span class="keyword1"><span class="command">unfolding</span></span> dom_restr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> l_the_dom_r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">‚àà</span> dom <span class="free">f</span> <span class="main">‚üπ</span> <span class="free">x</span> <span class="main">‚àà</span> <span class="free">S</span> <span class="main">‚üπ</span> the <span class="main">(</span><span class="main">(</span> <span class="free">S</span> <span class="main">‚óÉ</span> <span class="free">f</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> the <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> f_in_dom_r_apply_elem<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_in_dom_dom_r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">‚àà</span> dom <span class="main">(</span><span class="free">S</span> <span class="main">‚óÉ</span> <span class="free">f</span><span class="main">)</span> <span class="main">‚üπ</span> <span class="free">x</span> <span class="main">‚àà</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Int_iff l_dom_r_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_dom_r_singleton<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">‚àà</span> dom <span class="free">f</span> <span class="main">‚üπ</span> <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">‚óÉ</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="free">x</span> <span class="main">‚Ü¶</span> the <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> dom_restr_def
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> singleton_map_dom<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"dom <span class="free">f</span> <span class="main">=</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="main">[</span><span class="free">x</span> <span class="main">‚Ü¶</span> the <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
<span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="main">[</span><span class="free">x</span> <span class="main">‚Ü¶</span> <span class="skolem">y</span><span class="main">]</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dom_eq_singleton_conv<span class="main">)</span>
<span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> the <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fun_upd_same option.sel<span class="main">)</span>
<span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">`<span class="free">f</span> <span class="main">=</span> <span class="main">[</span><span class="free">x</span> <span class="main">‚Ü¶</span> <span class="skolem">y</span><span class="main">]</span>`</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> l_relimg_ran_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ran <span class="main">(</span><span class="free">S</span> <span class="main">‚óÉ</span> <span class="free">m</span><span class="main">)</span> <span class="main">‚äÜ</span> ran <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> dom_restr_def ranI ran_restrictD subsetI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> f_in_relimg_ran<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">‚àà</span> ran <span class="main">(</span><span class="free">S</span> <span class="main">‚óÉ</span> <span class="free">m</span><span class="main">)</span> <span class="main">‚üπ</span> <span class="free">y</span> <span class="main">‚àà</span> ran <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> l_relimg_ran_subset subsetCE<span class="main">)</span>

<span class="comment1">(* An experiment - not sure which are the best rules to choose! *)</span>
<span class="keyword1"><span class="command">lemmas</span></span> restr_simps <span class="main">=</span> l_dom_r_iff l_dom_r_accum l_dom_r_nothing l_dom_r_empty
                     f_in_dom_r_apply_elem l_dom_r_disjoint_weakening l_dom_r_subseteq
                     l_dom_r_dom_subseteq

<span class="comment1">(* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ *)</span>
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‚Äπ Domain anti restriction weakening lemmas [EXPERT] ‚Ä∫</span></span>
<span class="comment1">(* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ *)</span>

<span class="comment1">(* FD: dom elem subsume dom ar *)</span>
<span class="keyword1"><span class="command">lemma</span></span> f_in_dom_ar_subsume<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">‚àà</span> dom <span class="main">(</span><span class="free">S</span> <span class="main">-‚óÉ</span> <span class="free">f</span><span class="main">)</span> <span class="main">‚üπ</span>  <span class="free">l</span> <span class="main">‚àà</span> dom <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> dom_antirestr_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">‚àà</span><span class="free">S</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="comment1">(* FD: in specific dom_ar cannot be what's filtered *)</span>
<span class="keyword1"><span class="command">lemma</span></span> f_in_dom_ar_notelem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">‚àà</span> dom <span class="main">(</span><span class="main">{</span><span class="free">r</span><span class="main">}</span> <span class="main">-‚óÉ</span> <span class="free">f</span><span class="main">)</span> <span class="main">‚üπ</span> <span class="free">l</span> <span class="main">‚â†</span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> dom_antirestr_def
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(* FD: in specific dom_ar subsumes application (over Some) *)</span>
<span class="keyword1"><span class="command">lemma</span></span> f_in_dom_ar_the_subsume<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">‚àà</span> dom <span class="main">(</span><span class="free">S</span> <span class="main">-‚óÉ</span> <span class="free">f</span><span class="main">)</span> <span class="main">‚üπ</span> the <span class="main">(</span><span class="main">(</span><span class="free">S</span> <span class="main">-‚óÉ</span> <span class="free">f</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span> the <span class="main">(</span><span class="free">f</span> <span class="free">l</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> dom_antirestr_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">‚àà</span><span class="free">S</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="comment1">(* FD: in specific dom_ar subsumes application (over Some+None) *)</span>
<span class="keyword1"><span class="command">lemma</span></span> f_in_dom_ar_apply_subsume<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">‚àà</span> dom <span class="main">(</span><span class="free">S</span> <span class="main">-‚óÉ</span> <span class="free">f</span><span class="main">)</span> <span class="main">‚üπ</span> <span class="main">(</span><span class="main">(</span><span class="free">S</span> <span class="main">-‚óÉ</span> <span class="free">f</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="free">l</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> dom_antirestr_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">‚àà</span><span class="free">S</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="comment1">(* FD: in specific dom subsumes application (over Some+None) [ZEVES-LEMMA] *)</span>
<span class="comment1">(*
lemmX f_in_dom_ar_apply_not_elem: 
  "l ‚àà dom f ‚àß l ‚àâ S ‚üπ ((S -‚óÉ f) l) = (f l)"
unfolding dom_antirestr_def
by (cases "l‚ààS", auto)
*)</span>
<span class="comment1">(* TODO: I had a more general lemma: *)</span>
<span class="keyword1"><span class="command">lemma</span></span> f_in_dom_ar_apply_not_elem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">‚àâ</span> <span class="free">S</span> <span class="main">‚üπ</span> <span class="main">(</span><span class="free">S</span> <span class="main">-‚óÉ</span> <span class="free">f</span><span class="main">)</span> <span class="free">l</span> <span class="main">=</span> <span class="free">f</span> <span class="free">l</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dom_antirestr_def<span class="main">)</span>

<span class="comment1">(* FD: dom_ar subset dom [ZEVES-LEMMA] *)</span>
<span class="keyword1"><span class="command">lemma</span></span> f_dom_ar_subset_dom<span class="main">:</span>
	<span class="quoted"><span class="quoted">"dom<span class="main">(</span><span class="free">S</span> <span class="main">-‚óÉ</span> <span class="free">f</span><span class="main">)</span> <span class="main">‚äÜ</span> dom <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> dom_antirestr_def dom_def
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(* Lemma: dom_ar as set different [ZEVES-LEMMA] *)</span>
<span class="keyword1"><span class="command">lemma</span></span> l_dom_dom_ar<span class="main">:</span>
	<span class="quoted"><span class="quoted">"dom<span class="main">(</span><span class="free">S</span> <span class="main">-‚óÉ</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> dom <span class="free">f</span> <span class="main">-</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> dom_antirestr_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Collect_cong domIff dom_def set_diff_eq<span class="main">)</span>

<span class="comment1">(* Lemma: dom_ar accumulates to left [ZEVES-LEMMA] *)</span>
<span class="keyword1"><span class="command">lemma</span></span> l_dom_ar_accum<span class="main">:</span>
	<span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">-‚óÉ</span> <span class="main">(</span><span class="free">T</span> <span class="main">-‚óÉ</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">S</span> <span class="main">‚à™</span> <span class="free">T</span><span class="main">)</span> <span class="main">-‚óÉ</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> dom_antirestr_def
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(* Lemma: dom_ar subsumption [ZEVES-LEMMA] *)</span>
<span class="keyword1"><span class="command">lemma</span></span> l_dom_ar_nothing<span class="main">:</span>
	<span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">‚à©</span> dom <span class="free">f</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">‚üπ</span> <span class="free">S</span> <span class="main">-‚óÉ</span> <span class="free">f</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> dom_antirestr_def
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> disjoint_iff_not_equal domIff<span class="main">)</span>

<span class="comment1">(* NOTE: After finding fun_eq_iff, there is also map_le_antisym for maps!*)</span>

<span class="comment1">(* Lemma: dom_ar nothing LHS [ZEVES-LEMMA] *)</span>
<span class="keyword1"><span class="command">lemma</span></span> l_dom_ar_empty_lhs<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">-‚óÉ</span> <span class="free">f</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Int_empty_left l_dom_ar_nothing<span class="main">)</span>

<span class="comment1">(* Lemma: dom_ar nothing RHS [ZEVES-LEMMA] *)</span>
<span class="keyword1"><span class="command">lemma</span></span> l_dom_ar_empty_rhs<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">-‚óÉ</span> Map.empty <span class="main">=</span> Map.empty"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Int_empty_right dom_empty l_dom_ar_nothing<span class="main">)</span>

<span class="comment1">(* Lemma: dom_ar all RHS is empty [ZEVES-LEMMA] *)</span>
<span class="keyword1"><span class="command">lemma</span></span> l_dom_ar_everything<span class="main">:</span>
  <span class="quoted"><span class="quoted">"dom <span class="free">f</span> <span class="main">‚äÜ</span> <span class="free">S</span> <span class="main">‚üπ</span> <span class="free">S</span> <span class="main">-‚óÉ</span> <span class="free">f</span> <span class="main">=</span> Map.empty"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domIff dom_antirestr_def in_mono<span class="main">)</span>

<span class="comment1">(* Lemma: dom_ar submap [ZEVES-LEMMA] *)</span>
<span class="keyword1"><span class="command">lemma</span></span> l_map_dom_ar_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">-‚óÉ</span> <span class="free">f</span> <span class="keyword1">‚äÜ<span class="hidden">‚á©</span><sub>m</sub></span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domIff dom_antirestr_def map_le_def<span class="main">)</span>

<span class="comment1">(* Lemma: dom_ar nothing RHS is f [ZEVES-LEMMA] *)</span>
<span class="keyword1"><span class="command">lemma</span></span> l_dom_ar_none<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">-‚óÉ</span> <span class="free">f</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> dom_antirestr_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>

<span class="comment1">(* Lemma: dom_ar something RHS isn't f [ZEVES-LEMMA] *)</span>
<span class="keyword1"><span class="command">lemma</span></span> l_map_dom_ar_neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">‚äÜ</span> dom <span class="free">f</span> <span class="main">‚üπ</span> <span class="free">S</span> <span class="main">‚â†</span> <span class="main">{}</span> <span class="main">‚üπ</span> <span class="free">S</span> <span class="main">-‚óÉ</span> <span class="free">f</span> <span class="main">‚â†</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fun_eq_iff<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> ex_in_conv<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">S</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> exE<span class="main">)</span>
<span class="keyword1"><span class="command">unfolding</span></span> dom_antirestr_def
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> impI conjI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domIff set_mp<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_dom_rres_same_map_weaken<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">=</span> <span class="free">T</span> <span class="main">‚üπ</span> <span class="main">(</span><span class="free">S</span> <span class="main">-‚óÉ</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">T</span> <span class="main">-‚óÉ</span> <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>   

<span class="comment1">(*  TODO classify; rename *)</span>
<span class="keyword1"><span class="command">lemma</span></span> l_dom_ar_not_in_dom<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">‚àâ</span> dom <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">‚àâ</span> dom <span class="main">(</span><span class="free">s</span> <span class="main">-‚óÉ</span> <span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> * domIff dom_antirestr_def<span class="main">)</span>

<span class="comment1">(*  TODO: classify; rename *)</span>
<span class="keyword1"><span class="command">lemma</span></span> l_dom_ar_not_in_dom2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">‚àà</span> <span class="free">F</span> <span class="main">‚üπ</span> <span class="free">x</span> <span class="main">‚àâ</span> dom <span class="main">(</span><span class="free">F</span>  <span class="main">-‚óÉ</span> <span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domIff dom_antirestr_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_dom_ar_notin_dom_or<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">‚àâ</span> dom <span class="free">f</span> <span class="main">‚à®</span> <span class="free">x</span> <span class="main">‚àà</span> <span class="free">S</span> <span class="main">‚üπ</span> <span class="free">x</span> <span class="main">‚àâ</span> dom <span class="main">(</span><span class="free">S</span> <span class="main">-‚óÉ</span> <span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_iff l_dom_dom_ar<span class="main">)</span>

<span class="comment1">(*  TODO: classify - shows conditions for being in antri restr dom *)</span>
<span class="keyword1"><span class="command">lemma</span></span> l_in_dom_ar<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">‚àâ</span> <span class="free">F</span> <span class="main">‚üπ</span> <span class="free">x</span> <span class="main">‚àà</span> dom <span class="free">f</span> <span class="main">‚üπ</span> <span class="free">x</span> <span class="main">‚àà</span> dom  <span class="main">(</span><span class="free">F</span>  <span class="main">-‚óÉ</span> <span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> f_in_dom_ar_apply_not_elem domIff<span class="main">)</span> 

<span class="keyword1"><span class="command">lemma</span></span> l_Some_in_dom<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">y</span> <span class="main">‚üπ</span> <span class="free">x</span> <span class="main">‚àà</span> dom <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(*  TODO: classify; fix proof; rename; decide whether needed?! *)</span>
<span class="keyword1"><span class="command">lemma</span></span> l_dom_ar_insert<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>insert <span class="free">x</span> <span class="free">F</span><span class="main">)</span> <span class="main">-‚óÉ</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">-‚óÉ</span> <span class="main">(</span><span class="free">F</span><span class="main">-‚óÉ</span> <span class="free">f</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xa</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>insert <span class="free">x</span> <span class="free">F</span> <span class="main">-‚óÉ</span> <span class="free">f</span><span class="main">)</span> <span class="skolem">xa</span> <span class="main">=</span> <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">-‚óÉ</span> <span class="free">F</span> <span class="main">-‚óÉ</span> <span class="free">f</span><span class="main">)</span> <span class="skolem">xa</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">=</span> <span class="skolem">xa</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dom_antirestr_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span><span class="main">‚àà</span><span class="free">F</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dom_antirestr_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> f_in_dom_ar_apply_not_elem<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> f_in_dom_ar_apply_not_elem<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> f_in_dom_ar_apply_not_elem<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>  
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="comment1">(*  TODO: classify; rename?; subsume by l_dom_ar_accum? *)</span>
<span class="comment1">(*  Think it may also be unused? *)</span>
<span class="keyword1"><span class="command">lemma</span></span> l_dom_ar_absorb_singleton<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">‚àà</span> <span class="free">F</span> <span class="main">‚üπ</span> <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">-‚óÉ</span> <span class="free">F</span> <span class="main">-‚óÉ</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span><span class="main">(</span><span class="free">F</span> <span class="main">-‚óÉ</span> <span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> l_dom_ar_insert insert_absorb<span class="main">)</span>

<span class="comment1">(*  TODO: rename; classify; generalise? *)</span>
<span class="keyword1"><span class="command">lemma</span></span> l_dom_ar_disjoint_weakening<span class="main">:</span>
  <span class="quoted"><span class="quoted">"dom <span class="free">f</span> <span class="main">‚à©</span> <span class="free">Y</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">‚üπ</span> dom <span class="main">(</span><span class="free">X</span> <span class="main">-‚óÉ</span> <span class="free">f</span><span class="main">)</span> <span class="main">‚à©</span> <span class="free">Y</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> 
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_Int_distrib2 empty_Diff l_dom_dom_ar<span class="main">)</span>

<span class="comment1">(* TODO: not used? *)</span>
<span class="keyword1"><span class="command">lemma</span></span> l_dom_ar_singletons_comm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">-‚óÉ</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span> <span class="main">-‚óÉ</span> <span class="free">f</span> <span class="main">=</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span><span class="main">-‚óÉ</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">-‚óÉ</span> <span class="free">f</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> l_dom_ar_insert insert_commute<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_dom_r_ar_set_minus<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">‚óÉ</span> <span class="main">(</span><span class="free">T</span> <span class="main">-‚óÉ</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">S</span> <span class="main">-</span> <span class="free">T</span><span class="main">)</span> <span class="main">‚óÉ</span> <span class="free">m</span>"</span></span> 
  <span class="keyword1"><span class="command">find_theorems</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="main">_</span>"</span></span> name<span class="main">:</span>HOL name<span class="main">:</span><span class="quoted">"fun"</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> dom_restr_def dom_antirestr_def restrict_map_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> l_VDMMap_filtering_psubset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">‚àà</span> dom <span class="free">m</span> <span class="main">‚üπ</span> dom <span class="main">(</span><span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="main">-‚óÉ</span> <span class="free">m</span><span class="main">)</span> <span class="main">‚äÇ</span> dom <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">find_theorems</span></span> <span class="quoted"><span class="quoted">‚Äπ<span class="main">(</span><span class="main">_</span> <span class="main">-‚óÉ</span> <span class="main">_</span><span class="main">)</span>‚Ä∫</span></span>  
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> psubsetI f_dom_ar_subset_dom<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> f_in_dom_ar_notelem<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_VDMMap_filtering_card<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="free">m</span><span class="main">)</span> <span class="main">‚üπ</span> <span class="free">d</span> <span class="main">‚àà</span> dom <span class="free">m</span> <span class="main">‚üπ</span> card <span class="main">(</span>dom <span class="main">(</span><span class="main">{</span><span class="free">d</span><span class="main">}</span> <span class="main">-‚óÉ</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> card <span class="main">(</span>dom <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l_VDMMap_filtering_psubset psubset_card_mono<span class="main">)</span>


<span class="keyword1"><span class="command">lemmas</span></span> antirestr_simps <span class="main">=</span> f_in_dom_ar_subsume f_in_dom_ar_notelem f_in_dom_ar_the_subsume
f_in_dom_ar_apply_subsume f_in_dom_ar_apply_not_elem f_dom_ar_subset_dom
l_dom_dom_ar l_dom_ar_accum l_dom_ar_nothing l_dom_ar_empty_lhs l_dom_ar_empty_rhs
l_dom_ar_everything l_dom_ar_none l_dom_ar_not_in_dom l_dom_ar_not_in_dom2
l_dom_ar_notin_dom_or l_in_dom_ar l_dom_ar_disjoint_weakening l_VDMMap_filtering_psubset
l_VDMMap_filtering_card

<span class="comment1">(* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ *)</span>
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‚Äπ Map override weakening lemmas [EXPERT] ‚Ä∫</span></span>
<span class="comment1">(* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ *)</span>

<span class="comment1">(* Lemma: dagger associates [ZEVES-LEMMA] *)</span>
<span class="keyword1"><span class="command">lemma</span></span> l_dagger_assoc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">‚Ä†</span> <span class="main">(</span><span class="free">g</span> <span class="main">‚Ä†</span> <span class="free">h</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="main">‚Ä†</span> <span class="free">g</span><span class="main">)</span> <span class="main">‚Ä†</span> <span class="free">h</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dagger_def map_add_assoc<span class="main">)</span>
<span class="keyword1"><span class="command">thm</span></span> ext option.split fun_eq_iff <span class="comment1">(* EXT! Just found function extensionality! *)</span>

<span class="comment1">(* Lemma: dagger application [ZEVES-LEMMA] *)</span>
<span class="keyword1"><span class="command">lemma</span></span> l_dagger_apply<span class="main">:</span>
	<span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">‚Ä†</span> <span class="free">g</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">‚àà</span> dom <span class="free">g</span> <span class="keyword1">then</span> <span class="main">(</span><span class="free">g</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> dagger_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> map_add_dom_app_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> map_add_dom_app_simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="comment1">(* Lemma: dagger domain [ZEVES-LEMMA] *)</span>
<span class="keyword1"><span class="command">lemma</span></span> l_dagger_dom<span class="main">:</span>
	<span class="quoted"><span class="quoted">"dom<span class="main">(</span><span class="free">f</span> <span class="main">‚Ä†</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> dom <span class="free">f</span> <span class="main">‚à™</span> dom <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> dagger_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dom_map_add sup_commute<span class="main">)</span>

<span class="comment1">(* Lemma: dagger absorption LHS *)</span>
<span class="keyword1"><span class="command">lemma</span></span> l_dagger_lhs_absorb<span class="main">:</span>
  <span class="quoted"><span class="quoted">"dom <span class="free">f</span> <span class="main">‚äÜ</span> dom <span class="free">g</span> <span class="main">‚üπ</span> <span class="free">f</span> <span class="main">‚Ä†</span> <span class="free">g</span> <span class="main">=</span> <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span> 
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">metis</span> dagger_def l_dagger_apply map_add_dom_app_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> set_rev_mp<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_dagger_lhs_absorb_ALT_PROOF<span class="main">:</span>
  <span class="quoted"><span class="quoted">"dom <span class="free">f</span> <span class="main">‚äÜ</span> dom <span class="free">g</span> <span class="main">‚üπ</span> <span class="free">f</span> <span class="main">‚Ä†</span> <span class="free">g</span> <span class="main">=</span> <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l_dagger_apply<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span>
<span class="keyword1"><span class="command">find_theorems</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">‚àâ</span> <span class="main">_</span> <span class="main">‚üπ</span> <span class="main">_</span>"</span></span> name<span class="main">:</span>Set 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> contra_subsetD<span class="main">)</span>
<span class="keyword1"><span class="command">unfolding</span></span> dom_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>   <span class="comment1">(* NOTE: foun nice lemmas to be used: contra_subsetD*)</span>

<span class="comment1">(* Lemma: dagger empty absorption lhs [ZEVES-LEMMA] *)</span>
<span class="keyword1"><span class="command">lemma</span></span> l_dagger_empty_lhs<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Map.empty <span class="main">‚Ä†</span> <span class="free">f</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dagger_def empty_map_add<span class="main">)</span>

<span class="comment1">(* Lemma: dagger empty absorption rhs [ZEVES-LEMMA] *)</span>
<span class="keyword1"><span class="command">lemma</span></span> l_dagger_empty_rhs<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">‚Ä†</span> Map.empty <span class="main">=</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dagger_def map_add_empty<span class="main">)</span>

<span class="comment1">(* Interesting observation here:

A few times I have spotted this. I then to get these
lemmas and use them in Isar; whereas Leo, you don't seem
to use this variety. Probably because the automation takes
care of the reasoning?...
*)</span>
<span class="comment1">(*  TODO: Rename; classify *)</span>
<span class="keyword1"><span class="command">lemma</span></span> dagger_notemptyL<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">‚â†</span> Map.empty <span class="main">‚üπ</span> <span class="free">f</span> <span class="main">‚Ä†</span> <span class="free">g</span> <span class="main">‚â†</span> Map.empty"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dagger_def map_add_None<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> dagger_notemptyR<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">‚â†</span> Map.empty <span class="main">‚üπ</span> <span class="free">f</span> <span class="main">‚Ä†</span> <span class="free">g</span> <span class="main">‚â†</span> Map.empty"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dagger_def map_add_None<span class="main">)</span>


<span class="comment1">(* Lemma: dagger associates with dom_ar [ZEVES-LEMMA] *)</span>
<span class="comment1">(*  It's not really an assoc prop? Well, kinda, but also kinda distrib *)</span>
<span class="keyword1"><span class="command">lemma</span></span> l_dagger_dom_ar_assoc<span class="main">:</span>
	<span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">‚à©</span> dom <span class="free">g</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">‚üπ</span> <span class="main">(</span><span class="free">S</span> <span class="main">-‚óÉ</span> <span class="free">f</span><span class="main">)</span> <span class="main">‚Ä†</span> <span class="free">g</span> <span class="main">=</span> <span class="free">S</span> <span class="main">-‚óÉ</span> <span class="main">(</span><span class="free">f</span> <span class="main">‚Ä†</span> <span class="free">g</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l_dagger_apply<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> allI impI conjI<span class="main">)</span>
<span class="keyword1"><span class="command">unfolding</span></span> dom_antirestr_def
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l_dagger_apply<span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dom_antirestr_def l_dom_ar_nothing<span class="main">)</span>
<span class="keyword1"><span class="command">thm</span></span> map_add_comm
   <span class="comment1">(* NOTE: This should be provable, if only I know how to do map extensionality :-(. Now I do! fun_eq_iff! 
   			Thm map_add_comm is quite nice lemma two, and could be used here, yet l_dagger_apply seems nicer.
    *)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_dagger_not_empty<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">‚â†</span> Map.empty <span class="main">‚üπ</span> <span class="free">f</span> <span class="main">‚Ä†</span> <span class="free">g</span> <span class="main">‚â†</span> Map.empty"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dagger_def map_add_None<span class="main">)</span>

<span class="comment1">(* TODO: Following 6 need renamed; classified? LEO: how do you do such choices? *)</span>
<span class="keyword1"><span class="command">lemma</span></span> in_dagger_domL<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">‚àà</span> dom <span class="free">f</span> <span class="main">‚üπ</span> <span class="free">x</span> <span class="main">‚àà</span> dom<span class="main">(</span><span class="free">f</span> <span class="main">‚Ä†</span> <span class="free">g</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dagger_def domIff map_add_None<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> in_dagger_domR<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">‚àà</span> dom <span class="free">g</span> <span class="main">‚üπ</span> <span class="free">x</span> <span class="main">‚àà</span> dom<span class="main">(</span><span class="free">f</span> <span class="main">‚Ä†</span> <span class="free">g</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dagger_def domIff map_add_None<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> the_dagger_dom_right<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">‚àà</span> dom <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="main">(</span><span class="free">f</span> <span class="main">‚Ä†</span> <span class="free">g</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> the <span class="main">(</span><span class="free">g</span> <span class="free">x</span><span class="main">)</span>"</span></span>    
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms dagger_def map_add_dom_app_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> the_dagger_dom_left<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">‚àâ</span> dom <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="main">(</span><span class="free">f</span> <span class="main">‚Ä†</span> <span class="free">g</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> the <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms dagger_def map_add_dom_app_simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>    

<span class="keyword1"><span class="command">lemma</span></span> the_dagger_mapupd_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">‚â†</span><span class="free">y</span> <span class="main">‚üπ</span>  <span class="main">(</span><span class="free">f</span> <span class="main">‚Ä†</span> <span class="main">[</span><span class="free">y</span> <span class="main">‚Ü¶</span> <span class="free">z</span><span class="main">]</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="free">f</span> <span class="free">x</span> "</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dagger_def fun_upd_other map_add_empty map_add_upd<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> dagger_upd_dist<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">‚Ä†</span> <span class="free">fa</span><span class="main">(</span><span class="free">e</span> <span class="main">‚Ü¶</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="main">‚Ä†</span> <span class="free">fa</span><span class="main">)</span><span class="main">(</span><span class="free">e</span> <span class="main">‚Ü¶</span> <span class="free">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dagger_def map_add_upd<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> antirestr_then_dagger_notin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">‚àâ</span> dom <span class="free">f</span> <span class="main">‚üπ</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">-‚óÉ</span> <span class="main">(</span><span class="free">f</span> <span class="main">‚Ä†</span> <span class="main">[</span><span class="free">x</span> <span class="main">‚Ü¶</span> <span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">‚àâ</span> dom <span class="free">f</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">-‚óÉ</span> <span class="main">(</span><span class="free">f</span> <span class="main">‚Ä†</span> <span class="main">[</span><span class="free">x</span> <span class="main">‚Ü¶</span> <span class="free">y</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="skolem">z</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">z</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">`<span class="free">x</span> <span class="main">‚àâ</span> dom <span class="free">f</span>`</span></span>  domIff dom_antirestr_def fun_upd_other insertI1 l_dagger_apply singleton_iff<span class="main">)</span>  
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">lemma</span></span> antirestr_then_dagger<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main">‚àà</span> dom <span class="free">f</span> <span class="main">‚üπ</span> <span class="main">{</span><span class="free">r</span><span class="main">}</span> <span class="main">-‚óÉ</span> <span class="free">f</span> <span class="main">‚Ä†</span> <span class="main">[</span><span class="free">r</span> <span class="main">‚Ü¶</span> the <span class="main">(</span><span class="free">f</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main">‚àà</span>dom <span class="free">f</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{</span><span class="free">r</span><span class="main">}</span> <span class="main">-‚óÉ</span> <span class="free">f</span> <span class="main">‚Ä†</span> <span class="main">[</span><span class="free">r</span> <span class="main">‚Ü¶</span> the <span class="main">(</span><span class="free">f</span> <span class="free">r</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> l_dagger_apply<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span><span class="operator">intro</span> conjI impI<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">=</span><span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Some <span class="main">(</span>the <span class="main">(</span><span class="free">f</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">‚â†</span><span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" <span class="main">(</span><span class="main">{</span><span class="free">r</span><span class="main">}</span> <span class="main">-‚óÉ</span> <span class="free">f</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> f_in_dom_ar_apply_not_elem singleton_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> 


<span class="comment1">(* TODO: rename; classify *)</span>
<span class="keyword1"><span class="command">lemma</span></span> dagger_notin_right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">‚àâ</span> dom <span class="free">g</span> <span class="main">‚üπ</span> <span class="main">(</span><span class="free">f</span> <span class="main">‚Ä†</span> <span class="free">g</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="free">f</span> <span class="free">x</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> l_dagger_apply<span class="main">)</span>
<span class="comment1">(* TODO: rename; classify *)</span>

<span class="keyword1"><span class="command">lemma</span></span> dagger_notin_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">‚àâ</span> dom <span class="free">f</span> <span class="main">‚üπ</span> <span class="main">(</span><span class="free">f</span> <span class="main">‚Ä†</span> <span class="free">g</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="free">g</span> <span class="free">x</span>"</span></span>
 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dagger_def map_add_dom_app_simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_dagger_commute<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="free">f</span> <span class="main">‚à©</span> dom <span class="free">g</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">‚üπ</span><span class="free">f</span> <span class="main">‚Ä†</span> <span class="free">g</span> <span class="main">=</span> <span class="free">g</span> <span class="main">‚Ä†</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> dagger_def 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> map_add_comm<span class="main">)</span> 
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemmas</span></span> dagger_simps <span class="main">=</span> l_dagger_assoc l_dagger_apply l_dagger_dom l_dagger_lhs_absorb
l_dagger_empty_lhs l_dagger_empty_rhs dagger_notemptyL dagger_notemptyR l_dagger_not_empty
in_dagger_domL in_dagger_domR the_dagger_dom_right the_dagger_dom_left the_dagger_mapupd_dom
dagger_upd_dist antirestr_then_dagger_notin antirestr_then_dagger dagger_notin_right
dagger_notin_left

<span class="comment1">(* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ *)</span>
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‚Äπ Map update weakening lemmas [EXPERT] ‚Ä∫</span></span>
<span class="comment1">(* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ *)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚Äπ without the condition nitpick finds counter example ‚Ä∫</span></span>
<span class="keyword1"><span class="command">lemma</span></span> l_inmapupd_dom_iff<span class="main">:</span>  
  <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">‚â†</span> <span class="free">x</span> <span class="main">‚üπ</span> <span class="main">(</span><span class="free">l</span> <span class="main">‚àà</span> dom <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">x</span> <span class="main">‚Ü¶</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">l</span> <span class="main">‚àà</span> dom <span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> domIff fun_upd_apply<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_inmapupd_dom<span class="main">:</span>  
  <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">‚àà</span> dom <span class="free">f</span> <span class="main">‚üπ</span> <span class="free">l</span> <span class="main">‚àà</span> dom <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">x</span> <span class="main">‚Ü¶</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dom_fun_upd insert_iff option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_dom_extend<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">‚àâ</span> dom <span class="free">f</span> <span class="main">‚üπ</span>  dom <span class="main">(</span><span class="free">f1</span><span class="main">(</span><span class="free">x</span> <span class="main">‚Ü¶</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dom <span class="free">f1</span> <span class="main">‚à™</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> l_updatedom_eq<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">=</span><span class="free">l</span> <span class="main">‚üπ</span> the <span class="main">(</span><span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">x</span> <span class="main">‚Ü¶</span> the <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">-</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span> the <span class="main">(</span><span class="free">f</span> <span class="free">l</span><span class="main">)</span> <span class="main">-</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> l_updatedom_neq<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">‚â†</span><span class="free">l</span> <span class="main">‚üπ</span> the <span class="main">(</span><span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">x</span> <span class="main">‚Ü¶</span> the <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">-</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span> the <span class="main">(</span><span class="free">f</span> <span class="free">l</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">‚Äï ‚ÄπA helper lemma to have map update when domain is updated‚Ä∫</span>
<span class="keyword1"><span class="command">lemma</span></span> l_insertUpdSpec_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="free">f</span> <span class="main">=</span> insert <span class="free">x</span> <span class="free">F</span> <span class="main">‚üπ</span> <span class="main">(</span><span class="free">f0</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="main">|`</span> <span class="free">F</span><span class="main">)</span><span class="main">)</span> <span class="main">‚üπ</span> <span class="free">f</span> <span class="main">=</span> <span class="free">f0</span> <span class="main">(</span><span class="free">x</span> <span class="main">‚Ü¶</span> the <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">assume</span></span> insert<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="free">f</span> <span class="main">=</span> insert <span class="free">x</span> <span class="free">F</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">‚àà</span> dom <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="main">|`</span> <span class="free">F</span><span class="main">)</span><span class="main">(</span><span class="free">x</span> <span class="main">‚Ü¶</span> the <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert
         <span class="keyword1"><span class="command">unfolding</span></span> dom_def
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> l_the_map_union_right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">‚àà</span> dom <span class="free">g</span> <span class="main">‚üπ</span>dom <span class="free">f</span> <span class="main">‚à©</span> dom <span class="free">g</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">‚üπ</span> the <span class="main">(</span><span class="main">(</span><span class="free">f</span> <span class="keyword1">‚à™m</span> <span class="free">g</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> the <span class="main">(</span><span class="free">g</span> <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> l_dagger_apply munion_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_the_map_union_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">‚àà</span> dom <span class="free">f</span> <span class="main">‚üπ</span>dom <span class="free">f</span> <span class="main">‚à©</span> dom <span class="free">g</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">‚üπ</span> the <span class="main">(</span><span class="main">(</span><span class="free">f</span> <span class="keyword1">‚à™m</span> <span class="free">g</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> the <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> l_dagger_apply l_dagger_commute munion_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_the_map_union<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="free">f</span> <span class="main">‚à©</span> dom <span class="free">g</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">‚üπ</span> the <span class="main">(</span><span class="main">(</span><span class="free">f</span> <span class="keyword1">‚à™m</span> <span class="free">g</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">‚àà</span> dom <span class="free">f</span> <span class="keyword1">then</span> the <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">else</span> the <span class="main">(</span><span class="free">g</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> l_dagger_apply l_dagger_commute munion_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> upd_simps <span class="main">=</span> l_inmapupd_dom_iff l_inmapupd_dom l_dom_extend
                  l_updatedom_eq l_updatedom_neq

<span class="comment1">(* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ *)</span>
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‚Äπ Map union (VDM-specific) weakening lemmas [EXPERT] ‚Ä∫</span></span>
<span class="comment1">(* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ *)</span>

<span class="comment1">(* Weaken: munion point-wise update well-definedness condition *)</span>
<span class="keyword1"><span class="command">lemma</span></span> k_munion_map_upd_wd<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">‚àâ</span> dom <span class="free">f</span> <span class="main">‚üπ</span> dom <span class="free">f</span> <span class="main">‚à©</span> dom <span class="main">[</span><span class="free">x</span><span class="main">‚Ü¶</span> <span class="free">y</span><span class="main">]</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Int_empty_left Int_insert_left dom_eq_singleton_conv inf_commute<span class="main">)</span>
    <span class="comment1">(* NOTE: munion updates are often over singleton sets. This weakening rule 
             states that's enough to show x is not in f to enable the application
             of f ‚à™m [x ‚Ü¶ y].
     *)</span>

<span class="comment1">(* Lemma: munion application *)</span>
<span class="keyword1"><span class="command">lemma</span></span> l_munion_apply<span class="main">:</span>
	<span class="quoted"><span class="quoted">"dom <span class="free">f</span> <span class="main">‚à©</span> dom <span class="free">g</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">‚üπ</span> <span class="main">(</span><span class="free">f</span> <span class="keyword1">‚à™m</span> <span class="free">g</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">‚àà</span> dom <span class="free">g</span> <span class="keyword1">then</span> <span class="main">(</span><span class="free">g</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> munion_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l_dagger_apply<span class="main">)</span>

<span class="comment1">(* Lemma: munion domain *)</span>
<span class="keyword1"><span class="command">lemma</span></span> l_munion_dom<span class="main">:</span>
	<span class="quoted"><span class="quoted">"dom <span class="free">f</span> <span class="main">‚à©</span> dom <span class="free">g</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">‚üπ</span> dom<span class="main">(</span><span class="free">f</span> <span class="keyword1">‚à™m</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> dom <span class="free">f</span> <span class="main">‚à™</span> dom <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> munion_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l_dagger_dom<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_diff_union<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="free">B</span><span class="main">)</span> <span class="main">‚à™</span> <span class="free">C</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="main">‚à™</span> <span class="free">C</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="free">B</span> <span class="main">-</span> <span class="free">C</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Compl_Diff_eq Diff_eq Un_Int_distrib2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_munion_ran<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="free">f</span> <span class="main">‚à©</span> dom <span class="free">g</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">‚üπ</span> ran<span class="main">(</span><span class="free">f</span> <span class="keyword1">‚à™m</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> ran <span class="free">f</span> <span class="main">‚à™</span> ran <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> munion_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">find_theorems</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span> <span class="main">‚Ä†</span> <span class="main">_</span><span class="main">)</span> <span class="main">=</span> <span class="main">_</span>"</span></span>
<span class="comment1">(*apply (simp add: b_dagger_munion)*)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> set_eqI iffI<span class="main">)</span>
<span class="keyword1"><span class="command">unfolding</span></span> ran_def 
<span class="keyword1"><span class="command">thm</span></span> l_dagger_apply
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l_dagger_apply split_ifs<span class="main">)</span>

<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Int_iff all_not_in_conv domIff option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="comment1">(* Bridge: dagger defined through munion [ZEVES-LEMMA] *)</span>
<span class="keyword1"><span class="command">lemma</span></span> b_dagger_munion_aux<span class="main">:</span>
	<span class="quoted"><span class="quoted">"dom<span class="main">(</span>dom <span class="free">g</span> <span class="main">-‚óÉ</span> <span class="free">f</span><span class="main">)</span> <span class="main">‚à©</span> dom <span class="free">g</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l_dom_dom_ar<span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_disjoint inf_commute<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> b_dagger_munion<span class="main">:</span>
	<span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">‚Ä†</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>dom <span class="free">g</span> <span class="main">-‚óÉ</span> <span class="free">f</span><span class="main">)</span> <span class="keyword1">‚à™m</span> <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">find_theorems</span></span> <span class="main">(</span>300<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="main">(</span><span class="main">_</span><span class="main">::</span><span class="main">(</span><span class="main">_</span> <span class="main">‚áí</span> <span class="main">_</span><span class="main">)</span><span class="main">)</span>"</span></span> -name<span class="main">:</span>Predicate -name<span class="main">:</span>Product -name<span class="main">:</span>Quick -name<span class="main">:</span>New -name<span class="main">:</span>Record -name<span class="main">:</span>Quotient
		-name<span class="main">:</span>Hilbert -name<span class="main">:</span>Nitpick -name<span class="main">:</span>Random -name<span class="main">:</span>Transitive -name<span class="main">:</span>Sum_Type -name<span class="main">:</span>DSeq -name<span class="main">:</span>Datatype -name<span class="main">:</span>Enum
		-name<span class="main">:</span>Big -name<span class="main">:</span>Code -name<span class="main">:</span>Divides
<span class="keyword1"><span class="command">thm</span></span> fun_eq_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">‚Ä†</span> <span class="free">g</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>dom <span class="free">g</span> <span class="main">-‚óÉ</span> <span class="free">f</span><span class="main">)</span> <span class="keyword1">‚à™m</span> <span class="free">g</span>"</span></span><span class="main">]</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l_dagger_apply<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cut_tac</span> b_dagger_munion_aux<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">g</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">f</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="comment1">(* TODO: How to make this more automatic? Iain, help? subgoal_tac! Try that. *)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> allI impI conjI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l_munion_apply<span class="main">)</span>
<span class="keyword1"><span class="command">unfolding</span></span> dom_antirestr_def
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">lemma</span></span> l_munion_assoc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"dom <span class="free">f</span> <span class="main">‚à©</span> dom <span class="free">g</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">‚üπ</span> dom <span class="free">g</span> <span class="main">‚à©</span> dom <span class="free">h</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">‚üπ</span> <span class="main">(</span><span class="free">f</span> <span class="keyword1">‚à™m</span> <span class="free">g</span><span class="main">)</span> <span class="keyword1">‚à™m</span> <span class="free">h</span> <span class="main">=</span> <span class="free">f</span> <span class="keyword1">‚à™m</span> <span class="main">(</span><span class="free">g</span> <span class="keyword1">‚à™m</span> <span class="free">h</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> munion_def
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l_dagger_dom<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI impI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> l_dagger_assoc<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> disjoint_iff_not_equal<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span>1<span class="main">-</span><span class="main"><span class="improper">]</span></span> bexE<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> l_munion_commute<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"dom <span class="free">f</span> <span class="main">‚à©</span> dom <span class="free">g</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">‚üπ</span> <span class="free">f</span> <span class="keyword1">‚à™m</span> <span class="free">g</span> <span class="main">=</span> <span class="free">g</span> <span class="keyword1">‚à™m</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> b_dagger_munion l_dagger_commute l_dom_ar_nothing munion_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_munion_subsume<span class="main">:</span>
	<span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">‚àà</span> dom <span class="free">f</span> <span class="main">‚üπ</span> the<span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">y</span> <span class="main">‚üπ</span> <span class="free">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">-‚óÉ</span> <span class="free">f</span><span class="main">)</span> <span class="keyword1">‚à™m</span> <span class="main">[</span><span class="free">x</span> <span class="main">‚Ü¶</span> <span class="free">y</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fun_eq_iff<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> allI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"dom<span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">-‚óÉ</span> <span class="free">f</span><span class="main">)</span> <span class="main">‚à©</span> dom <span class="main">[</span><span class="free">x</span> <span class="main">‚Ü¶</span> <span class="free">y</span><span class="main">]</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l_munion_apply<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> domD dom_antirestr_def singletonE option.sel<span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_disjoint Int_commute dom_eq_singleton_conv l_dom_dom_ar<span class="main">)</span>

<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‚Äπ Perhaps add <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"g ‚äÜ<span class="hidden">‚á©</span><sub>m</sub> f"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> instead? ‚Ä∫</span></span>
<span class="keyword1"><span class="command">lemma</span></span> l_munion_subsumeG<span class="main">:</span>  
	<span class="quoted"><span class="quoted">"dom <span class="free">g</span> <span class="main">‚äÜ</span> dom <span class="free">f</span> <span class="main">‚üπ</span> <span class="main">‚àÄ</span><span class="bound">x</span> <span class="main">‚àà</span> dom <span class="free">g</span> <span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">‚üπ</span> <span class="free">f</span> <span class="main">=</span> <span class="main">(</span>dom <span class="free">g</span> <span class="main">-‚óÉ</span> <span class="free">f</span><span class="main">)</span> <span class="keyword1">‚à™m</span> <span class="free">g</span>"</span></span>
	
<span class="keyword1"><span class="command">unfolding</span></span> munion_def
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span>dom <span class="free">g</span> <span class="main">-‚óÉ</span> <span class="free">f</span><span class="main">)</span> <span class="main">‚à©</span> dom <span class="free">g</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fun_eq_iff<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l_dagger_apply<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> dom_antirestr_def
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fold</span> dom_antirestr_def<span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_disjoint inf_commute l_dom_dom_ar<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_munion_dom_ar_assoc<span class="main">:</span>
	<span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">‚äÜ</span> dom <span class="free">f</span> <span class="main">‚üπ</span> dom <span class="free">f</span> <span class="main">‚à©</span> dom <span class="free">g</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">‚üπ</span> <span class="main">(</span><span class="free">S</span> <span class="main">-‚óÉ</span> <span class="free">f</span><span class="main">)</span> <span class="keyword1">‚à™m</span> <span class="free">g</span> <span class="main">=</span> <span class="free">S</span> <span class="main">-‚óÉ</span> <span class="main">(</span><span class="free">f</span> <span class="keyword1">‚à™m</span> <span class="free">g</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> munion_def
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span><span class="free">S</span> <span class="main">-‚óÉ</span> <span class="free">f</span><span class="main">)</span> <span class="main">‚à©</span> dom <span class="free">g</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">defer</span></span></span></span> 1
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Diff_Int_distrib2 empty_Diff l_dom_dom_ar<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> l_dagger_dom_ar_assoc<span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> equalityE inf_mono subset_empty<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_munion_empty_rhs<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="keyword1">‚à™m</span> Map.empty<span class="main">)</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> munion_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dom_empty inf_bot_right l_dagger_empty_rhs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_munion_empty_lhs<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span>Map.empty <span class="keyword1">‚à™m</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> munion_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dom_empty inf_bot_left l_dagger_empty_lhs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> k_finite_munion<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="free">f</span><span class="main">)</span> <span class="main">‚üπ</span> finite<span class="main">(</span>dom <span class="free">g</span><span class="main">)</span> <span class="main">‚üπ</span> dom <span class="free">f</span> <span class="main">‚à©</span> dom <span class="free">g</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">‚üπ</span> finite<span class="main">(</span>dom<span class="main">(</span><span class="free">f</span> <span class="keyword1">‚à™m</span> <span class="free">g</span><span class="main">)</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_Un l_munion_dom<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_munion_singleton_not_empty<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">‚àâ</span> dom <span class="free">f</span> <span class="main">‚üπ</span> <span class="free">f</span> <span class="keyword1">‚à™m</span> <span class="main">[</span><span class="free">x</span> <span class="main">‚Ü¶</span> <span class="free">y</span><span class="main">]</span> <span class="main">‚â†</span> Map.empty"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> Map.empty"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> l_munion_empty_lhs map_upd_nonempty<span class="main">)</span>
<span class="keyword1"><span class="command">unfolding</span></span> munion_def
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dagger_def map_add_None<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_munion_empty_iff<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"dom <span class="free">f</span> <span class="main">‚à©</span> dom <span class="free">g</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">‚üπ</span> <span class="main">(</span><span class="free">f</span> <span class="keyword1">‚à™m</span> <span class="free">g</span> <span class="main">=</span> Map.empty<span class="main">)</span> <span class="main">‚ü∑</span> <span class="main">(</span><span class="free">f</span> <span class="main">=</span> Map.empty <span class="main">‚àß</span> <span class="free">g</span> <span class="main">=</span> Map.empty<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> dom_eq_empty_conv<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> l_munion_dom<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Un_empty<span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l_munion_empty_lhs l_munion_empty_rhs<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_munion_dom_ar_singleton_subsume<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">‚àâ</span> dom <span class="free">f</span> <span class="main">‚üπ</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">-‚óÉ</span> <span class="main">(</span><span class="free">f</span> <span class="keyword1">‚à™m</span> <span class="main">[</span><span class="free">x</span> <span class="main">‚Ü¶</span> <span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fun_eq_iff<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span>
<span class="keyword1"><span class="command">unfolding</span></span> dom_antirestr_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> l_munion_apply<span class="main">)</span>

<span class="comment1">(*
lemmX l_dom_ar_union:
  "S -‚óÉ (f ‚à™m g) = (S -‚óÉ f) ‚à™m (S -‚óÉ g)"
apply (rule ext)
unfolding munion_def
apply (split split_if, intro conjI impI)+
apply (simp_all add: l_dagger_apply)
apply (intro conjI impI)
apply (insert f_dom_ar_subset_dom[of S f])
apply (insert f_dom_ar_subset_dom[of S g])
oops
*)</span>

<span class="comment1">(* TODO: rename? *)</span>
<span class="keyword1"><span class="command">lemma</span></span> l_munion_upd<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="free">f</span> <span class="main">‚à©</span> dom <span class="main">[</span><span class="free">x</span> <span class="main">‚Ü¶</span> <span class="free">y</span><span class="main">]</span> <span class="main">=</span> <span class="main">{}</span>  <span class="main">‚üπ</span> <span class="free">f</span> <span class="keyword1">‚à™m</span> <span class="main">[</span><span class="free">x</span> <span class="main">‚Ü¶</span> <span class="free">y</span><span class="main">]</span> <span class="main">=</span> <span class="free">f</span><span class="main">(</span><span class="free">x</span> <span class="main">‚Ü¶</span><span class="free">y</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">unfolding</span></span> munion_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dagger_def map_add_empty map_add_upd<span class="main">)</span>

<span class="comment1">(* TODO: Do I really need these?! *)</span>
<span class="keyword1"><span class="command">lemma</span></span> munion_notemp_dagger<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="free">f</span> <span class="main">‚à©</span> dom <span class="free">g</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">‚üπ</span> <span class="free">f</span> <span class="keyword1">‚à™m</span> <span class="free">g</span><span class="main">‚â†</span>Map.empty <span class="main">‚üπ</span> <span class="free">f</span> <span class="main">‚Ä†</span> <span class="free">g</span> <span class="main">‚â†</span> Map.empty"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> munion_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> dagger_notemp_munion<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="free">f</span> <span class="main">‚à©</span> dom <span class="free">g</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">‚üπ</span> <span class="free">f</span> <span class="main">‚Ä†</span> <span class="free">g</span><span class="main">‚â†</span>Map.empty <span class="main">‚üπ</span> <span class="free">f</span> <span class="keyword1">‚à™m</span> <span class="free">g</span> <span class="main">‚â†</span> Map.empty"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> munion_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> munion_notempty_left<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="free">f</span> <span class="main">‚à©</span> dom <span class="free">g</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">‚üπ</span> <span class="free">f</span> <span class="main">‚â†</span> Map.empty <span class="main">‚üπ</span> <span class="free">f</span> <span class="keyword1">‚à™m</span> <span class="free">g</span> <span class="main">‚â†</span> Map.empty"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dagger_notemp_munion dagger_notemptyL<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> munion_notempty_right<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="free">f</span> <span class="main">‚à©</span> dom <span class="free">g</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">‚üπ</span> <span class="free">g</span> <span class="main">‚â†</span> Map.empty <span class="main">‚üπ</span> <span class="free">f</span> <span class="keyword1">‚à™m</span> <span class="free">g</span> <span class="main">‚â†</span> Map.empty"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dagger_notemp_munion dagger_notemptyR<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> unionm_in_dom_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">‚àà</span> dom <span class="main">(</span><span class="free">f</span> <span class="keyword1">‚à™m</span> <span class="free">g</span><span class="main">)</span> <span class="main">‚üπ</span> <span class="main">(</span>dom <span class="free">f</span> <span class="main">‚à©</span> dom <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">‚üπ</span> <span class="free">x</span> <span class="main">‚àâ</span> dom <span class="free">g</span> <span class="main">‚üπ</span> <span class="free">x</span> <span class="main">‚àà</span> dom <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l_munion_dom<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> unionm_in_dom_right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">‚àà</span> dom <span class="main">(</span><span class="free">f</span> <span class="keyword1">‚à™m</span> <span class="free">g</span><span class="main">)</span> <span class="main">‚üπ</span> <span class="main">(</span>dom <span class="free">f</span> <span class="main">‚à©</span> dom <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">‚üπ</span> <span class="free">x</span> <span class="main">‚àâ</span> dom <span class="free">f</span> <span class="main">‚üπ</span> <span class="free">x</span> <span class="main">‚àà</span> dom <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l_munion_dom<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> unionm_notin_dom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">‚àâ</span> dom <span class="free">f</span> <span class="main">‚üπ</span> <span class="free">x</span> <span class="main">‚àâ</span> dom <span class="free">g</span> <span class="main">‚üπ</span> <span class="main">(</span>dom <span class="free">f</span> <span class="main">‚à©</span> dom <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">‚üπ</span> <span class="free">x</span> <span class="main">‚àâ</span> dom <span class="main">(</span><span class="free">f</span> <span class="keyword1">‚à™m</span> <span class="free">g</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> unionm_in_dom_right<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> munion_simps <span class="main">=</span> k_munion_map_upd_wd l_munion_apply l_munion_dom  b_dagger_munion
l_munion_subsume l_munion_subsumeG l_munion_dom_ar_assoc l_munion_empty_rhs
l_munion_empty_lhs k_finite_munion  l_munion_upd munion_notemp_dagger
dagger_notemp_munion munion_notempty_left munion_notempty_right

<span class="keyword1"><span class="command">lemmas</span></span> vdm_simps <span class="main">=</span> restr_simps antirestr_simps dagger_simps upd_simps munion_simps

<span class="comment1">(* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ *)</span>
<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‚Äπ Map finiteness weakening lemmas [EXPERT] ‚Ä∫</span></span>
<span class="comment1">(* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ *)</span>

<span class="comment1">‚Äï ‚ÄπNeed to have the lemma options, otherwise it fails somehow‚Ä∫</span>
<span class="keyword1"><span class="command">lemma</span></span> finite_map_upd_induct <span class="main">[</span><span class="operator">case_names</span> empty insert<span class="main">,</span> <span class="operator">induct</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">set</span></span></span><span class="main"><span class="main"><span class="main"><span class="main">:</span></span></span></span> finite<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="free">f</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> Map.empty"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> insert<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">‚ãÄ</span><span class="bound">e</span> <span class="bound">r</span> <span class="bound">f</span><span class="main">.</span> finite <span class="main">(</span>dom <span class="bound">f</span><span class="main">)</span> <span class="main">‚üπ</span> <span class="bound">e</span> <span class="main">‚àâ</span> dom <span class="bound">f</span> <span class="main">‚üπ</span> <span class="free">P</span> <span class="bound">f</span> <span class="main">‚üπ</span> <span class="free">P</span> <span class="main">(</span><span class="bound">f</span><span class="main">(</span><span class="bound">e</span> <span class="main">‚Ü¶</span> <span class="bound">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fin
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"dom <span class="free">f</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>finite_induct<span class="main">)</span> <span class="comment1">‚Äï ‚Äπarbitrary statement is a must in here, otherwise cannot prove it‚Ä∫</span>
  <span class="keyword3"><span class="command">case</span></span> empty <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dom <span class="skolem">f</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>   <span class="comment1">‚Äï ‚Äπneed to reverse to apply rules‚Ä∫</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> Map.empty"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span>
  <span class="comment1">‚Äï ‚ÄπShow that update of the domain means an update of the map‚Ä∫</span>
  <span class="keyword3"><span class="command">assume</span></span> domF<span class="main">:</span> <span class="quoted"><span class="quoted">"insert <span class="skolem">x</span> <span class="skolem">F</span> <span class="main">=</span> dom <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> domFr<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="skolem">f</span> <span class="main">=</span> insert <span class="skolem">x</span> <span class="skolem">F</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f0</span></span> <span class="keyword2"><span class="keyword">where</span></span> f0Def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f0</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">|`</span> <span class="skolem">F</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> domF <span class="keyword1"><span class="command">have</span></span> domF0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">=</span> dom <span class="skolem">f0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> insert <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="skolem">f0</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">‚àâ</span> dom <span class="skolem">f0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">f0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> PFUpd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="skolem">f0</span><span class="main">(</span><span class="skolem">x</span> <span class="main">‚Ü¶</span> the <span class="main">(</span><span class="skolem">f</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> domFr f0Def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="skolem">f0</span><span class="main">(</span><span class="skolem">x</span> <span class="main">‚Ü¶</span> the <span class="main">(</span><span class="skolem">f</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> l_insertUpdSpec_aux<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> PFUpd <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finiteRan<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="free">f</span><span class="main">)</span> <span class="main">‚üπ</span> finite <span class="main">(</span>ran <span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>finite_map_upd_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">e</span> <span class="skolem">r</span> <span class="skolem">f</span><span class="main">)</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ranIns<span class="main">:</span> <span class="quoted"><span class="quoted">"ran <span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="skolem">e</span> <span class="main">‚Ü¶</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> insert <span class="skolem">r</span> <span class="main">(</span>ran <span class="skolem">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>ran <span class="skolem">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>insert <span class="skolem">r</span> <span class="main">(</span>ran <span class="skolem">f</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> finite.insertI<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> ranIns<span class="main">)</span>
 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* TODO: classify; rename; relocate? *)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_dom_r_finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="free">f</span><span class="main">)</span> <span class="main">‚üπ</span> finite <span class="main">(</span>dom <span class="main">(</span> <span class="free">S</span> <span class="main">‚óÉ</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> B<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"dom <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span>  finite_subset<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l_dom_r_dom_subseteq<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> dagger_finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="free">f</span><span class="main">)</span> <span class="main">‚üπ</span> finite <span class="main">(</span>dom <span class="free">g</span><span class="main">)</span> <span class="main">‚üπ</span> finite <span class="main">(</span>dom <span class="main">(</span><span class="free">f</span> <span class="main">‚Ä†</span> <span class="free">g</span><span class="main">)</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dagger_def dom_map_add finite_Un<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> finite_singleton<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="main">[</span><span class="free">a</span> <span class="main">‚Ü¶</span> <span class="free">b</span><span class="main">]</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dom_eq_singleton_conv finite.emptyI finite_insert<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> not_in_dom_ar<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="free">f</span><span class="main">)</span> <span class="main">‚üπ</span> <span class="free">s</span> <span class="main">‚à©</span> dom <span class="free">f</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">‚üπ</span> dom <span class="main">(</span><span class="free">s</span> <span class="main">-‚óÉ</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> dom <span class="free">f</span>"</span></span> 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_map_upd_induct<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> dom_antirestr_def<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IntI domIff empty_iff<span class="main">)</span>

<span class="comment1">(* LF: why go for induction ? *)</span>
<span class="keyword1"><span class="command">lemma</span></span> not_in_dom_ar_2<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="free">f</span><span class="main">)</span> <span class="main">‚üπ</span> <span class="free">s</span> <span class="main">‚à©</span> dom <span class="free">f</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">‚üπ</span> dom <span class="main">(</span><span class="free">s</span> <span class="main">-‚óÉ</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> dom <span class="free">f</span>"</span></span> 
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> set_eq_subset<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span><span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> subsetI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> l_dom_ar_not_in_dom<span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> l_dom_ar_nothing<span class="main">)</span>

<span class="comment1">(* ======== *)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_dom_ar_commute_quickspec<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">-‚óÉ</span> <span class="main">(</span><span class="free">T</span> <span class="main">-‚óÉ</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="free">T</span> <span class="main">-‚óÉ</span> <span class="main">(</span><span class="free">S</span> <span class="main">-‚óÉ</span> <span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> l_dom_ar_accum sup_commute<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_dom_ar_same_subsume_quickspec<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">-‚óÉ</span> <span class="main">(</span><span class="free">S</span> <span class="main">-‚óÉ</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="free">S</span> <span class="main">-‚óÉ</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> l_dom_ar_accum sup_idem<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_map_with_range_not_dom_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="free">m</span> <span class="main">‚â†</span> <span class="main">{}</span> <span class="main">‚üπ</span> ran <span class="free">m</span> <span class="main">‚â†</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l_map_non_empty_ran_conv<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_map_dom_ran<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="free">f</span> <span class="main">=</span> <span class="free">A</span> <span class="main">‚üπ</span> <span class="free">x</span> <span class="main">‚àà</span> <span class="free">A</span> <span class="main">‚üπ</span> <span class="free">f</span> <span class="free">x</span> <span class="main">‚â†</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="comment1">(* Sequential composition combinator *)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">seqcomp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áí</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">‚áí</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áí</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">‚áí</span> <span class="tfree">'a</span> <span class="main">‚áí</span> <span class="tfree">'a</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span><span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword3">/ </span><span class="keyword1">;;</span> <span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword3">/</span><span class="keyword1">,</span> <span class="keyword3">(</span>_<span class="keyword3">)</span><span class="keyword3">)</span>"</span> <span class="main">[</span>0<span class="main">,</span> 0<span class="main">,</span> 10<span class="main">]</span> 10<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">;;</span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main"><span class="free">,</span></span> <span class="free"><span class="bound"><span class="entity">bst</span></span></span><span class="main">)</span> <span class="main">‚â°</span> <span class="keyword1">let</span> <span class="bound">mst</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">bst</span></span></span> <span class="keyword1">in</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="bound">mst</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">fun</span></span>
  <span class="entity">seqcomps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áí</span> <span class="tfree">'a</span><span class="main">)</span> list <span class="main">‚áí</span> <span class="tfree">'a</span> <span class="main">‚áí</span> <span class="tfree">'a</span>"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">seqcomps</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">bst</span></span></span>     <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">bst</span></span></span>"</span></span> 
<span class="main">|</span> <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">seqcomps</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">bst</span></span></span> <span class="main">=</span> <span class="free">seqcomps</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">bst</span></span></span><span class="main">)</span>"</span></span> 

<span class="comment1">(*
find_consts name:fold

fun
  seqcomps' :: "('a ‚áí 'a) list ‚áí 'a ‚áí 'a" 
  where
  [intro!]: "seqcomps' [] bst     = foldl (Œª b::'a . (Œª a . b)) bst []" 
| [intro!]: "seqcomps' (x#xs) bst = foldl (Œª b . (Œª a . a b)) l " 

primrec foldl :: "('b ‚áí 'a ‚áí 'b) ‚áí 'b ‚áí 'a list ‚áí 'b" where
foldl_Nil:  "foldl f a [] = a" |
foldl_Cons: "foldl f a (x # xs) = foldl f (f a x) xs"
*)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">seqcomps'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">‚áí</span> <span class="tfree">'a</span><span class="main">)</span> list <span class="main">‚áí</span> <span class="tfree">'a</span> <span class="main">‚áí</span> <span class="tfree">'a</span>"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">seqcomps'</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">bst</span></span></span> <span class="main">=</span> foldl <span class="main">(</span><span class="main">Œª</span> <span class="bound">b</span> <span class="main">.</span> <span class="main">(</span><span class="main">Œª</span> <span class="bound">a</span> <span class="main">.</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">bst</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> l_seq_comp_simp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main">;;</span> <span class="free">Q</span><span class="main">,</span> <span class="free">bst</span><span class="main">)</span> <span class="main">=</span> <span class="free">Q</span> <span class="main">(</span><span class="free">P</span> <span class="free">bst</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> seqcomp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> l_ranE_frule<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">‚àà</span> ran <span class="free">f</span> <span class="main">‚üπ</span> <span class="main">‚àÉ</span> <span class="bound">x</span> <span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ran_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">safe</span>

<span class="keyword1"><span class="command">lemma</span></span> l_ranE_frule'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">‚àà</span> ran <span class="free">f</span> <span class="main">‚üπ</span> <span class="main">‚àÉ</span> <span class="bound">x</span> <span class="main">.</span> <span class="free">e</span> <span class="main">=</span> the<span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> l_ranE_frule option.sel<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_inv_MapTrue<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="free">m</span><span class="main">)</span> <span class="main">‚üπ</span> undefined <span class="main">‚àâ</span> dom <span class="free">m</span> <span class="main">‚üπ</span> undefined <span class="main">‚àâ</span> rng <span class="free">m</span> <span class="main">‚üπ</span> inv_Map inv_True inv_True <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_ran inv_Map_def inv_VDMSet'_def rng_def<span class="main">)</span>  

<span class="keyword1"><span class="command">lemma</span></span> l_invMap_domr_absorb<span class="main">:</span>   
  <span class="quoted"><span class="quoted">"inv_Map <span class="free">di</span> <span class="free">ri</span> <span class="free">m</span> <span class="main">‚üπ</span> inv_Map <span class="free">di</span> <span class="free">ri</span> <span class="main">(</span><span class="free">S</span> <span class="main">‚óÉ</span> <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> inv_Map_def inv_VDMSet'_defs inv_VDMSet_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> domIff f_in_dom_r_apply_elem f_in_relimg_ran finiteRan l_dom_r_finite l_in_dom_dom_r<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> l_inv_Map_on_dom<span class="main">[</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inv_Map <span class="free">inv_Dom</span> <span class="free">inv_Ran</span> <span class="free">m</span> <span class="main">‚üπ</span> inv_SetElems <span class="free">inv_Dom</span> <span class="main">(</span>dom <span class="free">m</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> inv_Map_defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> l_inv_Map_on_ran<span class="main">[</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inv_Map <span class="free">inv_Dom</span> <span class="free">inv_Ran</span> <span class="free">m</span> <span class="main">‚üπ</span> inv_SetElems <span class="free">inv_Ran</span> <span class="main">(</span>ran <span class="free">m</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> inv_Map_defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> l_inv_Map_finite<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inv_Map <span class="free">inv_Dom</span> <span class="free">inv_Ran</span> <span class="free">m</span> <span class="main">‚üπ</span> finite <span class="main">(</span>dom <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> inv_Map_defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> l_invMap_di_absorb<span class="main">:</span>
  <span class="quoted"><span class="quoted">"undefined <span class="main">‚àâ</span> dom <span class="free">m</span> <span class="main">‚üπ</span> undefined <span class="main">‚àâ</span> rng <span class="free">m</span> <span class="main">‚üπ</span> inv_Map <span class="free">di</span> <span class="free">ri</span> <span class="free">m</span> <span class="main">‚üπ</span> inv_Map inv_True <span class="free">ri</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inv_Map_def inv_VDMSet'_def<span class="main">)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‚ÄπTo tidy up or remove‚Ä∫</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"vdm_narrow_real <span class="main">(</span><span class="numeral">4.5</span><span class="main">::</span>VDMRat<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"vdm_narrow_real <span class="main">(</span><span class="numeral">4.5</span><span class="main">::</span>VDMReal<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">" <span class="numeral">7</span> <span class="keyword1">div</span>    <span class="main">(</span> <span class="numeral">3</span><span class="main">::</span><span class="main">‚Ñ§</span><span class="main">)</span> <span class="main">=</span>  <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">" <span class="numeral">7</span> <span class="keyword1">vdmdiv</span> <span class="main">(</span> <span class="numeral">3</span><span class="main">::</span><span class="main">‚Ñ§</span><span class="main">)</span> <span class="main">=</span>  <span class="numeral">2</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="numeral">7</span> <span class="keyword1">div</span>    <span class="main">(</span><span class="main">-</span><span class="numeral">3</span><span class="main">::</span><span class="main">‚Ñ§</span><span class="main">)</span> <span class="main">=</span>  <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="numeral">7</span> <span class="keyword1">vdmdiv</span> <span class="main">(</span><span class="main">-</span><span class="numeral">3</span><span class="main">::</span><span class="main">‚Ñ§</span><span class="main">)</span> <span class="main">=</span>  <span class="numeral">2</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="numeral">7</span> <span class="keyword1">div</span>    <span class="main">(</span> <span class="numeral">3</span><span class="main">::</span><span class="main">‚Ñ§</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span><span class="numeral">3</span>"</span></span> 
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="numeral">7</span> <span class="keyword1">vdmdiv</span> <span class="main">(</span> <span class="numeral">3</span><span class="main">::</span><span class="main">‚Ñ§</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span><span class="numeral">2</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">" <span class="numeral">7</span> <span class="keyword1">div</span>    <span class="main">(</span><span class="main">-</span><span class="numeral">3</span><span class="main">::</span><span class="main">‚Ñ§</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span><span class="numeral">3</span>"</span></span> 
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">" <span class="numeral">7</span> <span class="keyword1">vdmdiv</span> <span class="main">(</span><span class="main">-</span><span class="numeral">3</span><span class="main">::</span><span class="main">‚Ñ§</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span><span class="numeral">2</span>"</span></span> 

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">" <span class="main">1</span> <span class="keyword1">div</span>    <span class="main">(</span><span class="main">-</span><span class="numeral">2</span><span class="main">::</span><span class="main">‚Ñ§</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span>"</span></span>  
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">" <span class="main">1</span> <span class="keyword1">vdmdiv</span> <span class="main">(</span><span class="main">-</span><span class="numeral">2</span><span class="main">::</span><span class="main">‚Ñ§</span><span class="main">)</span> <span class="main">=</span>  <span class="main">0</span>"</span></span>  
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">1</span> <span class="keyword1">div</span>    <span class="main">(</span> <span class="numeral">2</span><span class="main">::</span><span class="main">‚Ñ§</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span>"</span></span>  
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">1</span> <span class="keyword1">vdmdiv</span> <span class="main">(</span> <span class="numeral">2</span><span class="main">::</span><span class="main">‚Ñ§</span><span class="main">)</span> <span class="main">=</span>  <span class="main">0</span>"</span></span>  

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="keyword1">div</span>    <span class="main">(</span><span class="main">-</span><span class="numeral">3</span><span class="main">::</span><span class="main">‚Ñ§</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="keyword1">vdmdiv</span> <span class="main">(</span><span class="main">-</span><span class="numeral">3</span><span class="main">::</span><span class="main">‚Ñ§</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="keyword1">div</span>    <span class="main">(</span> <span class="numeral">3</span><span class="main">::</span><span class="main">‚Ñ§</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="keyword1">vdmdiv</span> <span class="main">(</span> <span class="numeral">3</span><span class="main">::</span><span class="main">‚Ñ§</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">" <span class="numeral">7</span> <span class="keyword1">mod</span>    <span class="main">(</span> <span class="numeral">3</span><span class="main">::</span><span class="main">‚Ñ§</span><span class="main">)</span> <span class="main">=</span>  <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">" <span class="numeral">7</span> <span class="keyword1">vdmmod</span> <span class="main">(</span> <span class="numeral">3</span><span class="main">::</span><span class="main">‚Ñ§</span><span class="main">)</span> <span class="main">=</span>  <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="numeral">7</span> <span class="keyword1">mod</span>    <span class="main">(</span><span class="main">-</span><span class="numeral">3</span><span class="main">::</span><span class="main">‚Ñ§</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="numeral">7</span> <span class="keyword1">vdmmod</span> <span class="main">(</span><span class="main">-</span><span class="numeral">3</span><span class="main">::</span><span class="main">‚Ñ§</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="numeral">7</span> <span class="keyword1">mod</span>    <span class="main">(</span> <span class="numeral">3</span><span class="main">::</span><span class="main">‚Ñ§</span><span class="main">)</span> <span class="main">=</span>  <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="numeral">7</span> <span class="keyword1">vdmmod</span> <span class="main">(</span> <span class="numeral">3</span><span class="main">::</span><span class="main">‚Ñ§</span><span class="main">)</span> <span class="main">=</span>  <span class="numeral">2</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">" <span class="numeral">7</span> <span class="keyword1">mod</span>    <span class="main">(</span><span class="main">-</span><span class="numeral">3</span><span class="main">::</span><span class="main">‚Ñ§</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span><span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">" <span class="numeral">7</span> <span class="keyword1">vdmmod</span> <span class="main">(</span><span class="main">-</span><span class="numeral">3</span><span class="main">::</span><span class="main">‚Ñ§</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span><span class="numeral">2</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">" <span class="numeral">7</span> <span class="keyword1">vdmmod</span> <span class="main">(</span> <span class="numeral">3</span><span class="main">::</span><span class="main">‚Ñ§</span><span class="main">)</span> <span class="main">=</span>  <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="numeral">7</span> <span class="keyword1">vdmmod</span> <span class="main">(</span><span class="main">-</span><span class="numeral">3</span><span class="main">::</span><span class="main">‚Ñ§</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="numeral">7</span> <span class="keyword1">vdmmod</span> <span class="main">(</span> <span class="numeral">3</span><span class="main">::</span><span class="main">‚Ñ§</span><span class="main">)</span> <span class="main">=</span>  <span class="numeral">2</span>"</span></span> 
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">" <span class="numeral">7</span> <span class="keyword1">vdmmod</span> <span class="main">(</span><span class="main">-</span><span class="numeral">3</span><span class="main">::</span><span class="main">‚Ñ§</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span><span class="numeral">2</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">" <span class="numeral">7</span> <span class="keyword1">vdmrem</span> <span class="main">(</span> <span class="numeral">3</span><span class="main">::</span><span class="main">‚Ñ§</span><span class="main">)</span> <span class="main">=</span>  <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="numeral">7</span> <span class="keyword1">vdmrem</span> <span class="main">(</span><span class="main">-</span><span class="numeral">3</span><span class="main">::</span><span class="main">‚Ñ§</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="numeral">7</span> <span class="keyword1">vdmrem</span> <span class="main">(</span> <span class="numeral">3</span><span class="main">::</span><span class="main">‚Ñ§</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span><span class="main">1</span>"</span></span> 
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">" <span class="numeral">7</span> <span class="keyword1">vdmrem</span> <span class="main">(</span><span class="main">-</span><span class="numeral">3</span><span class="main">::</span><span class="main">‚Ñ§</span><span class="main">)</span> <span class="main">=</span>  <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"inds0 <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">,</span> <span class="free">C</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"nths <span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="main">(</span><span class="numeral">3</span><span class="main">::</span>nat<span class="main">)</span><span class="main">]</span> <span class="main">{</span><span class="numeral">2</span><span class="main">..</span><span class="numeral">3</span><span class="main">}</span>"</span></span>

<span class="comment1">(*lemma "s$${l..u} = subSeq s {l..u}" *)</span>
<span class="comment1">(* negatives give funny result, as nat -4 = 0 and nat -1 = 0! *)</span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"nths <span class="main">[</span><span class="free">A</span><span class="main">,</span><span class="free">B</span><span class="main">,</span><span class="free">C</span><span class="main">,</span><span class="free">D</span><span class="main">]</span> <span class="main">{</span><span class="main">(</span>nat <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">..</span><span class="main">(</span>nat <span class="main">(</span><span class="main">-</span><span class="numeral">4</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"nths <span class="main">[</span><span class="free">A</span><span class="main">,</span><span class="free">B</span><span class="main">,</span><span class="free">C</span><span class="main">,</span><span class="free">D</span><span class="main">]</span> <span class="main">{</span><span class="main">(</span>nat <span class="main">(</span><span class="main">-</span><span class="numeral">4</span><span class="main">)</span><span class="main">)</span><span class="main">..</span><span class="main">(</span>nat <span class="main">(</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">A</span><span class="main">,</span><span class="free">B</span><span class="main">,</span><span class="free">C</span><span class="main">,</span><span class="free">D</span><span class="main">]</span><span class="main">$$$</span><span class="main">{</span><span class="main">-</span><span class="numeral">4</span><span class="main">..</span><span class="main">-</span><span class="main">1</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">A</span><span class="main">,</span><span class="free">B</span><span class="main">,</span><span class="free">C</span><span class="main">,</span><span class="free">D</span><span class="main">]</span><span class="main">$$$</span><span class="main">{</span><span class="main">-</span><span class="main">1</span><span class="main">..</span><span class="main">-</span><span class="numeral">4</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">A</span><span class="main">,</span><span class="free">B</span><span class="main">,</span><span class="free">C</span><span class="main">,</span><span class="free">D</span><span class="main">,</span><span class="free">E</span><span class="main">]</span><span class="main">$$$</span><span class="main">{</span><span class="numeral">4</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">A</span><span class="main">,</span><span class="free">B</span><span class="main">,</span><span class="free">C</span><span class="main">,</span><span class="free">D</span><span class="main">,</span><span class="free">E</span><span class="main">]</span><span class="main">$$$</span><span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="numeral">5</span><span class="main">}</span>"</span></span> <span class="comment1">(* 5-1+1*)</span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">A</span><span class="main">,</span><span class="free">B</span><span class="main">,</span><span class="free">C</span><span class="main">,</span><span class="free">D</span><span class="main">,</span><span class="free">E</span><span class="main">]</span><span class="main">$$$</span><span class="main">{</span><span class="numeral">2</span><span class="main">..</span><span class="numeral">5</span><span class="main">}</span>"</span></span> <span class="comment1">(* 5-2+1*)</span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">A</span><span class="main">,</span><span class="free">B</span><span class="main">,</span><span class="free">C</span><span class="main">,</span><span class="free">D</span><span class="main">,</span><span class="free">E</span><span class="main">]</span><span class="main">$$$</span><span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="numeral">3</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">A</span><span class="main">,</span><span class="free">B</span><span class="main">,</span><span class="free">C</span><span class="main">,</span><span class="free">D</span><span class="main">,</span><span class="free">E</span><span class="main">]</span><span class="main">$$$</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="numeral">2</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">A</span><span class="main">,</span><span class="free">B</span><span class="main">,</span><span class="free">C</span><span class="main">,</span><span class="free">D</span><span class="main">,</span><span class="free">E</span><span class="main">]</span><span class="main">$$$</span><span class="main">{</span><span class="main">-</span><span class="main">1</span><span class="main">..</span><span class="numeral">2</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">A</span><span class="main">,</span><span class="free">B</span><span class="main">,</span><span class="free">C</span><span class="main">,</span><span class="free">D</span><span class="main">,</span><span class="free">E</span><span class="main">]</span><span class="main">$$$</span><span class="main">{</span><span class="main">-</span><span class="numeral">10</span><span class="main">..</span><span class="numeral">20</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">A</span><span class="main">,</span><span class="free">B</span><span class="main">,</span><span class="free">C</span><span class="main">,</span><span class="free">D</span><span class="main">,</span><span class="free">E</span><span class="main">]</span><span class="main">$$$</span><span class="main">{</span><span class="numeral">2</span><span class="main">..</span><span class="main">-</span><span class="main">1</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">A</span><span class="main">,</span><span class="free">B</span><span class="main">,</span><span class="free">C</span><span class="main">,</span><span class="free">D</span><span class="main">,</span><span class="free">E</span><span class="main">]</span><span class="main">$$$</span><span class="main">{</span><span class="numeral">2</span><span class="main">..</span><span class="numeral">2</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">A</span><span class="main">,</span><span class="free">B</span><span class="main">,</span><span class="free">C</span><span class="main">,</span><span class="free">D</span><span class="main">,</span><span class="free">E</span><span class="main">]</span><span class="main">$$$</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">1</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"len <span class="main">(</span><span class="main">[</span><span class="free">A</span><span class="main">,</span><span class="free">B</span><span class="main">,</span><span class="free">C</span><span class="main">,</span><span class="free">D</span><span class="main">,</span><span class="free">E</span><span class="main">]</span><span class="main">$$$</span><span class="main">{</span><span class="numeral">2</span><span class="main">..</span><span class="numeral">2</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"len <span class="main">(</span><span class="main">[</span><span class="free">A</span><span class="main">]</span><span class="main">$$$</span><span class="main">{</span><span class="numeral">2</span><span class="main">..</span><span class="numeral">2</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="main">(</span><span class="numeral">2</span><span class="main">::</span>int<span class="main">)</span><span class="main">..</span><span class="numeral">2</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">A</span><span class="main">,</span><span class="free">B</span><span class="main">,</span><span class="free">C</span><span class="main">,</span><span class="free">D</span><span class="main">,</span><span class="free">E</span><span class="main">]</span><span class="main">$$$</span><span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">0</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">find_theorems</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="main">_</span><span class="main">..</span><span class="main">_</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚Äπ Set translations: enumeration, comprehension, ranges ‚Ä∫</span></span>
  
<span class="comment1">(* { expr | var . filter }, { var ‚àà type . filter }, { var . filter } *)</span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span> <span class="bound">x</span><span class="main">+</span><span class="bound">x</span> <span class="main">|</span> <span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">‚àà</span> <span class="main">{</span><span class="main">(</span><span class="main">1</span><span class="main">::</span>nat<span class="main">)</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">,</span><span class="numeral">4</span><span class="main">,</span><span class="numeral">5</span><span class="main">,</span><span class="numeral">6</span><span class="main">}</span> <span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span> <span class="bound">x</span><span class="main">+</span><span class="bound">x</span> <span class="main">|</span> <span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">‚àà</span> <span class="main">{</span><span class="main">(</span><span class="main">1</span><span class="main">::</span>nat<span class="main">)</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">}</span> <span class="main">}</span>"</span></span>
<span class="comment1">(*value "{ x+x | x . x ‚àà {(1::nat)..3} }" --"not always work"*)</span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="main">(</span><span class="numeral">2</span><span class="main">::</span>int<span class="main">)</span><span class="main">}</span>"</span></span>  
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="main">(</span><span class="numeral">3</span><span class="main">::</span>int<span class="main">)</span><span class="main">}</span>"</span></span>  
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">&lt;..&lt;</span><span class="main">(</span><span class="numeral">3</span><span class="main">::</span>int<span class="main">)</span><span class="main">}</span>"</span></span>  

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‚Äπ Seq translations: enumeration, comprehension, ranges ‚Ä∫</span></span>
  
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span><span class="free">B</span><span class="main">,</span><span class="free">C</span><span class="main">]</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">|</span> <span class="bound">i</span> <span class="main">.</span> <span class="bound">i</span> <span class="main">‚àà</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">}</span> <span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span><span class="free">B</span><span class="main">,</span><span class="free">C</span><span class="main">,</span><span class="free">D</span><span class="main">,</span><span class="free">E</span><span class="main">,</span><span class="free">F</span><span class="main">]</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">|</span> <span class="bound">i</span> <span class="main">.</span> <span class="bound">i</span> <span class="main">‚àà</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">4</span><span class="main">}</span> <span class="main">}</span>"</span></span>
<span class="comment1">(* { s(i) | i in set inds s &amp; i mod 2 = 0 } *)</span>

<span class="comment1">(* List application (i.e. s(x)) is available in Isabelle, but is zero based *)</span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">,</span> <span class="free">C</span><span class="main">]</span> <span class="main">!</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">,</span> <span class="free">C</span><span class="main">]</span> <span class="main">!</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">,</span> <span class="free">C</span><span class="main">]</span> <span class="main">!</span> <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">,</span> <span class="free">C</span><span class="main">]</span> <span class="main">!</span> <span class="numeral">3</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"nth <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">,</span> <span class="free">C</span><span class="main">]</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"applyList <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span> <span class="main">0</span>"</span></span> <span class="comment1">‚Äï ‚Äπout of range‚Ä∫</span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"applyList <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"applyList <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span> <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"applyList <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span> <span class="numeral">3</span>"</span></span> <span class="comment1">‚Äï ‚Äπout of range‚Ä∫</span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">A</span><span class="main">,</span><span class="free">B</span><span class="main">,</span><span class="free">C</span><span class="main">,</span><span class="free">D</span><span class="main">]</span> <span class="main">$</span> <span class="main">0</span>"</span></span>  
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">A</span><span class="main">,</span><span class="free">B</span><span class="main">,</span><span class="free">C</span><span class="main">]</span> <span class="main">$</span> <span class="numeral">4</span> <span class="main">=</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> applyVDMSeq_defs <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">oops</span></span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">A</span><span class="main">,</span><span class="free">B</span><span class="main">,</span><span class="free">C</span><span class="main">]</span> <span class="main">$</span> <span class="main">1</span> <span class="main">=</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> applyVDMSeq_defs <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>   

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">$</span> <span class="main">(</span>len <span class="main">[</span><span class="main">(</span><span class="free">a</span><span class="main">::</span>nat<span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span> <span class="main">$</span> <span class="main">0</span>"</span></span> <span class="comment1">‚Äï ‚Äπout of range‚Ä∫</span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">A</span><span class="main">,</span><span class="free">B</span><span class="main">]</span><span class="main">$</span><span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">$</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">$</span> <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span><span class="main">$</span> <span class="numeral">3</span>"</span></span> <span class="comment1">‚Äï  ‚Äπout of range‚Ä∫</span>

<span class="comment1">(* List comprehension *)</span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span> <span class="main">[</span><span class="free">A</span><span class="main">,</span><span class="free">B</span><span class="main">,</span><span class="free">C</span><span class="main">]</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">|</span> <span class="bound">i</span> <span class="main">.</span> <span class="bound">i</span> <span class="main">‚àà</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">}</span> <span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span> <span class="bound">x</span> <span class="main">.</span> x <span class="main">‚Üê</span> <span class="main">[</span><span class="main">0</span><span class="main">,</span><span class="main">1</span><span class="main">,</span><span class="main">(</span><span class="numeral">2</span><span class="main">::</span>int<span class="main">)</span><span class="main">]</span> <span class="main">]</span>"</span></span> <span class="comment1">(*avoid if possible... *)</span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span> <span class="bound">x</span> <span class="main">.</span> x <span class="main">‚Üê</span> <span class="main">[</span><span class="main">0</span> <span class="main">..</span> <span class="numeral">3</span><span class="main">]</span> <span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"len <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">,</span> <span class="free">C</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"elems <span class="main">[</span><span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">,</span> <span class="free">C</span><span class="main">,</span> <span class="free">A</span><span class="main">,</span> <span class="free">B</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"elems <span class="main">[</span><span class="main">(</span><span class="main">0</span><span class="main">::</span>nat<span class="main">)</span><span class="main">,</span> <span class="main">1</span><span class="main">,</span> <span class="numeral">2</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"inds <span class="main">[</span><span class="free">A</span><span class="main">,</span><span class="free">B</span><span class="main">,</span><span class="free">C</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"inds_as_nat <span class="main">[</span><span class="free">A</span><span class="main">,</span><span class="free">B</span><span class="main">,</span><span class="free">C</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>elems <span class="main">[</span><span class="numeral">10</span><span class="main">,</span> <span class="numeral">20</span><span class="main">,</span> <span class="numeral">30</span><span class="main">,</span> <span class="main">1</span><span class="main">,</span> <span class="numeral">2</span><span class="main">,</span> <span class="numeral">3</span><span class="main">,</span> <span class="numeral">4</span><span class="main">,</span> <span class="main">(</span><span class="numeral">5</span><span class="main">::</span>nat<span class="main">)</span><span class="main">,</span> <span class="numeral">10</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"len <span class="main">[</span><span class="numeral">10</span><span class="main">,</span> <span class="numeral">20</span><span class="main">,</span> <span class="numeral">30</span><span class="main">,</span> <span class="main">1</span><span class="main">,</span> <span class="numeral">2</span><span class="main">,</span> <span class="numeral">3</span><span class="main">,</span> <span class="numeral">4</span><span class="main">,</span> <span class="main">(</span><span class="numeral">5</span><span class="main">::</span>nat<span class="main">)</span><span class="main">,</span> <span class="numeral">10</span><span class="main">]</span>"</span></span>
  
<span class="comment1">(* MySeq = seq of nat1
   inv s == len s ‚â§ 9 and card(elem s) = len s and (forall i in set elems s . i ‚â§ 9)*)</span>
<span class="keyword1"><span class="command">type_synonym</span></span> MySeq <span class="main">=</span> <span class="quoted"><span class="quoted">"VDMNat1 list"</span></span>
<span class="keyword1"><span class="command">definition</span></span>
   <span class="entity">inv_MySeq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"MySeq <span class="main">‚áí</span> <span class="main">ùîπ</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="free">inv_MySeq</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">‚â°</span> <span class="main">(</span>inv_SeqElems inv_VDMNat1 <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">‚àß</span> 
                  len <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">‚â§</span> <span class="numeral">9</span> <span class="main">‚àß</span> int <span class="main">(</span>card <span class="main">(</span>elems <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> len <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">‚àß</span>
                  <span class="main">(</span><span class="main">‚àÄ</span> <span class="bound">i</span> <span class="main">‚àà</span> elems <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">.</span> <span class="bound">i</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">‚àß</span> <span class="bound">i</span> <span class="main">‚â§</span> <span class="numeral">9</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"inv_MySeq <span class="main">[</span><span class="main">1</span><span class="main">,</span> <span class="numeral">2</span><span class="main">,</span> <span class="numeral">3</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‚ÄπVDM PO layered expansion-proof strategy setup‚Ä∫</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‚ÄπI use various theorem tags to step-wise expand-simplify VDM goals‚Ä∫</span></span>

<span class="comment1">(*TODO: this needs loads of experimentation for fine tuning *)</span>

<span class="keyword1"><span class="command">named_theorems</span></span> 
  VDM_basic_defs      <span class="keyword2"><span class="keyword">and</span></span>

  VDM_num_defs        <span class="keyword2"><span class="keyword">and</span></span>
  VDM_num_fcns        <span class="keyword2"><span class="keyword">and</span></span>
  VDM_num_spec_pre    <span class="keyword2"><span class="keyword">and</span></span>
  VDM_num_spec_post   <span class="keyword2"><span class="keyword">and</span></span>
  VDM_num_spec        <span class="keyword2"><span class="keyword">and</span></span>
  VDM_num             <span class="keyword2"><span class="keyword">and</span></span>

  VDM_set_defs        <span class="keyword2"><span class="keyword">and</span></span>
  VDM_set_fcns        <span class="keyword2"><span class="keyword">and</span></span>
  VDM_set_spec_pre    <span class="keyword2"><span class="keyword">and</span></span>
  VDM_set_spec_post   <span class="keyword2"><span class="keyword">and</span></span>
  VDM_set_spec        <span class="keyword2"><span class="keyword">and</span></span>
  VDM_set             <span class="keyword2"><span class="keyword">and</span></span>

  VDM_seq_defs        <span class="keyword2"><span class="keyword">and</span></span>
  VDM_seq_fcns_1      <span class="keyword2"><span class="keyword">and</span></span>
  VDM_seq_fcns_2      <span class="keyword2"><span class="keyword">and</span></span>
  VDM_seq_fcns_3      <span class="keyword2"><span class="keyword">and</span></span>
  VDM_seq_fcns        <span class="keyword2"><span class="keyword">and</span></span>
  VDM_seq_spec_pre    <span class="keyword2"><span class="keyword">and</span></span>
  VDM_seq_spec_post_1 <span class="keyword2"><span class="keyword">and</span></span>
  VDM_seq_spec_post_2 <span class="keyword2"><span class="keyword">and</span></span>
  VDM_seq_spec_post_3 <span class="keyword2"><span class="keyword">and</span></span>
  VDM_seq_spec_post   <span class="keyword2"><span class="keyword">and</span></span>
  VDM_seq_spec        <span class="keyword2"><span class="keyword">and</span></span>
  VDM_seq             <span class="keyword2"><span class="keyword">and</span></span>

  VDM_map_defs        <span class="keyword2"><span class="keyword">and</span></span>

  VDM_map_fcns_simps  <span class="keyword2"><span class="keyword">and</span></span> 
  VDM_map_fcns_1_simps <span class="keyword2"><span class="keyword">and</span></span> 
  VDM_map_fcns_2_simps <span class="keyword2"><span class="keyword">and</span></span> 

  VDM_map_fcns        <span class="keyword2"><span class="keyword">and</span></span>
  VDM_map_fcns_1      <span class="keyword2"><span class="keyword">and</span></span>
  VDM_map_fcns_2      <span class="keyword2"><span class="keyword">and</span></span>
  VDM_map_fcns_3      <span class="keyword2"><span class="keyword">and</span></span>
  VDM_map_fcns_4      <span class="keyword2"><span class="keyword">and</span></span>

  VDM_map_comp        <span class="keyword2"><span class="keyword">and</span></span>
  VDM_map_comp_1      <span class="keyword2"><span class="keyword">and</span></span>
  VDM_map_comp_2      <span class="keyword2"><span class="keyword">and</span></span>
  VDM_map_comp_3      <span class="keyword2"><span class="keyword">and</span></span>

  VDM_map             <span class="keyword2"><span class="keyword">and</span></span>

  VDM_num_crc         <span class="keyword2"><span class="keyword">and</span></span>
  VDM_num_crc_1       <span class="keyword2"><span class="keyword">and</span></span>
  VDM_num_crc_2       <span class="keyword2"><span class="keyword">and</span></span>
  VDM_num_crc_3       <span class="keyword2"><span class="keyword">and</span></span>
                  
  VDM_stms_defs       <span class="keyword2"><span class="keyword">and</span></span> 
  VDM_stms            <span class="keyword2"><span class="keyword">and</span></span>

  VDM_spec            <span class="keyword2"><span class="keyword">and</span></span>
  VDM_all

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">VDM_basic_defs</span><span class="main">]</span>       <span class="main">=</span> inv_True_def inv_VDMChar_def <span class="comment1">(*inv_bool_def *)</span>
                                inv_VDMToken'_def inv_VDMToken_def 

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">VDM_num_defs</span><span class="main">]</span>         <span class="main">=</span> inv_VDMNat_def inv_VDMNat1_def inv_VDMInt_def
                                inv_VDMReal_def inv_VDMRat_def

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">VDM_num_fcns</span><span class="main">]</span>         <span class="main">=</span> vdm_narrow_real_def vdm_div_def vdm_mod_def
                                vdm_rem_def vdm_pow_def vdm_abs_def vdm_floor_def
                   
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">VDM_num_spec_pre</span><span class="main">]</span>     <span class="main">=</span> pre_vdm_mod_def pre_vdm_div_def 
                                pre_vdm_rem_def pre_vdm_pow_def
                              
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">VDM_num_spec_post</span><span class="main">]</span>    <span class="main">=</span> post_vdm_mod_def post_vdm_div_def 
                                post_vdm_rem_def post_vdm_pow_def
                                post_vdm_floor_def post_vdm_abs_def  


<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">VDM_set_defs</span><span class="main">]</span>         <span class="main">=</span> inv_VDMSet_def inv_VDMSet1_def inv_VDMSet'_def inv_VDMSet1'_def inv_SetElems_def 
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">VDM_set_fcns</span><span class="main">]</span>         <span class="main">=</span> vdm_card_def
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">VDM_set_spec_pre</span><span class="main">]</span>     <span class="main">=</span> pre_vdm_card_def 
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">VDM_set_spec_post</span><span class="main">]</span>    <span class="main">=</span> post_vdm_card_def

<span class="keyword1"><span class="command">thm</span></span> <span class="dynamic"><span class="dynamic">VDM_num_fcns</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">VDM_seq_defs</span><span class="main">]</span>         <span class="main">=</span> inv_VDMSeq'_def inv_VDMSeq1'_def inv_SeqElems_def
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">VDM_seq_fcns_1</span><span class="main">]</span>       <span class="main">=</span> len_def elems_def inds_def inds_as_nat_def 
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">VDM_seq_fcns_2</span><span class="main">]</span>       <span class="main">=</span> vdm_reverse_def vdmtake_def seq_prefix_def 
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">VDM_seq_fcns_3</span><span class="main">]</span>       <span class="main">=</span> applyVDMSeq_def applyVDMSubseq'_def applyVDMSubseq_def
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">VDM_seq_spec_pre</span><span class="main">]</span>     <span class="main">=</span> pre_hd_def pre_tl_def pre_applyVDMSeq_def pre_applyVDMSubseq_def
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">VDM_seq_spec_post_1</span><span class="main">]</span>  <span class="main">=</span> post_len_def post_elems_def post_inds_def post_hd_def post_tl_def   
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">VDM_seq_spec_post_2</span><span class="main">]</span>  <span class="main">=</span> post_vdm_reverse_def post_vdmtake_def post_seq_prefix_def post_append_def
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">VDM_seq_spec_post_3</span><span class="main">]</span>  <span class="main">=</span> post_applyVDMSeq_def post_applyVDMSubseq_def 

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">VDM_map_defs</span><span class="main">]</span>         <span class="main">=</span> inv_Option_def inv_Map1_def inv_Map_def inv_Inmap_def
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">VDM_map_fcns_1</span><span class="main">]</span>       <span class="main">=</span> rng_def dagger_def munion_def 
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">VDM_map_fcns_2</span><span class="main">]</span>       <span class="main">=</span> dom_restr_def dom_antirestr_def rng_restr_def rng_antirestr_def
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">VDM_map_fcns_3</span><span class="main">]</span>       <span class="main">=</span> vdm_merge_def vdm_inverse_def map_subset_def 
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">VDM_map_fcns_4</span><span class="main">]</span>       <span class="main">=</span> map_comp_def map_compatible_def
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">VDM_map_fcns_1_simps</span><span class="main">]</span> <span class="main">=</span> dagger_simps upd_simps munion_simps 
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">VDM_map_fcns_2_simps</span><span class="main">]</span> <span class="main">=</span> restr_simps antirestr_simps
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">VDM_map_comp_1</span><span class="main">]</span>       <span class="main">=</span> maplet_defs
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">VDM_map_comp_2</span><span class="main">]</span>       <span class="main">=</span> mapCompSetBound_defs 
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">VDM_map_comp_3</span><span class="main">]</span>       <span class="main">=</span> mapCompTypeBound_defs
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">VDM_num_crc_1</span><span class="main">]</span>        <span class="main">=</span> is_VDMRealWhole_def is_VDMRatWhole_def 
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">VDM_num_crc_2</span><span class="main">]</span>        <span class="main">=</span> vdmint_of_real_def vdmint_of_rat_def
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">VDM_num_crc_3</span><span class="main">]</span>        <span class="main">=</span> total_coercion_def vdmset_of_t_def vdmseq_of_t_def isTest_def isTest'_def
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">VDM_stms_defs</span><span class="main">]</span>        <span class="main">=</span> seqcomp_def seqcomps.simps seqcomps'_def

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">VDM_num_spec</span><span class="main">]</span>         <span class="main">=</span> <span class="dynamic"><span class="dynamic">VDM_num_spec_pre</span></span> <span class="dynamic"><span class="dynamic">VDM_num_spec_post</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">VDM_set_spec</span><span class="main">]</span>         <span class="main">=</span> <span class="dynamic"><span class="dynamic">VDM_set_spec_pre</span></span> <span class="dynamic"><span class="dynamic">VDM_set_spec_post</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">VDM_seq_spec_post</span><span class="main">]</span>    <span class="main">=</span> <span class="dynamic"><span class="dynamic">VDM_seq_spec_post_3</span></span> <span class="dynamic"><span class="dynamic">VDM_seq_spec_post_2</span></span> <span class="dynamic"><span class="dynamic">VDM_seq_spec_post_1</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">VDM_seq_spec</span><span class="main">]</span>         <span class="main">=</span> <span class="dynamic"><span class="dynamic">VDM_seq_spec_pre</span></span> <span class="dynamic"><span class="dynamic">VDM_seq_spec_post</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">VDM_seq_fcns</span><span class="main">]</span>         <span class="main">=</span> <span class="dynamic"><span class="dynamic">VDM_seq_fcns_3</span></span> <span class="dynamic"><span class="dynamic">VDM_seq_fcns_2</span></span> <span class="dynamic"><span class="dynamic">VDM_seq_fcns_1</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">VDM_map_fcns</span><span class="main">]</span>         <span class="main">=</span> <span class="dynamic"><span class="dynamic">VDM_map_fcns_4</span></span> <span class="dynamic"><span class="dynamic">VDM_map_fcns_3</span></span> <span class="dynamic"><span class="dynamic">VDM_map_fcns_2</span></span> <span class="dynamic"><span class="dynamic">VDM_map_fcns_1</span></span> 
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">VDM_map_fcns_simps</span><span class="main">]</span>   <span class="main">=</span> <span class="dynamic"><span class="dynamic">VDM_map_fcns_2_simps</span></span> <span class="dynamic"><span class="dynamic">VDM_map_fcns_1_simps</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">VDM_map_comp</span><span class="main">]</span>         <span class="main">=</span> <span class="dynamic"><span class="dynamic">VDM_map_comp_3</span></span> <span class="dynamic"><span class="dynamic">VDM_map_comp_2</span></span> <span class="dynamic"><span class="dynamic">VDM_map_comp_1</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">VDM_num_crc</span><span class="main">]</span>          <span class="main">=</span> <span class="dynamic"><span class="dynamic">VDM_num_crc_3</span></span> <span class="dynamic"><span class="dynamic">VDM_num_crc_2</span></span> <span class="dynamic"><span class="dynamic">VDM_num_crc_1</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">VDM_num</span><span class="main">]</span>  <span class="main">=</span> <span class="dynamic"><span class="dynamic">VDM_num_defs</span></span> <span class="dynamic"><span class="dynamic">VDM_num_fcns</span></span> <span class="dynamic"><span class="dynamic">VDM_num_crc</span></span> 
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">VDM_set</span><span class="main">]</span>  <span class="main">=</span> <span class="dynamic"><span class="dynamic">VDM_seq_defs</span></span> <span class="dynamic"><span class="dynamic">VDM_set_fcns</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">VDM_seq</span><span class="main">]</span>  <span class="main">=</span> <span class="dynamic"><span class="dynamic">VDM_seq_defs</span></span> <span class="dynamic"><span class="dynamic">VDM_seq_fcns</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">VDM_map</span><span class="main">]</span>  <span class="main">=</span> <span class="dynamic"><span class="dynamic">VDM_map_defs</span></span> <span class="dynamic"><span class="dynamic">VDM_map_fcns</span></span> <span class="dynamic"><span class="dynamic">VDM_map_comp</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">VDM_stms</span><span class="main">]</span> <span class="main">=</span> <span class="dynamic"><span class="dynamic">VDM_stms_defs</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">VDM_spec</span><span class="main">]</span> <span class="main">=</span> <span class="dynamic"><span class="dynamic">VDM_num_spec</span></span> <span class="dynamic"><span class="dynamic">VDM_set_spec</span></span> <span class="dynamic"><span class="dynamic">VDM_seq_spec</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">VDM_all</span><span class="main">]</span>  <span class="main">=</span> <span class="dynamic"><span class="dynamic">VDM_basic_defs</span></span> <span class="dynamic"><span class="dynamic">VDM_num</span></span> <span class="dynamic"><span class="dynamic">VDM_set</span></span> <span class="dynamic"><span class="dynamic">VDM_seq</span></span> <span class="dynamic"><span class="dynamic">VDM_map</span></span> <span class="dynamic"><span class="dynamic">VDM_stms</span></span>  

<span class="comment1">(*&lt;*)</span><span class="keyword2"><span class="keyword">end</span></span><span class="comment1">(*&gt;*)</span></pre>
</body>

</html>